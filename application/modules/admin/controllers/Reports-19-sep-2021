<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

class   Reports extends My_Controller
{
    private $_user_listing_headers = 'user_listing_headers';

    public function __construct()
    {
        parent::__construct();
        $this->load->helper('url');
        $this->load->helper('form');
        $this->load->model('User_model');
        $this->load->model('Admin_model');
        $this->load->model('Chip_model');
        $this->load->model('User_chip_model');
        $this->load->model('User_info_model');
        $this->load->model('Ledger_model');
        $this->load->model('Betting_model');
        $this->load->library('commonlibrary');
        $this->load->library('commonlib');
        $this->load->library('session');
        $this->load->library("Upload");
        $this->load->model('Report_model');
        $this->load->model('Masters_betting_settings_model');
        $this->load->model('Event_type_model');
        $this->load->model('Event_model');
        $this->load->model('Masters_betting_settings_model');



        $userdata = $_SESSION['my_userdata'];

        if (empty($userdata)) {
            redirect('/');
        }
    }


    public function accountinfo()
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];

        $dataArray['user_id']  = $_SESSION['my_userdata']['user_id'];
        // p($dataArray);
        $this->load->view('/account-info', $dataArray);
    }


    public function acStatement($fltrselct = null, $user_id = null)
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');
        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4',
            'blockUI'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];

        if (empty($fltrselct)) {
            $fltrselct = $this->input->post('fltrselct');
        }


        $reports = array();
        if (!$user_id) {
            $user_id = get_user_id();
        }

        $user = $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;

        if ($user_type == 'User') {
            $dataArray = array(
                'fltrselct' => $fltrselct,
                'user_id' => $user_id
            );
            $reports = $this->Ledger_model->get_ledger($dataArray);
        } else if ($user_type == 'Master') {
            $reports = array();
            $dataArray = array(
                'fltrselct' => $fltrselct,
                'user_id' => $user_id
            );

            $masterAllData = $this->Ledger_model->get_ledger($dataArray);

            if (!empty($masterAllData)) {
                $reports = array_merge($reports, $masterAllData);
            }
        } else if ($user_type == 'Super Master') {
            $reports = array();
            $dataArray = array(
                'fltrselct' => $fltrselct,
                'user_id' => $user_id
            );

            $masterAllData = $this->Ledger_model->get_ledger($dataArray);

            if (!empty($masterAllData)) {
                $reports = array_merge($reports, $masterAllData);
            }
        } else if ($user_type == 'Hyper Super Master') {
            $reports = array();
            $dataArray = array(
                'fltrselct' => $fltrselct,
                'user_id' => $user_id
            );

            $masterAllData = $this->Ledger_model->get_ledger($dataArray);

            if (!empty($masterAllData)) {
                $reports = array_merge($reports, $masterAllData);
            }
        } else if ($user_type == 'Admin') {
            $reports = array();
            $dataArray = array(
                'fltrselct' => $fltrselct,
                'user_id' => $user_id
            );

            $masterAllData = $this->Ledger_model->get_ledger($dataArray);

            if (!empty($masterAllData)) {
                $reports = array_merge($reports, $masterAllData);
            }
        } else if ($user_type == 'Super Admin') {
            $reports = array();
            $dataArray = array(
                'fltrselct' => $fltrselct,
                'user_id' => $user_id
            );

            $masterAllData = $this->Ledger_model->get_ledger($dataArray);

            if (!empty($masterAllData)) {
                $reports = array_merge($reports, $masterAllData);
            }
        }


        $dataArray['reports'] = $reports;
        $dataArray['fltrselct'] = $fltrselct;
        $dataArray['opening_balance'] = 0;

        $accountStmt = $this->load->viewPartial('/account-statement-list-html', $dataArray);
        $dataArray['accountStmt'] = $accountStmt;
        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;


        $this->load->view('/account-statement', $dataArray);
    }

    public function filterAcStatement()
    {

        $search = $this->input->post('searchTerm');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');
        $fltrselct = $this->input->post('fltrselct');
        $user_id =  $this->input->post('user_id');
        $user_type =  $this->input->post('user_type');


        $dataArray = array(
            'search' => $search,
            'fltrselct' => $fltrselct,
            'user_id' => $user_id
        );


        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d H:i:s', (strtotime("tomorrow", strtotime($tdate)) - 1));
            $dataArray['fromDate'] = date('Y-m-d H:i:s', strtotime($fdate));
        }


        if ($fltrselct == 3) {
            $dataArray = array(
                'search_p_l' => $search,
                'user_id' => $user_id
            );

            if (!empty($fdate) && !empty($tdate)) {
                $dataArray['toDate'] = date('Y-m-d H:i:s', (strtotime("tomorrow", strtotime($tdate)) - 1));
                $dataArray['fromDate'] = date('Y-m-d H:i:s', strtotime($fdate));
            }
            $dataArray['pstatus'] = 'Settled';
        }



        if ($user_type == 'User') {


            if ($fltrselct == 3) {
                $reportsData = $this->Betting_model->get_bettings($dataArray);

                $reports = array();
                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $marketId = $report['market_id'];
                        $betting_type = strtolower($report['betting_type']);
                        $market_id = str_replace('.', '_', $marketId);

                        if (isset($reports[$report['match_id']])) {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }

                            $p_l = 0;

                            if ($report['bet_result'] == 'Plus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Minus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        } else {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }


                            $p_l = 0;

                            if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        }
                    }
                }
            } else {
                $reports = $this->Ledger_model->get_ledger($dataArray);
            }
        } else if ($user_type == 'Master') {
            $reports = array();

            if ($fltrselct == 3) {
                $dataArray['pstatus'] = 'Settled';

                $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $marketId = $report['market_id'];
                        $betting_type = strtolower($report['betting_type']);


                        if (isset($reports[$report['match_id']])) {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }

                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        } else {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }


                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        }
                    }
                }
            } else {
                $reports = $this->Ledger_model->get_ledger($dataArray);
            }
        } else if ($user_type == 'Super Master') {
            $reports = array();

            if ($fltrselct == 3) {
                $dataArray['pstatus'] = 'Settled';

                $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $marketId = $report['market_id'];
                        $betting_type = strtolower($report['betting_type']);


                        if (isset($reports[$report['match_id']])) {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }

                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        } else {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }


                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        }
                    }
                }
            } else {
                $reports = $this->Ledger_model->get_ledger($dataArray);
            }
        } else if ($user_type == 'Hyper Super Master') {
            $reports = array();

            if ($fltrselct == 3) {

                $dataArray['pstatus'] = 'Settled';

                $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $marketId = $report['market_id'];
                        $betting_type = strtolower($report['betting_type']);


                        if (isset($reports[$report['match_id']])) {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }

                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        } else {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }


                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        }
                    }
                }
            } else {
                $reports = $this->Ledger_model->get_ledger($dataArray);
            }
        } else if ($user_type == 'Admin') {
            $reports = array();

            if ($fltrselct == 3) {
                $dataArray['pstatus'] = 'Settled';

                $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $marketId = $report['market_id'];
                        $betting_type = strtolower($report['betting_type']);


                        if (isset($reports[$report['match_id']])) {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }

                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        } else {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }


                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        }
                    }
                }
            } else {
                $reports = $this->Ledger_model->get_ledger($dataArray);
            }
        } else if ($user_type == 'Super Admin') {
            $reports = array();

            if ($fltrselct == 3) {
                $dataArray['pstatus'] = 'Settled';

                $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $marketId = $report['market_id'];
                        $betting_type = strtolower($report['betting_type']);


                        if (isset($reports[$report['match_id']])) {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }

                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        } else {
                            if ($betting_type == 'fancy') {
                                $market_name = 'Fancy';
                            } else {
                                $market_name = $report['market_name'];
                            }


                            $p_l = 0;

                            if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['loss'] * -1;
                            }


                            $reports[$report['match_id']] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'market_name' => $market_name,
                                'market_id' => $marketId,

                                'p_l' => $p_l,
                                'commission' => 0,
                                'created_at' => $report['created_at']
                            );
                        }
                    }
                }
            } else {
                $reports = $this->Ledger_model->get_ledger($dataArray);
            }
        }


        if (!empty($fdate) && !empty($tdate)) {

            $opening_balance = $this->Ledger_model->count_opening_balance_by_date(array(
                'user_id' => $user_id,
                'tdate' =>  date('Y-m-d H:i:s', strtotime($fdate))
            ));
        } else {
            $opening_balance = 0;
        }



        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_ASC, $reports);
        $dataArray['reports'] = $reports;

        $dataArray['opening_balance'] = $opening_balance;
        if ($fltrselct == 3) {
            $accountStmt  = $this->load->viewPartial('/profit-loss-list-html', $dataArray);
        } else {
            $accountStmt = $this->load->viewPartial('/account-statement-list-html', $dataArray);
        }

        echo json_encode($accountStmt);
    }

    public function bethistory($user_id = null)
    {

        if (empty($user_id)) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['pstatus'] = 'Settled';
        $dataArray['fromDate'] = date('Y-m-d H:i:s', strtotime("-1 days"));
        $dataArray['toDate'] = date('Y-m-d H:i:s');
        $user_type = get_user_type();
        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);

        if ($user_type == 'Operator') {
            $user_id = getSuperAdminID();
        }


        if ($user_type == 'User') {
            $dataArray['user_id']  = $user_id;
        }


        $dataArray['user_type'] = $user_type;

        // p($this->db->last_query());
        $event_types = $this->Event_type_model->get_all_event_types();
        $dataArray['event_types'] = $event_types;
        $dataArray['user_id'] = $user_id;
        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4',
            'blockUI'
        );
        if (!empty($user_id)) {
            $dataArray['onload_url'] = base_url() . 'admin/Reports/on_load_bethistory/' . $user_id;
        }
        $this->load->view('/bet-history', $dataArray);
    }

    public function on_load_bethistory($user_id = null)
    {

        if (empty($user_id)) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $pegination = $this->input->post('pegination');




        $dataArray['pstatus'] = 'Settled';
        $dataArray['fromDate'] = date('Y-m-d H:i:s', strtotime("-1 days"));
        $dataArray['toDate'] = date('Y-m-d H:i:s');
        $user_type = get_user_type();
        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);

        if ($user_type == 'Operator') {
            $user_id = getSuperAdminID();
        }


        $reportsData = array();

        if ($user_type == 'User') {
            $dataArray['user_id']  = $user_id;
        }

        $dataArray['pegination'] = $pegination;
        if ($user_type == 'User') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Master') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Master') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Hyper Super Master') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Admin') {
            $dataArray['user_id'] = $user_id;

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Admin') {
            $dataArray['user_id'] = $user_id;


            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Operator') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        }
        // usort($reportsData, 'date_compare');
        array_multisort(array_map('strtotime', array_column($reportsData, 'created_at')), SORT_DESC, $reportsData);

        $dataArray['bettings'] = $reportsData;
        $dataArray['user_type'] = $user_type;
        // $dataArray['betting'] = $this->load->viewPartial('/betting-history-html', $dataArray);
        // p($this->db->last_query());
        $event_types = $this->Event_type_model->get_all_event_types();
        $dataArray['event_types'] = $event_types;
        $dataArray['user_id'] = $user_id;
        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4',
            'blockUI'
        );
        $bethistory = $this->load->viewPartial('/betting-history-html', $dataArray);
        echo json_encode($bethistory);
    }
    public function filterbethistory()
    {
        if (isset($_POST['user_id'])) {
            $user_id = $this->input->post('user_id');
        } else {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }
        $dataArray['user_id']  = $user_id;
        $search = $this->input->post('searchterm');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');
        $sportid = $this->input->post('sportstype') == 5 ? 5 : $this->input->post('sportstype');
        $bstatus = $this->input->post('bstatus');
        $pstatus = $this->input->post('pstatus');

        $dataArray = array(
            'search' => $search,
            'sportid' => $sportid,
            'bstatus' => $bstatus,
            'pstatus' => $pstatus,
        );


        if (!empty($tdate) && !empty($fdate)) {
            $dataArray['fdate'] = date("Y-m-d H:i:s", strtotime($fdate));

            $tdate   =  date('Y-m-d H:i:s', (strtotime("tomorrow", strtotime($tdate)) - 1));
            $dataArray['tdate'] = $tdate;
        }

        $user_type = get_user_type();
        $user_id = get_user_id();

        if ($user_type == 'Operator') {
            $user_id = getSuperAdminID();
        }

        if ($user_type == 'User') {
            $dataArray['user_id']  = $user_id;
        }

        $reportsData = array();
        if ($user_type == 'User') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Master') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Master') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Hyper Super Master') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Admin') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Admin') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Operator') {
            $dataArray['user_id'] = $user_id;
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        }

        array_multisort(array_map('strtotime', array_column($reportsData, 'created_at')), SORT_DESC, $reportsData);
        $dataArray['bettings'] = $reportsData;
        $dataArray['user_type'] = $user_type;

        $bethistory = $this->load->viewPartial('/betting-history-html', $dataArray);
        echo json_encode($bethistory);
    }

    public function profitloss($sportid = null, $user_id = null)
    {

        $this->load->library('Datatable');
        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['user_id']  = $user_id;
        $dataArray['sportid']  = $sportid;
        if ($sportid != 0) {
            $dataArray['sportid']  = 5;
        }
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $search = '';
        $dataArray = array(
            'search_p_l' => $search,
            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }

        $dataArray['pstatus'] = 'Settled';


        $user_detail = $this->User_model->getUserById($user_id);
        $user_type = $user_detail->user_type;



        if ($user_type == 'Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );

                        $comm_pl = 0;
                        $sessional_commission = 2;

                        if ($betting_type == 'fancy') {
                            $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        }
                        $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }




                        $grand_total_mo_comm = 0;
                        $grand_total_bm_comm = 0;

                        $grand_total_fancy_comm = 0;


                        $getCommissionUsers = $this->Betting_model->get_betting_events_user(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommissionUsers)) {
                            foreach ($getCommissionUsers as $CommissionUser) {
                                $dataArray2 = array(
                                    'user_id' => $CommissionUser->client_user_id,
                                    'match_id' => $report['match_id']
                                );

                                //***************MATCH ODDS COMM */
                                $matchOddsbettings = $this->Betting_model->get_match_odds_bettings_by_event_id($dataArray2);

                                $total_mo_profit = 0;
                                $total_mo_loss = 0;
                                $total_mo_amt = 0;
                                $user_mo_comm = 0;
                                $master_mo_comm = 0;
                                if (!empty($matchOddsbettings)) {
                                    foreach ($matchOddsbettings as $matchOddsbetting) {
                                        $user_mo_comm = $matchOddsbetting['master_commission'];
                                        if ($matchOddsbetting['bet_result'] == 'Plus') {
                                            $total_mo_profit += $matchOddsbetting['profit'];
                                        } else if ($matchOddsbetting['bet_result'] == 'Minus') {
                                            $total_mo_loss += $matchOddsbetting['loss'];
                                        }
                                    }
                                }

                                $master_mo_comm = $CommissionUser->master_commission -  $user_mo_comm;

                                $total_mo_amt = $total_mo_profit - $total_mo_loss;

                                if ($total_mo_amt < 0) {

                                    $commission_amt = (abs($total_mo_amt) * $CommissionUser->master_commission) / 100;
                                }

                                $mo_commission_amt = (abs($total_mo_amt) * $master_mo_comm) / 100;

                                $grand_total_mo_comm += $mo_commission_amt;
                                //***************MATCH ODDS COMM */


                                //***************BOOKMAKER COMM */
                                $bookMakerbettings = $this->Betting_model->get_bookmaker_bettings_by_event_id($dataArray2);


                                $total_bm_profit = 0;
                                $total_bm_loss = 0;
                                $total_bm_amt = 0;
                                $user_bm_comm = 0;
                                $master_bm_comm = 0;
                                if (!empty($bookMakerbettings)) {
                                    foreach ($bookMakerbettings as $bookMakerbetting) {
                                        $user_bm_comm = $bookMakerbetting['master_commission'];
                                        if ($bookMakerbetting['bet_result'] == 'Plus') {
                                            $total_bm_profit += $bookMakerbetting['profit'];
                                        } else if ($bookMakerbetting['bet_result'] == 'Minus') {
                                            $total_bm_loss += $bookMakerbetting['loss'];
                                        }
                                    }
                                }

                                $master_bm_comm = $CommissionUser->master_commission -  $user_bm_comm;

                                $total_bm_amt = $total_bm_profit - $total_bm_loss;

                                if ($total_bm_amt < 0) {



                                    $bm_commission_amt = (abs($total_bm_amt) * $master_bm_comm) / 100;
                                }

                                $grand_total_bm_comm += $bm_commission_amt;
                                //***************BOOKMAKER COMM */

                                // p($bm_commission_amt);
                                //***************FANCY COMM */
                                $fancybettings = $this->Betting_model->get_fancy_bettings_by_event_id($dataArray2);

                                $total_fancy_profit = 0;
                                $total_fancy_loss = 0;
                                $total_fancy_amt = 0;
                                $user_fancy_comm = 0;
                                $master_fancy_comm = 0;
                                if (!empty($fancybettings)) {
                                    foreach ($fancybettings as $fancybetting) {

                                        $user_fancy_comm = $fancybetting['sessional_commission'];
                                        if ($fancybetting['bet_result'] == 'Plus') {
                                            $total_fancy_profit += $fancybetting['profit'];
                                        } else if ($fancybetting['bet_result'] == 'Minus') {
                                            $total_fancy_loss += $fancybetting['loss'];
                                        }
                                    }
                                }

                                $master_fancy_comm = $CommissionUser->sessional_commission -  $user_fancy_comm;

                                $total_fancy_amt = $total_fancy_profit - $total_fancy_loss;

                                if ($total_fancy_amt < 0) {



                                    $fancy_commission_amt = (abs($total_fancy_amt) * $master_fancy_comm) / 100;
                                }

                                $grand_total_fancy_comm += $fancy_commission_amt;
                                //***************FANCY COMM */


                            }
                        }

                        $p_l -= $grand_total_mo_comm;
                        $p_l -= $grand_total_bm_comm;
                        $p_l -= $grand_total_fancy_comm;



                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                        // P($grand_total_fancy_comm);



                        // // $comm_pl = 0;
                        // // $sessional_commission = 2;

                        // // if ($betting_type == 'fancy') {
                        // //     $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        // // }
                        // $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        // $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    }
                }
            }
        } else if ($user_type == 'Super Master' || $user_type == 'Hyper Super Master' || $user_type == 'Admin' || $user_type == 'Super Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );

                        $comm_pl = 0;
                        $sessional_commission = 2;

                        if ($betting_type == 'fancy') {
                            $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        }
                        $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }




                        $grand_total_mo_comm = 0;
                        $grand_total_bm_comm = 0;

                        $grand_total_fancy_comm = 0;


                        $getCommissionUsers = $this->Betting_model->get_betting_events_user(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommissionUsers)) {
                            foreach ($getCommissionUsers as $CommissionUser) {

                                $bet_user_type = '';

                                if ($user_type == 'Super Master') {
                                    $bet_user_type = 'Master';
                                } else if ($user_type == 'Hyper Super Master') {
                                    $bet_user_type = 'Super Master';
                                } else if ($user_type == 'Admin') {
                                    $bet_user_type = 'Hyper Super Master';
                                } else if ($user_type == 'Super Admin') {
                                    $bet_user_type = 'Admin';
                                }

                                $dataArray2 = array(
                                    'user_id' => $CommissionUser->client_user_id,
                                    'match_id' => $report['match_id'],
                                    'user_type' => $bet_user_type
                                );

                                //***************MATCH ODDS COMM */
                                $matchOddsbettings = $this->Betting_model->get_masters_wise_match_odds_bettings_by_event_id($dataArray2);


                                $total_mo_profit = 0;
                                $total_mo_loss = 0;
                                $total_mo_amt = 0;
                                $user_mo_comm = 0;
                                $master_mo_comm = 0;
                                if (!empty($matchOddsbettings)) {
                                    foreach ($matchOddsbettings as $matchOddsbetting) {
                                        $user_mo_comm = $matchOddsbetting['master_commission'];
                                        if ($matchOddsbetting['bet_result'] == 'Plus') {
                                            $total_mo_profit += $matchOddsbetting['profit'];
                                        } else if ($matchOddsbetting['bet_result'] == 'Minus') {
                                            $total_mo_loss += $matchOddsbetting['loss'];
                                        }
                                    }
                                }

                                $master_mo_comm = $CommissionUser->master_commission -  $user_mo_comm;

                                $total_mo_amt = $total_mo_profit - $total_mo_loss;

                                if ($total_mo_amt < 0) {

                                    $commission_amt = (abs($total_mo_amt) * $CommissionUser->master_commission) / 100;
                                }

                                $mo_commission_amt = (abs($total_mo_amt) * $master_mo_comm) / 100;

                                $grand_total_mo_comm += $mo_commission_amt;
                                //***************MATCH ODDS COMM */


                                //***************BOOKMAKER COMM */
                                $bookMakerbettings = $this->Betting_model->get_masters_wise_bookmaker_bettings_by_event_id($dataArray2);




                                $total_bm_profit = 0;
                                $total_bm_loss = 0;
                                $total_bm_amt = 0;
                                $user_bm_comm = 0;
                                $master_bm_comm = 0;
                                if (!empty($bookMakerbettings)) {
                                    foreach ($bookMakerbettings as $bookMakerbetting) {
                                        $user_bm_comm = $bookMakerbetting['master_commission'];
                                        if ($bookMakerbetting['bet_result'] == 'Plus') {
                                            $total_bm_profit += $bookMakerbetting['profit'];
                                        } else if ($bookMakerbetting['bet_result'] == 'Minus') {
                                            $total_bm_loss += $bookMakerbetting['loss'];
                                        }
                                    }
                                }

                                $master_bm_comm = $CommissionUser->master_commission -  $user_bm_comm;

                                $total_bm_amt = $total_bm_profit - $total_bm_loss;

                                if ($total_bm_amt < 0) {



                                    $bm_commission_amt = (abs($total_bm_amt) * $master_bm_comm) / 100;
                                }

                                $grand_total_bm_comm += $bm_commission_amt;
                                //***************BOOKMAKER COMM */

                                // p($bm_commission_amt);
                                //***************FANCY COMM */
                                $fancybettings = $this->Betting_model->get_fancy_bettings_by_event_id($dataArray2);

                                $total_fancy_profit = 0;
                                $total_fancy_loss = 0;
                                $total_fancy_amt = 0;
                                $user_fancy_comm = 0;
                                $master_fancy_comm = 0;
                                if (!empty($fancybettings)) {
                                    foreach ($fancybettings as $fancybetting) {

                                        $user_fancy_comm = $fancybetting['sessional_commission'];
                                        if ($fancybetting['bet_result'] == 'Plus') {
                                            $total_fancy_profit += $fancybetting['profit'];
                                        } else if ($fancybetting['bet_result'] == 'Minus') {
                                            $total_fancy_loss += $fancybetting['loss'];
                                        }
                                    }
                                }

                                $master_fancy_comm = $CommissionUser->sessional_commission -  $user_fancy_comm;

                                $total_fancy_amt = $total_fancy_profit - $total_fancy_loss;

                                if ($total_fancy_amt < 0) {



                                    $fancy_commission_amt = (abs($total_fancy_amt) * $master_fancy_comm) / 100;
                                }

                                $grand_total_fancy_comm += $fancy_commission_amt;
                                //***************FANCY COMM */


                            }
                        }

                        $p_l -= $grand_total_mo_comm;
                        $p_l -= $grand_total_bm_comm;
                        $p_l -= $grand_total_fancy_comm;



                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                        // P($grand_total_fancy_comm);



                        // // $comm_pl = 0;
                        // // $sessional_commission = 2;

                        // // if ($betting_type == 'fancy') {
                        // //     $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        // // }
                        // $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        // $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    }
                }
            }
        } else if ($user_type == 'Hyper Super Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else if ($user_type == 'Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else if ($user_type == 'Super Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);





            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {

                   
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }



                        $p_l =  $reports[$report['match_id']]['p_l'];


                        if ($report['betting_is_tie'] == 'No') {
                            if ($report['bet_result'] == 'Plus') {
                                $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                            } else if ($report['bet_result'] == 'Minus') {
                                $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                            }
                        }





                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['betting_is_tie'] == 'No') {
                            if ($report['bet_result'] == 'Plus') {
                                $p_l = $report['profit'];
                            } else if ($report['bet_result'] == 'Minus') {
                                $p_l = $report['loss'] * -1;
                            }
                        }

                        $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));


                        // p($getCommssion);


                        if (!empty($getCommssion)) {
                            $p_l += $getCommssion->total_commission;
                        }

                        // p($p_l);
                        // p($report);
                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        }


        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;
        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_DESC, $reports);
        $dataArray['reports'] = $reports;

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );


        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $dataArray['profit_loss']  = $this->load->viewPartial('/profit-loss-list-html', $dataArray);
        $this->load->view('/profit-loss', $dataArray);
    }

    public function gameclientbet($user_id = null)
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');
        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];

        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }

        $user = $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;
        $dataArray['user_id']  = $user_id;

        if ($user_type == 'Operator') {
            $user_id = getSuperAdminID();
        }
        $dataArray['pstatus'] = 'Open';



        if ($user_type == 'User') {
            $reportsData = $this->Betting_model->get_bettings($dataArray);
        } else if ($user_type == 'Master') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list(array('user_id' => $user->user_id));
        } else if ($user_type == 'Super Master') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list(array('user_id' => $user->user_id));
        } else if ($user_type == 'Hyper Super Master') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list(array('user_id' => $user->user_id));
        } else if ($user_type == 'Admin') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list(array('user_id' => $user->user_id));
        } else if ($user_type == 'Super Admin') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list(array('user_id' => $user->user_id));
        } else if ($user_type == 'Operator') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list(array('user_id' => $user->user_id));
        }

        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;
        // usort($reportsData, 'date_compare');
        array_multisort(array_map('strtotime', array_column($reportsData, 'created_at')), SORT_DESC, $reportsData);
        $event_types = $this->Event_type_model->get_all_event_types();
        $dataArray['event_types'] = $event_types;
        $dataArray['reports'] = $reportsData;
        $this->load->view('/live-bet-history', $dataArray);
    }


    public function filterProfiltLoss()
    {

        $search = $this->input->post('searchTerm');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');
        $sportid = $this->input->post('sportId');
        $user_id = $this->input->post('user_id');

        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }
        $user_detail = $this->User_model->getUserById($user_id);

        $dataArray = array(
            'search_p_l' => $search,
            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {

            $dataArray['fdate'] = date('Y-m-d', strtotime($fdate));
            $dataArray['tdate'] = date('Y-m-d H:i:s', (strtotime("tomorrow", strtotime($tdate)) - 1));
        }

        $user_type = $user_detail->user_type;


        if ($user_type == 'Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );

                        $comm_pl = 0;
                        $sessional_commission = 2;

                        if ($betting_type == 'fancy') {
                            $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        }
                        $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }




                        $grand_total_mo_comm = 0;
                        $grand_total_bm_comm = 0;

                        $grand_total_fancy_comm = 0;


                        $getCommissionUsers = $this->Betting_model->get_betting_events_user(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommissionUsers)) {
                            foreach ($getCommissionUsers as $CommissionUser) {
                                $dataArray2 = array(
                                    'user_id' => $CommissionUser->client_user_id,
                                    'match_id' => $report['match_id']
                                );

                                //***************MATCH ODDS COMM */
                                $matchOddsbettings = $this->Betting_model->get_match_odds_bettings_by_event_id($dataArray2);

                                $total_mo_profit = 0;
                                $total_mo_loss = 0;
                                $total_mo_amt = 0;
                                $user_mo_comm = 0;
                                $master_mo_comm = 0;
                                if (!empty($matchOddsbettings)) {
                                    foreach ($matchOddsbettings as $matchOddsbetting) {
                                        $user_mo_comm = $matchOddsbetting['master_commission'];
                                        if ($matchOddsbetting['bet_result'] == 'Plus') {
                                            $total_mo_profit += $matchOddsbetting['profit'];
                                        } else if ($matchOddsbetting['bet_result'] == 'Minus') {
                                            $total_mo_loss += $matchOddsbetting['loss'];
                                        }
                                    }
                                }

                                $master_mo_comm = $CommissionUser->master_commission -  $user_mo_comm;

                                $total_mo_amt = $total_mo_profit - $total_mo_loss;

                                if ($total_mo_amt < 0) {

                                    $commission_amt = (abs($total_mo_amt) * $CommissionUser->master_commission) / 100;
                                }

                                $mo_commission_amt = (abs($total_mo_amt) * $master_mo_comm) / 100;

                                $grand_total_mo_comm += $mo_commission_amt;
                                //***************MATCH ODDS COMM */


                                //***************BOOKMAKER COMM */
                                $bookMakerbettings = $this->Betting_model->get_bookmaker_bettings_by_event_id($dataArray2);


                                $total_bm_profit = 0;
                                $total_bm_loss = 0;
                                $total_bm_amt = 0;
                                $user_bm_comm = 0;
                                $master_bm_comm = 0;
                                if (!empty($bookMakerbettings)) {
                                    foreach ($bookMakerbettings as $bookMakerbetting) {
                                        $user_bm_comm = $bookMakerbetting['master_commission'];
                                        if ($bookMakerbetting['bet_result'] == 'Plus') {
                                            $total_bm_profit += $bookMakerbetting['profit'];
                                        } else if ($bookMakerbetting['bet_result'] == 'Minus') {
                                            $total_bm_loss += $bookMakerbetting['loss'];
                                        }
                                    }
                                }

                                $master_bm_comm = $CommissionUser->master_commission -  $user_bm_comm;

                                $total_bm_amt = $total_bm_profit - $total_bm_loss;

                                if ($total_bm_amt < 0) {



                                    $bm_commission_amt = (abs($total_bm_amt) * $master_bm_comm) / 100;
                                }

                                $grand_total_bm_comm += $bm_commission_amt;
                                //***************BOOKMAKER COMM */

                                // p($bm_commission_amt);
                                //***************FANCY COMM */
                                $fancybettings = $this->Betting_model->get_fancy_bettings_by_event_id($dataArray2);

                                $total_fancy_profit = 0;
                                $total_fancy_loss = 0;
                                $total_fancy_amt = 0;
                                $user_fancy_comm = 0;
                                $master_fancy_comm = 0;
                                if (!empty($fancybettings)) {
                                    foreach ($fancybettings as $fancybetting) {

                                        $user_fancy_comm = $fancybetting['sessional_commission'];
                                        if ($fancybetting['bet_result'] == 'Plus') {
                                            $total_fancy_profit += $fancybetting['profit'];
                                        } else if ($fancybetting['bet_result'] == 'Minus') {
                                            $total_fancy_loss += $fancybetting['loss'];
                                        }
                                    }
                                }

                                $master_fancy_comm = $CommissionUser->sessional_commission -  $user_fancy_comm;

                                $total_fancy_amt = $total_fancy_profit - $total_fancy_loss;

                                if ($total_fancy_amt < 0) {



                                    $fancy_commission_amt = (abs($total_fancy_amt) * $master_fancy_comm) / 100;
                                }

                                $grand_total_fancy_comm += $fancy_commission_amt;
                                //***************FANCY COMM */


                            }
                        }

                        $p_l -= $grand_total_mo_comm;
                        $p_l -= $grand_total_bm_comm;
                        $p_l -= $grand_total_fancy_comm;



                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                        // P($grand_total_fancy_comm);



                        // // $comm_pl = 0;
                        // // $sessional_commission = 2;

                        // // if ($betting_type == 'fancy') {
                        // //     $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        // // }
                        // $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        // $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    }
                }
            }
        } else if ($user_type == 'Super Master' || $user_type == 'Hyper Super Master' || $user_type == 'Admin' || $user_type == 'Super Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );

                        $comm_pl = 0;
                        $sessional_commission = 2;

                        if ($betting_type == 'fancy') {
                            $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        }
                        $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }




                        $grand_total_mo_comm = 0;
                        $grand_total_bm_comm = 0;

                        $grand_total_fancy_comm = 0;


                        $getCommissionUsers = $this->Betting_model->get_betting_events_user(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommissionUsers)) {
                            foreach ($getCommissionUsers as $CommissionUser) {

                                $bet_user_type = '';

                                if ($user_type == 'Super Master') {
                                    $bet_user_type = 'Master';
                                } else if ($user_type == 'Hyper Super Master') {
                                    $bet_user_type = 'Super Master';
                                } else if ($user_type == 'Admin') {
                                    $bet_user_type = 'Hyper Super Master';
                                } else if ($user_type == 'Super Admin') {
                                    $bet_user_type = 'Admin';
                                }

                                $dataArray2 = array(
                                    'user_id' => $CommissionUser->client_user_id,
                                    'match_id' => $report['match_id'],
                                    'user_type' => $bet_user_type
                                );

                                //***************MATCH ODDS COMM */
                                $matchOddsbettings = $this->Betting_model->get_masters_wise_match_odds_bettings_by_event_id($dataArray2);


                                $total_mo_profit = 0;
                                $total_mo_loss = 0;
                                $total_mo_amt = 0;
                                $user_mo_comm = 0;
                                $master_mo_comm = 0;
                                if (!empty($matchOddsbettings)) {
                                    foreach ($matchOddsbettings as $matchOddsbetting) {
                                        $user_mo_comm = $matchOddsbetting['master_commission'];
                                        if ($matchOddsbetting['bet_result'] == 'Plus') {
                                            $total_mo_profit += $matchOddsbetting['profit'];
                                        } else if ($matchOddsbetting['bet_result'] == 'Minus') {
                                            $total_mo_loss += $matchOddsbetting['loss'];
                                        }
                                    }
                                }

                                $master_mo_comm = $CommissionUser->master_commission -  $user_mo_comm;

                                $total_mo_amt = $total_mo_profit - $total_mo_loss;

                                if ($total_mo_amt < 0) {

                                    $commission_amt = (abs($total_mo_amt) * $CommissionUser->master_commission) / 100;
                                }

                                $mo_commission_amt = (abs($total_mo_amt) * $master_mo_comm) / 100;

                                $grand_total_mo_comm += $mo_commission_amt;
                                //***************MATCH ODDS COMM */


                                //***************BOOKMAKER COMM */
                                $bookMakerbettings = $this->Betting_model->get_masters_wise_bookmaker_bettings_by_event_id($dataArray2);




                                $total_bm_profit = 0;
                                $total_bm_loss = 0;
                                $total_bm_amt = 0;
                                $user_bm_comm = 0;
                                $master_bm_comm = 0;
                                if (!empty($bookMakerbettings)) {
                                    foreach ($bookMakerbettings as $bookMakerbetting) {
                                        $user_bm_comm = $bookMakerbetting['master_commission'];
                                        if ($bookMakerbetting['bet_result'] == 'Plus') {
                                            $total_bm_profit += $bookMakerbetting['profit'];
                                        } else if ($bookMakerbetting['bet_result'] == 'Minus') {
                                            $total_bm_loss += $bookMakerbetting['loss'];
                                        }
                                    }
                                }

                                $master_bm_comm = $CommissionUser->master_commission -  $user_bm_comm;

                                $total_bm_amt = $total_bm_profit - $total_bm_loss;

                                if ($total_bm_amt < 0) {



                                    $bm_commission_amt = (abs($total_bm_amt) * $master_bm_comm) / 100;
                                }

                                $grand_total_bm_comm += $bm_commission_amt;
                                //***************BOOKMAKER COMM */

                                // p($bm_commission_amt);
                                //***************FANCY COMM */
                                $fancybettings = $this->Betting_model->get_fancy_bettings_by_event_id($dataArray2);

                                $total_fancy_profit = 0;
                                $total_fancy_loss = 0;
                                $total_fancy_amt = 0;
                                $user_fancy_comm = 0;
                                $master_fancy_comm = 0;
                                if (!empty($fancybettings)) {
                                    foreach ($fancybettings as $fancybetting) {

                                        $user_fancy_comm = $fancybetting['sessional_commission'];
                                        if ($fancybetting['bet_result'] == 'Plus') {
                                            $total_fancy_profit += $fancybetting['profit'];
                                        } else if ($fancybetting['bet_result'] == 'Minus') {
                                            $total_fancy_loss += $fancybetting['loss'];
                                        }
                                    }
                                }

                                $master_fancy_comm = $CommissionUser->sessional_commission -  $user_fancy_comm;

                                $total_fancy_amt = $total_fancy_profit - $total_fancy_loss;

                                if ($total_fancy_amt < 0) {



                                    $fancy_commission_amt = (abs($total_fancy_amt) * $master_fancy_comm) / 100;
                                }

                                $grand_total_fancy_comm += $fancy_commission_amt;
                                //***************FANCY COMM */


                            }
                        }

                        $p_l -= $grand_total_mo_comm;
                        $p_l -= $grand_total_bm_comm;
                        $p_l -= $grand_total_fancy_comm;



                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                        // P($grand_total_fancy_comm);



                        // // $comm_pl = 0;
                        // // $sessional_commission = 2;

                        // // if ($betting_type == 'fancy') {
                        // //     $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        // // }
                        // $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        // $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    }
                }
            }
        } else if ($user_type == 'Hyper Super Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else if ($user_type == 'Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else if ($user_type == 'Super Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);




            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Minus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['loss'] * -1;
                        }

                        $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommssion)) {
                            $p_l += $getCommssion->total_commission;
                        }
                        // p($report);
                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        }

        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_DESC, $reports);
        $dataArray['reports'] = $reports;
        $profit_loss = $this->load->viewPartial('/profit-loss-list-html', $dataArray);

        echo json_encode($profit_loss);
    }


    public function fancyStack()
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];
        $user_id =  $_SESSION['my_userdata']['user_id'];
        $dataArray['sportid']  = 5;

        if (get_user_type() == 'Master') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);
            $partner_ship = $user->partnership;
            $users =  $this->User_model->getInnerUserById($user_id);

            if (!empty($users)) {
                foreach ($users as $user) {
                    $dataArray['user_id'] = $user->user_id;
                    $reports = $this->Report_model->get_fancy_stack($dataArray);

                    if (!empty($reports[0]['name'])) {
                        $reportsData = array_merge($reportsData, $reports);
                    }
                }
            }
        } else if (get_user_type() == 'Super Master') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);

            $masters =  $this->User_model->getInnerUserById($user_id);

            if (!empty($masters)) {
                foreach ($masters as  $master) {
                    $users =  $this->User_model->getInnerUserById($master->user_id);

                    if (!empty($users)) {
                        $total_stake = 0;
                        foreach ($users as $user) {
                            $dataArray['user_id'] = $user->user_id;
                            $reports = $this->Report_model->get_fancy_stack($dataArray);

                            if (!empty($reports)) {
                                if (!empty($reports[0]['total_stake'])) {
                                    $total_stake += $reports[0]['total_stake'];
                                }
                            }
                        }

                        if ($total_stake) {
                            $result[] = array('name' => $master->name, 'total_stake' => $total_stake);

                            $reportsData = array_merge($reportsData, $result);
                        }

                        // p($reports);
                    }
                }
            }
        } else if (get_user_type() == 'Hyper Super Master') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);


            $superMasters =  $this->User_model->getInnerUserById($user_id);

            if (!empty($superMasters)) {
                foreach ($superMasters as  $superMaster) {
                    $total_stake = 0;
                    $masters =  $this->User_model->getInnerUserById($superMaster->user_id);

                    if (!empty($masters)) {

                        foreach ($masters as  $master) {
                            $total_stake_master = 0;

                            $users =  $this->User_model->getInnerUserById($master->user_id);

                            if (!empty($users)) {
                                foreach ($users as $user) {
                                    $dataArray['user_id'] = $user->user_id;
                                    $reports = $this->Report_model->get_fancy_stack($dataArray);

                                    if (!empty($reports)) {
                                        if (!empty($reports[0]['total_stake'])) {
                                            $total_stake_master += $reports[0]['total_stake'];
                                        }
                                    }
                                }

                                $total_stake += $total_stake_master;



                                // p($reports);
                            }
                        }
                        if ($total_stake) {
                            $result[] = array('name' => $superMaster->name, 'total_stake' => $total_stake);
                            $reportsData = array_merge($reportsData, $result);
                        }
                    }
                }
            }
        } else if (get_user_type() == 'Admin') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);


            $HyperSuperMasterUsers =  $this->User_model->getInnerUserById($user_id);

            if (!empty($HyperSuperMasterUsers)) {
                foreach ($HyperSuperMasterUsers as  $HyperSuperMasterUser) {
                    $total_stake = 0;
                    $total_stake_super_master = 0;

                    $superMasters =  $this->User_model->getInnerUserById($HyperSuperMasterUser->user_id);

                    if (!empty($superMasters)) {
                        foreach ($superMasters as  $superMaster) {

                            $masters =  $this->User_model->getInnerUserById($superMaster->user_id);

                            if (!empty($masters)) {

                                foreach ($masters as  $master) {
                                    $total_stake_master = 0;

                                    $users =  $this->User_model->getInnerUserById($master->user_id);

                                    if (!empty($users)) {
                                        foreach ($users as $user) {
                                            $dataArray['user_id'] = $user->user_id;
                                            $reports = $this->Report_model->get_fancy_stack($dataArray);

                                            if (!empty($reports)) {
                                                if (!empty($reports[0]['total_stake'])) {
                                                    $total_stake_master += $reports[0]['total_stake'];
                                                }
                                            }
                                        }

                                        $total_stake_super_master += $total_stake_master;

                                        // p($reports);
                                    }
                                }
                            }
                        }
                    }
                    // p($total_stake_super_master);
                    $total_stake += $total_stake_super_master;

                    if ($total_stake) {
                        $result[] = array('name' => $HyperSuperMasterUser->name, 'total_stake' => $total_stake);
                        $reportsData = array_merge($reportsData, $result);
                    }
                }
            }
        } else if (get_user_type() == 'Super Admin') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);
            $adminUsers =  $this->User_model->getInnerUserById($user_id);

            if (!empty($adminUsers)) {
                foreach ($adminUsers as  $adminUser) {
                    $total_stake_super_master = 0;
                    $total_stake_hyper_super_master = 0;

                    $HyperSuperMasterUsers =  $this->User_model->getInnerUserById($adminUser->user_id);
                    $total_stake = 0;

                    if (!empty($HyperSuperMasterUsers)) {
                        foreach ($HyperSuperMasterUsers as  $HyperSuperMasterUser) {

                            $superMasters =  $this->User_model->getInnerUserById($HyperSuperMasterUser->user_id);

                            if (!empty($superMasters)) {
                                foreach ($superMasters as  $superMaster) {

                                    $masters =  $this->User_model->getInnerUserById($superMaster->user_id);

                                    if (!empty($masters)) {

                                        foreach ($masters as  $master) {
                                            $total_stake_master = 0;

                                            $users =  $this->User_model->getInnerUserById($master->user_id);

                                            if (!empty($users)) {
                                                foreach ($users as $user) {
                                                    $dataArray['user_id'] = $user->user_id;
                                                    $reports = $this->Report_model->get_fancy_stack($dataArray);
                                                    if (!empty($reports)) {
                                                        if (!empty($reports[0]['total_stake'])) {
                                                            $total_stake_master += $reports[0]['total_stake'];
                                                        }
                                                    }
                                                }


                                                $total_stake_super_master += $total_stake_master;

                                                // p($reports);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }


                    $total_stake += $total_stake_super_master;

                    if (!empty($total_stake)) {
                        $result[] = array('name' => $adminUser->name, 'total_stake' => $total_stake);
                        $reportsData = array_merge($reportsData, $result);
                    }
                }
            }
        }

        $dataArray['user_id']  = $user_id;

        //        p($reports);
        $dataArray['reports'] = $reportsData;
        //        p($reports);
        $dataArray['fancy']  = $this->load->viewPartial('/fancy-stack-html', $dataArray);
        $this->load->view('/fancy-stack', $dataArray);
    }

    public function filterFanctyStack()
    {


        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');


        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d H:i:s', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d H:i:s', strtotime($fdate));
        }



        if (get_user_type() == 'Master') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);
            $partner_ship = $user->partnership;
            $users =  $this->User_model->getInnerUserById($user_id);

            if (!empty($users)) {
                foreach ($users as $user) {
                    $dataArray['user_id'] = $user->user_id;
                    $reports = $this->Report_model->get_fancy_stack($dataArray);
                    if (!empty($reports[0]['name'])) {
                        $reportsData = array_merge($reportsData, $reports);
                    }
                }
            }
        } else if (get_user_type() == 'Super Master') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);

            $masters =  $this->User_model->getInnerUserById($user_id);

            if (!empty($masters)) {
                foreach ($masters as  $master) {
                    $users =  $this->User_model->getInnerUserById($master->user_id);

                    if (!empty($users)) {
                        $total_stake = 0;
                        foreach ($users as $user) {
                            $dataArray['user_id'] = $user->user_id;
                            $reports = $this->Report_model->get_fancy_stack($dataArray);

                            if (!empty($reports)) {
                                if (!empty($reports[0]['total_stake'])) {
                                    $total_stake += $reports[0]['total_stake'];
                                }
                            }
                        }

                        if ($total_stake) {
                            $result[] = array('name' => $master->name, 'total_stake' => $total_stake);

                            $reportsData = array_merge($reportsData, $result);
                        }
                    }
                }
            }
        } else if (get_user_type() == 'Hyper Super Master') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);


            $superMasters =  $this->User_model->getInnerUserById($user_id);

            if (!empty($superMasters)) {
                foreach ($superMasters as  $superMaster) {
                    $total_stake = 0;
                    $masters =  $this->User_model->getInnerUserById($superMaster->user_id);

                    if (!empty($masters)) {

                        foreach ($masters as  $master) {
                            $total_stake_master = 0;

                            $users =  $this->User_model->getInnerUserById($master->user_id);

                            if (!empty($users)) {
                                foreach ($users as $user) {
                                    $dataArray['user_id'] = $user->user_id;
                                    $reports = $this->Report_model->get_fancy_stack($dataArray);
                                    if (!empty($reports)) {
                                        if (!empty($reports[0]['total_stake'])) {
                                            $total_stake_master += $reports[0]['total_stake'];
                                        }
                                    }
                                }

                                $total_stake += $total_stake_master;

                                // p($reports);
                            }
                        }
                        if (!empty($total_stake)) {

                            $result[] = array('name' => $superMaster->name, 'total_stake' => $total_stake);
                            $reportsData = array_merge($reportsData, $result);
                        }
                    }
                }
            }
        } else if (get_user_type() == 'Admin') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);


            $HyperSuperMasterUsers =  $this->User_model->getInnerUserById($user_id);

            if (!empty($HyperSuperMasterUsers)) {
                foreach ($HyperSuperMasterUsers as  $HyperSuperMasterUser) {
                    $total_stake = 0;
                    $total_stake_super_master = 0;

                    $superMasters =  $this->User_model->getInnerUserById($HyperSuperMasterUser->user_id);

                    if (!empty($superMasters)) {
                        foreach ($superMasters as  $superMaster) {

                            $masters =  $this->User_model->getInnerUserById($superMaster->user_id);

                            if (!empty($masters)) {

                                foreach ($masters as  $master) {
                                    $total_stake_master = 0;

                                    $users =  $this->User_model->getInnerUserById($master->user_id);

                                    if (!empty($users)) {
                                        foreach ($users as $user) {
                                            $dataArray['user_id'] = $user->user_id;
                                            $reports = $this->Report_model->get_fancy_stack($dataArray);

                                            if (!empty($reports)) {
                                                if (!empty($reports[0]['total_stake'])) {
                                                    $total_stake_master += $reports[0]['total_stake'];
                                                }
                                            }
                                        }

                                        $total_stake_super_master += $total_stake_master;

                                        // p($reports);
                                    }
                                }
                            }
                        }
                    }
                    // p($total_stake_super_master);
                    $total_stake += $total_stake_super_master;

                    if ($total_stake) {
                        $result[] = array('name' => $HyperSuperMasterUser->name, 'total_stake' => $total_stake);
                        $reportsData = array_merge($reportsData, $result);
                    }
                }
            }
        } else if (get_user_type() == 'Super Admin') {
            $reportsData = array();
            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);
            $adminUsers =  $this->User_model->getInnerUserById($user_id);

            if (!empty($adminUsers)) {
                foreach ($adminUsers as  $adminUser) {
                    $total_stake_super_master = 0;
                    $total_stake_hyper_super_master = 0;

                    $HyperSuperMasterUsers =  $this->User_model->getInnerUserById($adminUser->user_id);
                    $total_stake = 0;

                    if (!empty($HyperSuperMasterUsers)) {
                        foreach ($HyperSuperMasterUsers as  $HyperSuperMasterUser) {

                            $superMasters =  $this->User_model->getInnerUserById($HyperSuperMasterUser->user_id);

                            if (!empty($superMasters)) {
                                foreach ($superMasters as  $superMaster) {

                                    $masters =  $this->User_model->getInnerUserById($superMaster->user_id);

                                    if (!empty($masters)) {

                                        foreach ($masters as  $master) {
                                            $total_stake_master = 0;

                                            $users =  $this->User_model->getInnerUserById($master->user_id);

                                            if (!empty($users)) {
                                                foreach ($users as $user) {
                                                    $dataArray['user_id'] = $user->user_id;
                                                    $reports = $this->Report_model->get_fancy_stack($dataArray);
                                                    if (!empty($reports)) {
                                                        if (!empty($reports[0]['total_stake'])) {
                                                            $total_stake_master += $reports[0]['total_stake'];
                                                        }
                                                    }
                                                }


                                                $total_stake_super_master += $total_stake_master;

                                                // p($reports);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }


                    $total_stake += $total_stake_super_master;

                    if (!empty($total_stake)) {
                        $result[] = array('name' => $adminUser->name, 'total_stake' => $total_stake);
                        $reportsData = array_merge($reportsData, $result);
                    }
                }
            }
        }


        $dataArray['user_id']  = $user_id;

        //        p($reports);
        // p($reportsData);
        $dataArray['reports'] = $reportsData;
        $fancy_stack =  $this->load->viewPartial('/fancy-stack-html', $dataArray);
        echo json_encode($fancy_stack);
    }

    public function client_pl()
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];
        $user_id =  $_SESSION['my_userdata']['user_id'];
        $dataArray['user_id']  = $user_id;
        $dataArray['sportid']  = 5;


        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');
        $reports = $this->Report_model->get_client_pl($dataArray);

        $dataArray['reports'] = $reports;
        //        p($reports);
        $dataArray['fancy']  = $this->load->viewPartial('/client-pl-list-html', $dataArray);
        $this->load->view('/client-pl', $dataArray);
    }

    public function filter_client_pl()
    {


        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');


        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }


        $reports = $this->Report_model->get_client_pl($dataArray);
        $dataArray['reports'] = $reports;

        $fancy_stack =  $this->load->viewPartial('/client-pl-list-html', $dataArray);
        echo json_encode($fancy_stack);
    }

    public function market_pl()
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];
        $user_id =  $_SESSION['my_userdata']['user_id'];
        $dataArray['user_id']  = $user_id;

        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');
        $reports = $this->Report_model->get_market_pl($dataArray);

        $dataArray['reports'] = $reports;
        //        p($reports);
        $dataArray['fancy']  = $this->load->viewPartial('/market-pl-list-html', $dataArray);
        $this->load->view('/market-pl', $dataArray);
    }

    public function filter_market_pl()
    {


        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');


        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }


        $reports = $this->Report_model->get_market_pl($dataArray);
        $dataArray['reports'] = $reports;

        $fancy_stack =  $this->load->viewPartial('/market-pl-list-html', $dataArray);
        echo json_encode($fancy_stack);
    }


    public function user_pl()
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];
        $user_id =  $_SESSION['my_userdata']['user_id'];
        $dataArray['user_id']  = $user_id;

        $dataArray['event_type']  = 4;
        $dataArray['orderby']  = 'ASC';
        $dataArray['row_no']  = 10;
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $reports = $this->Report_model->get_user_pl($dataArray);

        $dataArray['reports'] = $reports;
        //        p($reports);
        $dataArray['fancy']  = $this->load->viewPartial('/user-pl-list-html', $dataArray);
        $this->load->view('/user-pl', $dataArray);
    }

    public function filter_userpl()
    {

        $dataArray['event_type']  = $this->input->post('eventType');
        $dataArray['orderby']  = $this->input->post('orderBy');
        $dataArray['row_no']  = $this->input->post('rowNo');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');


        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }


        $reports = $this->Report_model->get_user_pl($dataArray);
        $dataArray['reports'] = $reports;

        $fancy_stack =  $this->load->viewPartial('/user-pl-list-html', $dataArray);
        echo json_encode($fancy_stack);
    }

    public function sports_pl()
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $master_id = $_SESSION['my_userdata']['user_id'];
        $user_id =  $_SESSION['my_userdata']['user_id'];
        $dataArray['user_id']  = $user_id;

        $dataArray['event_type']  = 4;
        $dataArray['orderby']  = 'ASC';
        $dataArray['row_no']  = 10;

        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');
        $reports = $this->Report_model->get_sports_pl($dataArray);

        $dataArray['reports'] = $reports;
        //        p($reports);
        $dataArray['fancy']  = $this->load->viewPartial('/sports-pl-list-html', $dataArray);
        $this->load->view('/sports-pl', $dataArray);
    }

    public function filter_sportspl()
    {

        $dataArray['event_type']  = $this->input->post('eventType');
        $dataArray['orderby']  = $this->input->post('orderBy');
        $dataArray['row_no']  = $this->input->post('rowNo');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');


        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }


        $reports = $this->Report_model->get_sports_pl($dataArray);

        $dataArray['reports'] = $reports;

        $fancy_stack =  $this->load->viewPartial('/sports-pl-list-html', $dataArray);
        echo json_encode($fancy_stack);
    }

    public function filterlivebethistory()
    {
        $master_id = $_SESSION['my_userdata']['user_id'];

        if (isset($_POST['user_id'])) {
            $user_id = $this->input->post('user_id');
        } else {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }
        $user = $this->User_model->getUserById($user_id);

        $user_type = $user->user_type;


        $searchType = $this->input->post('searchType');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');
        $searchType = $this->input->post('searchType');
        $betStatus = $this->input->post('betStatus');
        $roundid = $this->input->post('roundid');
        $userName = $this->input->post('userName');


        if ($betStatus == 'Settle') {
            $betStatus = 'Settled';
        }

        if (!empty($fdate)) {
            $fdate = date('Y-m-d H:i:s', strtotime($fdate));
        }

        if (!empty($tdate)) {
            $tdate   =  date('Y-m-d H:i:s', (strtotime("tomorrow", strtotime($tdate)) - 1));
        }

        //p($sportid);
        $dataArray = array(
            'searchType' => $searchType,
            'fdate' => $fdate,
            'tdate' => $tdate,
            'betStatus' => $betStatus,
            'roundid' => $roundid,
            'userName' => $userName
        );

        if ($user_type == 'User') {
            $dataArray['user_id']  = $user_id;
        }


        if ($user_type == 'User') {
            $reportsData = $this->Betting_model->get_bettings($dataArray);
        } else if ($user_type == 'Master') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Master') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Hyper Super Master') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Admin') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Admin') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Operator') {
            $reportsData = $this->Report_model->get_live_bet_history_bettings_list($dataArray);
        }


        // usort($reportsData, 'date_compare');
        array_multisort(array_map('strtotime', array_column($reportsData, 'created_at')), SORT_DESC, $reportsData);
        $dataArray['reports'] = $reportsData;

        $bethistory = $this->load->viewPartial('/live-betting-history-html', $dataArray);
        echo json_encode($bethistory);
    }



    public function chip_summary($user_id = null)
    {
        log_message("MY_INFO", 'OLD Chip Summary Load Start');
        $minusArr = array();
        $plusArr = array();

        if (!$user_id) {
            $user_id = get_user_id();
        }

        $user =  $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;
        $user_name = $user->name;

        if ($user_type === 'Master') {

            $partnership = $user->partnership;
            $master_id = $user->master_id;

            $master_commision = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;


            $users =  $this->User_model->getInnerUserById($user_id);

            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;



            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;


            // $parent_total_settle_amount = 0;
            // p($parent_total_settle_amount)
            // $$parent_total_settle_amount = 0;
            // p($parent_total_settle_amount);
            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );

            $totalAmt = 0;
            if (!empty($users)) {
                foreach ($users as $user) {



                    $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                    // p(sizeof($bettings),0);
                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user->user_id, 'role' => 'Parent'))->settlement_amount;


                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user->user_id, 'role' => 'Parent'))->settlement_amount;
                    // $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
                    $total_settle_amount = 0;


                    // if (!empty($bettings)) {
                    //     foreach ($bettings as $betting) {
                    //         if ($betting['bet_result'] == 'Plus') {
                    //             $totalAmt += $betting['profit'];
                    //         } else if ($betting['bet_result'] == 'Minus') {
                    //             $totalAmt -= $betting['loss'];
                    //         }
                    //     }
                    // }




                    $minus_acc_bettings = array();
                    if (!empty($bettings)) {
                        $bettingArr = array(
                            'user_id' => $user->user_id,
                            'user_name' => $user->user_name,
                            'name' => $user->name,
                            'amount' => 0,
                            'master_comission' => 0,
                            'partnership' => 0,
                            'type' => 'User',

                            'parent_comission' => 0,
                        );


                        // p($bettings);

                        foreach ($bettings as $betting) {
                            if ($betting['bet_result'] == 'Minus') {
                                $bettingArr['amount'] -= $betting['loss'];

                                $parnet_loss = $betting['loss'] - (($betting['loss']) * ($partnership / 100));

                                $parentBettingArr["amount"] -= $parnet_loss;
                            } else if ($betting['bet_result'] == 'Plus') {
                                $master_comission = 0;
                                $parent_comission = 0;
                                $profit_amt = $betting['profit'] - $master_comission;
                                $bettingArr['amount'] += $profit_amt;

                                $parnet_loss = $profit_amt - (($profit_amt) * ($partnership / 100));
                                $parentBettingArr["amount"] += $parnet_loss;



                                $bettingArr['master_comission'] += $master_comission;
                                $bettingArr['parent_comission'] += $parent_comission;
                            }
                            $bettingArr['partnership']  =  $partnership;
                        }






                        if ($bettingArr['amount'] < 0) {

                            $bettingArr['amount'] +=   $total_settle_amount;
                        } else {
                            $bettingArr['amount'] -=  $total_settle_amount;
                        }


                        if ($bettingArr['amount'] < 0) {
                            array_push($minusArr, $bettingArr);
                        } else {
                            array_push($plusArr, $bettingArr);
                        }
                    }
                }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   ($parent_total_settle_amount);
                } else {
                    $parentBettingArr['amount'] -=    ($parent_total_settle_amount);
                }

                $parentBettingArr['amount'] = round($parentBettingArr['amount']);


                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }
        } else if ($user_type === 'Super Master') {
            $partnership = $user->partnership;
            $master_id = $user->master_id;


            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;


            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;


            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;

            // p($parent_total_settle_amount);

            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );

            // p($parentBettingArr);

            $masters =  $this->User_model->getInnerUserById($user_id);




            if (!empty($masters)) {
                foreach ($masters as $master) {
                    $chid_partnership_pr = $master->partnership;
                    // $child_commission_pr = $master->master_commision;
                    $child_commission_pr = 0;


                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $master->user_id, 'role' => 'Parent'))->settlement_amount;


                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $master->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;


                    $users =  $this->User_model->getInnerUserById($master->user_id);
                    $bettingArr = array(
                        'user_id' => $master->user_id,
                        'user_name' => $master->user_name,
                        'name' => $master->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );



                    if (!empty($users)) {
                        foreach ($users as $user) {

                            $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                            if (!empty($bettings)) {

                                foreach ($bettings as $betting) {
                                    if ($betting['bet_result'] == 'Minus') {
                                        $child_loss = ($betting['loss']) * ($chid_partnership_pr / 100);


                                        $profit_amt = $betting['loss']  - $child_loss;

                                        // p($profit_amt);
                                        $bettingArr['amount'] -= $profit_amt;


                                        $parent_loss =  $betting['loss'] - ($betting['loss'] * ($partnership / 100));


                                        $parentBettingArr["amount"] -= $parent_loss;
                                    } else if ($betting['bet_result'] == 'Plus') {

                                        $child_comission  =  0;
                                        $superior_comission  =  0;
                                        $parent_comission  =  0;


                                        $child_profit = ($betting['profit'] - $child_comission) * ($chid_partnership_pr / 100);



                                        $profit_amt = $betting['profit'] - $child_comission - $child_profit;



                                        $bettingArr['amount'] += $profit_amt;

                                        $parent_profit =  $betting['profit'] - ($betting['profit'] * ($partnership / 100));
                                        $parentBettingArr["amount"] += $parent_profit;

                                        $bettingArr['master_comission'] += $superior_comission;
                                        $bettingArr['parent_comission'] += $parent_comission;
                                    }

                                    $bettingArr['partnership']  =  $partnership;
                                }
                            }
                        }
                    }


                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] +=   abs($total_settle_amount);
                    } else {
                        $bettingArr['amount'] -=  abs($total_settle_amount);
                    }

                    $bettingArr['amount'] = round($bettingArr['amount']);
                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   $parent_total_settle_amount;
                } else {
                    $parentBettingArr['amount'] -=  $parent_total_settle_amount;
                }


                $parentBettingArr['amount'] = round($parentBettingArr['amount']);
                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }

            // p($plusArr);
            // exit;
        } else if ($user_type === 'Hyper Super Master') {

            $hyper_super_master_partnership = $user->partnership;
            $master_id = $user->master_id;

            $hyper_super_master_comission_pr = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;


            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;


            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;

            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );


            $super_masters =  $this->User_model->getInnerUserById($user_id);


            if (!empty($super_masters)) {
                foreach ($super_masters as $super_master) {


                    $smaster_partnership_pr = $super_master->partnership;
                    $super_master_commission_pr = $super_master->master_commision;


                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $super_master->user_id, 'role' => 'Parent'))->settlement_amount;

                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $super_master->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;

                    //                    $total_settle_amount = 0;
                    // p($total_settle_amount);
                    $bettingArr = array(
                        'user_id' => $super_master->user_id,
                        'user_name' => $super_master->user_name,
                        'name' => $super_master->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );


                    $masters =  $this->User_model->getInnerUserById($super_master->user_id);

                    if (!empty($masters)) {
                        foreach ($masters as $master) {
                            $master_commission_pr = $master->master_commision;
                            $master_partnership_pr = $master->partnership;


                            $users =  $this->User_model->getInnerUserById($master->user_id);
                            if (!empty($users)) {
                                foreach ($users as $user) {

                                    $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                                    foreach ($bettings as $betting) {
                                        if ($betting['bet_result'] == 'Minus') {


                                            $master_loss = ($betting['loss']) * ($master_partnership_pr / 100);


                                            $profit_amt = $betting['loss'] - $master_loss;


                                            $smaster_loss = ($betting['loss']) * ($smaster_partnership_pr / 100);
                                            $profit_amt = $betting['loss'] - $smaster_loss;



                                            $bettingArr['amount'] -= $profit_amt;

                                            $parent_loss = $betting['loss'] - ($betting['loss'] * ($hyper_super_master_partnership / 100));


                                            $parentBettingArr["amount"] -= $parent_loss;
                                        } else if ($betting['bet_result'] == 'Plus') {

                                            $master_profit = ($betting['profit']) * ($master_partnership_pr / 100);

                                            $profit_amt = $betting['profit'];

                                            $smaster_profit = ($profit_amt) * ($smaster_partnership_pr / 100);



                                            $profit_amt =  $betting['profit'] - $smaster_profit;

                                            $bettingArr['amount'] += $profit_amt;
                                            $parent_loss = $betting['profit'] - ($betting['profit'] * ($hyper_super_master_partnership / 100));
                                            $parentBettingArr["amount"] += $parent_loss;

                                            $bettingArr['master_comission'] += 0;
                                            $bettingArr['parent_comission'] += 0;
                                        }
                                        $bettingArr['partnership']  =  $hyper_super_master_partnership;
                                    }
                                }
                            }
                        }
                    }


                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] +=   abs($total_settle_amount);
                    } else {
                        $bettingArr['amount'] -=  abs($total_settle_amount);
                    }

                    $bettingArr['amount'] =   round($bettingArr['amount']);

                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   $parent_total_settle_amount;
                } else {
                    $parentBettingArr['amount'] -=  $parent_total_settle_amount;
                }

                $parentBettingArr['amount'] =   round($parentBettingArr['amount']);


                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }
            // exit;
        } else if ($user_type === 'Admin') {

            $admin_partnership = $user->partnership;
            $master_id = $user->master_id;

            $hyper_super_master_comission_pr = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;



            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;


            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );

            $hyper_super_master_users =  $this->User_model->getInnerUserById($user_id);


            if (!empty($hyper_super_master_users)) {
                foreach ($hyper_super_master_users as $hyper_super_master_user) {




                    $chid_partnership_pr = $hyper_super_master_user->partnership;
                    $hmaster_partnership_pr = $hyper_super_master_user->partnership;


                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $hyper_super_master_user->user_id, 'role' => 'Parent'))->settlement_amount;



                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $hyper_super_master_user->user_id, 'role' => 'Parent'))->settlement_amount;


                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;

                    $bettingArr = array(
                        'user_id' => $hyper_super_master_user->user_id,
                        'user_name' => $hyper_super_master_user->user_name,
                        'name' => $hyper_super_master_user->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );

                    // p($bettingArr);



                    $super_masters =  $this->User_model->getInnerUserById($hyper_super_master_user->user_id);

                    if (!empty($super_masters)) {
                        foreach ($super_masters as $super_master) {
                            $smaster_partnership_pr = $super_master->partnership;



                            $masters =  $this->User_model->getInnerUserById($super_master->user_id);

                            if (!empty($masters)) {
                                foreach ($masters as $master) {

                                    $master_partnership_pr = $master->partnership;
                                    $users =  $this->User_model->getInnerUserById($master->user_id);
                                    if (!empty($users)) {
                                        foreach ($users as $user) {

                                            $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                                            if (!empty($bettings)) {

                                                foreach ($bettings as $betting) {
                                                    if ($betting['bet_result'] == 'Minus') {
                                                        $master_loss = ($betting['loss']) * ($master_partnership_pr / 100);



                                                        $profit_amt = $betting['loss'] - $master_loss;




                                                        $hmaster_loss = ($betting['loss']) * ($hmaster_partnership_pr / 100);


                                                        $profit_amt = $betting['loss'] - $hmaster_loss;


                                                        $bettingArr['amount'] -= $profit_amt;


                                                        $parent_loss = $betting['loss'] - ($betting['loss'] * ($admin_partnership / 100));
                                                        $parentBettingArr["amount"] -= $parent_loss;
                                                    } else if ($betting['bet_result'] == 'Plus') {

                                                        $master_profit = ($betting['profit']) * ($master_partnership_pr / 100);

                                                        $profit_amt = $betting['profit'] - $master_profit;

                                                        $smaster_profit = ($profit_amt) * ($smaster_partnership_pr / 100);
                                                        $profit_amt = $profit_amt - $smaster_profit;

                                                        $hmaster_profit = ($betting['profit']) * ($hmaster_partnership_pr / 100);
                                                        $profit_amt = $betting['profit'] - $hmaster_profit;

                                                        $bettingArr['amount'] += $profit_amt;

                                                        $parent_loss =  $betting['profit'] - ($betting['profit'] * ($admin_partnership / 100));
                                                        $parentBettingArr["amount"] += $parent_loss;

                                                        $bettingArr['master_comission'] += 0;
                                                        $bettingArr['parent_comission'] += 0;
                                                    }
                                                    $bettingArr['partnership']  =  $admin_partnership;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }


                    // if ($bettingArr['amount'] < 0) {
                    //     $bettingArr['amount'] =  number_format($bettingArr['amount'], 2) + number_format($total_settle_amount, 2);
                    // } else {
                    //     $bettingArr['amount'] =  number_format($bettingArr['amount'], 2) - number_format($total_settle_amount, 2);
                    // }
                    // $bettingArr['amount'] =   round($bettingArr['amount']);

                    // if ($bettingArr['amount'] < 0) {
                    //     array_push($minusArr, $bettingArr);
                    // }  else {
                    //     array_push($plusArr, $bettingArr);
                    // }
                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] +=   abs($total_settle_amount);
                    } else {
                        $bettingArr['amount'] -=  abs($total_settle_amount);
                    }

                    $bettingArr['amount'] =   round($bettingArr['amount']);

                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }

                // if ($parentBettingArr['amount'] < 0) {

                //     $parentBettingArr['amount'] = round($parentBettingArr['amount']) +   $parent_total_settle_amount;
                // } else {
                //     $parentBettingArr['amount'] =   round($parentBettingArr['amount']) - $parent_total_settle_amount;
                // }

                // $parentBettingArr['amount'] =   round($parentBettingArr['amount']);

                // if ($parentBettingArr['amount'] > 0) {
                //     array_push($minusArr, $parentBettingArr);
                // } else if ($parentBettingArr['amount'] < 0) {
                //     array_push($plusArr, $parentBettingArr);
                // }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   $parent_total_settle_amount;
                } else {
                    $parentBettingArr['amount'] -=  $parent_total_settle_amount;
                }

                $parentBettingArr['amount'] =   round($parentBettingArr['amount']);


                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }
        } else if (get_user_type() === 'Super Admin') {

            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);
            $hyper_super_master_partnership = $user->partnership;
            $master_id = $user->master_id;

            $hyper_super_master_comission_pr = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = 0;
            $parent_name = '';



            $admin_users =  $this->User_model->getInnerUserById($user_id);


            if (!empty($admin_users)) {
                foreach ($admin_users as $admin_user) {
                    // if ($admin_user->user_id != 6320)
                    // continue;
                    $chid_partnership_pr = $admin_user->partnership;
                    $super_master_commission_pr = $admin_user->master_commision;
                    $admin_partnership_pr =  $admin_user->partnership;

                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $admin_user->user_id, 'role' => 'Parent'))->settlement_amount;

                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $admin_user->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
                    $bettingArr = array(
                        'user_id' => $admin_user->user_id,
                        'user_name' => $admin_user->user_name,
                        'name' => $admin_user->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',

                        'parent_comission' => 0,
                    );


                    $hyper_super_master_users =  $this->User_model->getInnerUserById($admin_user->user_id);

                    if (!empty($hyper_super_master_users)) {
                        foreach ($hyper_super_master_users as $hyper_super_master_user) {
                            $hmaster_partnership_pr =  $hyper_super_master_user->partnership;



                            $super_masters =  $this->User_model->getInnerUserById($hyper_super_master_user->user_id);

                            if (!empty($super_masters)) {
                                foreach ($super_masters as $super_master) {

                                    $smaster_partnership_pr =  $super_master->partnership;



                                    $masters =  $this->User_model->getInnerUserById($super_master->user_id);

                                    if (!empty($masters)) {
                                        foreach ($masters as $master) {
                                            $master_commission_pr = $master->master_commision;
                                            $master_partnership_pr =  $master->partnership;
                                            $users =  $this->User_model->getInnerUserById($master->user_id);
                                            if (!empty($users)) {
                                                foreach ($users as $user) {

                                                    $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);


                                                    if (!empty($bettings)) {

                                                        foreach ($bettings as $betting) {
                                                            if ($betting['bet_result'] == 'Minus') {
                                                                $master_loss = ($betting['loss']) * ($master_partnership_pr / 100);




                                                                $profit_amt = $betting['loss'] - $master_loss;
                                                                $smaster_loss = ($profit_amt) * ($smaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $smaster_loss;


                                                                $hmaster_loss = ($profit_amt) * ($hmaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $hmaster_loss;


                                                                $admin_loss = ($betting['loss']) * ($admin_partnership_pr / 100);
                                                                $profit_amt = $betting['loss'] - $admin_loss;



                                                                $bettingArr['amount'] -= $profit_amt;
                                                            } else if ($betting['bet_result'] == 'Plus') {

                                                                $master_profit = ($betting['profit']) * ($master_partnership_pr / 100);

                                                                $profit_amt = $betting['profit'] - $master_profit;

                                                                $smaster_profit = ($profit_amt) * ($smaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $smaster_profit;
                                                                //  p($profit_amt);

                                                                $hmaster_profit = ($profit_amt) * ($hmaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $hmaster_profit;

                                                                $admin_profit = ($betting['profit']) * ($admin_partnership_pr / 100);
                                                                $profit_amt = $betting['profit'] - $admin_profit;



                                                                $bettingArr['amount'] += $profit_amt;
                                                                $bettingArr['master_comission'] += 0;
                                                                $bettingArr['parent_comission'] += 0;
                                                            }
                                                            $bettingArr['partnership']  =  $hyper_super_master_partnership;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }


                    // p($bettingArr['amount'])
                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] =  $bettingArr['amount'] + $total_settle_amount;
                    } else {
                        $bettingArr['amount'] =  $bettingArr['amount'] - $total_settle_amount;
                    }


                    $bettingArr['amount'] = round($bettingArr['amount']);
                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }
            }
        }


        $dataArray['minus_acc'] = $minusArr;
        $dataArray['plus_acc'] = $plusArr;
        $dataArray['parent_name'] = $parent_name;
        $dataArray['user_type'] = $user_type;
        $dataArray['user_id'] = $user_id;
        $dataArray['user_name'] = $user_name;


        log_message("MY_INFO", 'OLD Chip Summary Load END');
        $this->load->view('chip-summary', $dataArray);
    }




    public function addsettlement()
    {

        $chips = $this->input->post('chips');
        $narration = $this->input->post('narration');
        $userId = $this->input->post('userId');
        $MaxAmt = $this->input->post('MaxAmt');
        $CrDr = $this->input->post('CrDr');

        $user_detail = $this->User_model->getUserById($userId);

        $masterId =  $user_detail->master_id;

        $master_detail = $this->User_model->getUserById($masterId);



        $user_chip = count_total_balance($userId);
        $master_chip = count_total_balance($masterId);

        $user_naration = '';
        $master_naration = '';

        if ($CrDr == 'Plus') {
            $user_new_chip = $user_chip - $chips;
            $master_new_chip = $master_chip + $chips;
            $user_naration = 'Cash Received By Parent';
            $master_naration = 'Cash Paid to ' . $user_detail->user_name;

            if ($user_chip < $chips) {
                echo json_encode(array('success' => false, 'message' => 'Insufficient balance!!'));
                exit;
            }
        } else {

            if ($master_chip < $chips) {
                echo json_encode(array('success' => false, 'message' => 'Insufficient balance!!'));
                exit;
            }
            $user_new_chip = $user_chip + $chips;
            $master_new_chip = $master_chip - $chips;
            $master_naration = 'Cash Received By ' . $user_detail->user_name;
            $user_naration = 'Cash Paid to Parent';
        }

        $dataArray = array(
            'user_id' => $userId,
            'remarks' => $user_naration,
            'transaction_type' => $CrDr == 'Plus' ? 'debit' : 'credit',
            'amount' => $chips,
            'balance' =>  $user_new_chip,
            'type' =>  'Settlement',
            'role' => 'Parent'

        );

        $ledger_id  = $this->Ledger_model->addLedger($dataArray);


        $dataArray = array(
            'user_id' => $masterId,
            'remarks' => $master_naration,
            'transaction_type' => $CrDr == 'Plus' ? 'credit' : 'debit',
            'amount' => $chips,
            'balance' =>  $master_new_chip,
            'type' =>  'Settlement'

        );

        $ledger_id  = $this->Ledger_model->addLedger($dataArray);

        if ($CrDr == 'Plus') {
            $user_details = $this->User_model->getUserById($userId);
            if (!empty($user_details)) {
                $balance = $user_details->balance  - $chips;
                $data = array(
                    'user_id' => $userId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }



            $master_details = $this->User_model->getUserById($masterId);
            if (!empty($master_details)) {
                $balance = $master_details->balance  + $chips;
                $data = array(
                    'user_id' => $masterId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }
        } else {

            $user_details = $this->User_model->getUserById($userId);
            if (!empty($user_details)) {
                $balance = $user_details->balance  + $chips;
                $data = array(
                    'user_id' => $userId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }



            $master_details = $this->User_model->getUserById($masterId);
            if (!empty($master_details)) {
                $balance = $master_details->balance  - $chips;
                $data = array(
                    'user_id' => $masterId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }
        }


        if ($ledger_id) {
            echo json_encode(array('success' => true));
        } else {
            echo json_encode(array('success' => false));
        }
    }

    public function filterChipSummary()
    {

        $searchTerm = $this->input->post('searchTerm');
        $user_id = $this->input->post('user_id');
        $user_type = $this->input->post('user_type');


        $minusArr = array();
        $plusArr = array();

        $minusArr = array();
        $plusArr = array();

        if (!$user_id) {
            $user_id = get_user_id();
        }

        $user =  $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;
        $user_name = $user->user_name;

        if ($user_type === 'Master') {

            $partnership = $user->partnership;
            $master_id = $user->master_id;

            $master_commision = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;


            $users =  $this->User_model->getInnerUserById($user_id, $searchTerm);

            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;



            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );

            $totalAmt = 0;
            if (!empty($users)) {
                foreach ($users as $user) {


                    $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user->user_id, 'role' => 'Parent'))->settlement_amount;


                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user->user_id, 'role' => 'Parent'))->settlement_amount;
                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;



                    if (!empty($bettings)) {
                        foreach ($bettings as $betting) {
                            if ($betting['bet_result'] == 'Plus') {
                                $totalAmt += $betting['profit'];
                            } else if ($betting['bet_result'] == 'Minus') {
                                $totalAmt -= $betting['loss'];
                            }
                        }
                    }




                    $minus_acc_bettings = array();
                    if (!empty($bettings)) {
                        $bettingArr = array(
                            'user_id' => $user->user_id,
                            'user_name' => $user->user_name,
                            'name' => $user->name,
                            'amount' => 0,
                            'master_comission' => 0,
                            'partnership' => 0,
                            'type' => 'User',

                            'parent_comission' => 0,
                        );


                        foreach ($bettings as $betting) {
                            if ($betting['bet_result'] == 'Minus') {
                                $bettingArr['amount'] -= $betting['loss'];

                                $parnet_loss = $betting['loss'] - (($betting['loss']) * ($partnership / 100));

                                $parentBettingArr["amount"] -= $parnet_loss;
                            } else if ($betting['bet_result'] == 'Plus') {
                                $master_comission = 0;
                                $parent_comission = 0;
                                $profit_amt = $betting['profit'] - $master_comission;
                                $bettingArr['amount'] += $profit_amt;

                                $parnet_loss = $profit_amt - (($profit_amt) * ($partnership / 100));
                                $parentBettingArr["amount"] += $parnet_loss;



                                $bettingArr['master_comission'] += $master_comission;
                                $bettingArr['parent_comission'] += $parent_comission;
                            }
                            $bettingArr['partnership']  =  $partnership;
                        }






                        if ($bettingArr['amount'] < 0) {

                            $bettingArr['amount'] +=   $total_settle_amount;
                        } else {
                            $bettingArr['amount'] -=  $total_settle_amount;
                        }


                        if ($bettingArr['amount'] < 0) {
                            array_push($minusArr, $bettingArr);
                        } else {
                            array_push($plusArr, $bettingArr);
                        }
                    }
                }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   ($parent_total_settle_amount);
                } else {
                    $parentBettingArr['amount'] -=    ($parent_total_settle_amount);
                }

                $parentBettingArr['amount'] = round($parentBettingArr['amount']);


                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }
            //  exit;


        } else if ($user_type === 'Super Master') {
            $partnership = $user->partnership;
            $master_id = $user->master_id;


            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;


            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;


            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;


            // p($parent_total_settle_amount);

            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );

            // p($parentBettingArr);

            $masters =  $this->User_model->getInnerUserById($user_id, $searchTerm);




            if (!empty($masters)) {
                foreach ($masters as $master) {
                    $chid_partnership_pr = $master->partnership;
                    // $child_commission_pr = $master->master_commision;
                    $child_commission_pr = 0;


                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $master->user_id, 'role' => 'Parent'))->settlement_amount;


                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $master->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;


                    $users =  $this->User_model->getInnerUserById($master->user_id);
                    $bettingArr = array(
                        'user_id' => $master->user_id,
                        'user_name' => $master->user_name,
                        'name' => $master->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );



                    if (!empty($users)) {
                        foreach ($users as $user) {

                            $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                            if (!empty($bettings)) {

                                foreach ($bettings as $betting) {
                                    if ($betting['bet_result'] == 'Minus') {
                                        $child_loss = ($betting['loss']) * ($chid_partnership_pr / 100);


                                        $profit_amt = $betting['loss']  - $child_loss;

                                        // p($profit_amt);
                                        $bettingArr['amount'] -= $profit_amt;


                                        $parent_loss =  $betting['loss'] - ($betting['loss'] * ($partnership / 100));


                                        $parentBettingArr["amount"] -= $parent_loss;
                                    } else if ($betting['bet_result'] == 'Plus') {

                                        $child_comission  =  0;
                                        $superior_comission  =  0;
                                        $parent_comission  =  0;


                                        $child_profit = ($betting['profit'] - $child_comission) * ($chid_partnership_pr / 100);



                                        $profit_amt = $betting['profit'] - $child_comission - $child_profit;



                                        $bettingArr['amount'] += $profit_amt;

                                        $parent_profit =  $betting['profit'] - ($betting['profit'] * ($partnership / 100));
                                        $parentBettingArr["amount"] += $parent_profit;

                                        $bettingArr['master_comission'] += $superior_comission;
                                        $bettingArr['parent_comission'] += $parent_comission;
                                    }

                                    $bettingArr['partnership']  =  $partnership;
                                }
                            }
                        }
                    }


                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] +=   abs($total_settle_amount);
                    } else {
                        $bettingArr['amount'] -=  abs($total_settle_amount);
                    }

                    $bettingArr['amount'] = round($bettingArr['amount']);
                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   $parent_total_settle_amount;
                } else {
                    $parentBettingArr['amount'] -=  $parent_total_settle_amount;
                }


                $parentBettingArr['amount'] = round($parentBettingArr['amount']);
                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }

            // p($plusArr);
            // exit;
        } else if ($user_type === 'Hyper Super Master') {
            $hyper_super_master_partnership = $user->partnership;
            $master_id = $user->master_id;

            $hyper_super_master_comission_pr = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;


            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;


            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;

            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );


            $super_masters =  $this->User_model->getInnerUserById($user_id, $searchTerm);

            if (!empty($super_masters)) {
                foreach ($super_masters as $super_master) {
                    $smaster_partnership_pr = $super_master->partnership;
                    $super_master_commission_pr = $super_master->master_commision;


                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $super_master->user_id, 'role' => 'Parent'))->settlement_amount;

                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $super_master->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
                    $bettingArr = array(
                        'user_id' => $super_master->user_id,
                        'user_name' => $super_master->user_name,
                        'name' => $super_master->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );


                    $masters =  $this->User_model->getInnerUserById($super_master->user_id);

                    if (!empty($masters)) {
                        foreach ($masters as $master) {
                            $master_commission_pr = $master->master_commision;
                            $master_partnership_pr = $master->partnership;


                            $users =  $this->User_model->getInnerUserById($master->user_id);
                            if (!empty($users)) {
                                foreach ($users as $user) {

                                    $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                                    foreach ($bettings as $betting) {
                                        if ($betting['bet_result'] == 'Minus') {


                                            $master_loss = ($betting['loss']) * ($master_partnership_pr / 100);


                                            $profit_amt = $betting['loss'] - $master_loss;


                                            $smaster_loss = ($betting['loss']) * ($smaster_partnership_pr / 100);
                                            $profit_amt = $betting['loss'] - $smaster_loss;



                                            $bettingArr['amount'] -= $profit_amt;

                                            $parent_loss = $betting['loss'] - ($betting['loss'] * ($hyper_super_master_partnership / 100));


                                            $parentBettingArr["amount"] -= $parent_loss;
                                        } else if ($betting['bet_result'] == 'Plus') {

                                            $master_profit = ($betting['profit']) * ($master_partnership_pr / 100);

                                            $profit_amt = $betting['profit'];

                                            $smaster_profit = ($profit_amt) * ($smaster_partnership_pr / 100);



                                            $profit_amt =  $betting['profit'] - $smaster_profit;

                                            $bettingArr['amount'] += $profit_amt;
                                            $parent_loss = $betting['profit'] - ($betting['profit'] * ($hyper_super_master_partnership / 100));
                                            $parentBettingArr["amount"] += $parent_loss;

                                            $bettingArr['master_comission'] += 0;
                                            $bettingArr['parent_comission'] += 0;
                                        }
                                        $bettingArr['partnership']  =  $hyper_super_master_partnership;
                                    }
                                }
                            }
                        }
                    }


                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] +=   abs($total_settle_amount);
                    } else {
                        $bettingArr['amount'] -=  abs($total_settle_amount);
                    }

                    $bettingArr['amount'] =   round($bettingArr['amount']);

                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   $parent_total_settle_amount;
                } else {
                    $parentBettingArr['amount'] -=  $parent_total_settle_amount;
                }

                $parentBettingArr['amount'] =   round($parentBettingArr['amount']);


                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }
            // exit;
        } else if ($user_type === 'Admin') {

            $admin_partnership = $user->partnership;
            $master_id = $user->master_id;

            $hyper_super_master_comission_pr = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = $master_user->master_commision;
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;



            $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;


            $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $user_id, 'role' => 'Parent'))->settlement_amount;
            $parent_total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;

            $parentBettingArr = array(
                'user_id' => $user->user_id,
                'user_name' => $parent_user_name,
                'name' => $parent_name,
                'amount' => 0,
                'master_comission' => 0,
                'partnership' => 0,
                'type' => 'Parent',

                'parent_comission' => 0,
            );

            $hyper_super_master_users =  $this->User_model->getInnerUserById($user_id, $searchTerm);

            if (!empty($hyper_super_master_users)) {
                foreach ($hyper_super_master_users as $hyper_super_master_user) {

                    $chid_partnership_pr = $hyper_super_master_user->partnership;
                    $hmaster_partnership_pr = $hyper_super_master_user->partnership;


                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $hyper_super_master_user->user_id, 'role' => 'Parent'))->settlement_amount;




                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $hyper_super_master_user->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
                    $bettingArr = array(
                        'user_id' => $hyper_super_master_user->user_id,
                        'user_name' => $hyper_super_master_user->user_name,
                        'name' => $hyper_super_master_user->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );

                    // p($bettingArr);



                    $super_masters =  $this->User_model->getInnerUserById($hyper_super_master_user->user_id);

                    if (!empty($super_masters)) {
                        foreach ($super_masters as $super_master) {
                            $smaster_partnership_pr = $super_master->partnership;



                            $masters =  $this->User_model->getInnerUserById($super_master->user_id);

                            if (!empty($masters)) {
                                foreach ($masters as $master) {

                                    $master_partnership_pr = $master->partnership;
                                    $users =  $this->User_model->getInnerUserById($master->user_id);
                                    if (!empty($users)) {
                                        foreach ($users as $user) {

                                            $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                                            if (!empty($bettings)) {

                                                foreach ($bettings as $betting) {
                                                    if ($betting['bet_result'] == 'Minus') {
                                                        $master_loss = ($betting['loss']) * ($master_partnership_pr / 100);



                                                        $profit_amt = $betting['loss'] - $master_loss;




                                                        $hmaster_loss = ($betting['loss']) * ($hmaster_partnership_pr / 100);


                                                        $profit_amt = $betting['loss'] - $hmaster_loss;


                                                        $bettingArr['amount'] -= $profit_amt;


                                                        $parent_loss = $betting['loss'] - ($betting['loss'] * ($admin_partnership / 100));
                                                        $parentBettingArr["amount"] -= $parent_loss;
                                                    } else if ($betting['bet_result'] == 'Plus') {

                                                        $master_profit = ($betting['profit']) * ($master_partnership_pr / 100);

                                                        $profit_amt = $betting['profit'] - $master_profit;

                                                        $smaster_profit = ($profit_amt) * ($smaster_partnership_pr / 100);
                                                        $profit_amt = $profit_amt - $smaster_profit;

                                                        $hmaster_profit = ($betting['profit']) * ($hmaster_partnership_pr / 100);
                                                        $profit_amt = $betting['profit'] - $hmaster_profit;

                                                        $bettingArr['amount'] += $profit_amt;

                                                        $parent_loss =  $betting['profit'] - ($betting['profit'] * ($admin_partnership / 100));
                                                        $parentBettingArr["amount"] += $parent_loss;

                                                        $bettingArr['master_comission'] += 0;
                                                        $bettingArr['parent_comission'] += 0;
                                                    }
                                                    $bettingArr['partnership']  =  $admin_partnership;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }


                    // if ($bettingArr['amount'] < 0) {
                    //     $bettingArr['amount'] =  number_format($bettingArr['amount'], 2) + number_format($total_settle_amount, 2);
                    // } else {
                    //     $bettingArr['amount'] =  number_format($bettingArr['amount'], 2) - number_format($total_settle_amount, 2);
                    // }
                    // $bettingArr['amount'] =   round($bettingArr['amount']);

                    // if ($bettingArr['amount'] < 0) {
                    //     array_push($minusArr, $bettingArr);
                    // }  else {
                    //     array_push($plusArr, $bettingArr);
                    // }
                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] +=   abs($total_settle_amount);
                    } else {
                        $bettingArr['amount'] -=  abs($total_settle_amount);
                    }

                    $bettingArr['amount'] =   round($bettingArr['amount']);

                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }

                // if ($parentBettingArr['amount'] < 0) {

                //     $parentBettingArr['amount'] = round($parentBettingArr['amount']) +   $parent_total_settle_amount;
                // } else {
                //     $parentBettingArr['amount'] =   round($parentBettingArr['amount']) - $parent_total_settle_amount;
                // }

                // $parentBettingArr['amount'] =   round($parentBettingArr['amount']);

                // if ($parentBettingArr['amount'] > 0) {
                //     array_push($minusArr, $parentBettingArr);
                // } else if ($parentBettingArr['amount'] < 0) {
                //     array_push($plusArr, $parentBettingArr);
                // }

                if ($parentBettingArr['amount'] < 0) {

                    $parentBettingArr['amount'] +=   $parent_total_settle_amount;
                } else {
                    $parentBettingArr['amount'] -=  $parent_total_settle_amount;
                }

                $parentBettingArr['amount'] =   round($parentBettingArr['amount']);


                if ($parentBettingArr['amount'] > 0) {
                    array_push($minusArr, $parentBettingArr);
                } else if ($parentBettingArr['amount'] < 0) {
                    array_push($plusArr, $parentBettingArr);
                }
            }
        } else if (get_user_type() === 'Super Admin') {

            $user_id = get_user_id();
            $user =  $this->User_model->getUserById($user_id);
            $hyper_super_master_partnership = $user->partnership;
            $master_id = $user->master_id;

            $hyper_super_master_comission_pr = $user->master_commision;

            $master_user =  $this->User_model->getUserById($master_id);
            $parent_commision_pr = 0;
            $parent_name = '';



            $admin_users =  $this->User_model->getInnerUserById($user_id, $searchTerm);

            if (!empty($admin_users)) {
                foreach ($admin_users as $admin_user) {
                    $chid_partnership_pr = $admin_user->partnership;
                    $super_master_commission_pr = $admin_user->master_commision;
                    $admin_partnership_pr =  $admin_user->partnership;

                    $ledger_plus_settle_amt = $this->Ledger_model->get_total_plus_settlement(array('user_id' => $admin_user->user_id, 'role' => 'Parent'))->settlement_amount;

                    $ledger_minus_settle_amt = $this->Ledger_model->get_total_minus_settlement(array('user_id' => $admin_user->user_id, 'role' => 'Parent'))->settlement_amount;

                    $total_settle_amount = $ledger_plus_settle_amt - $ledger_minus_settle_amt;
                    $bettingArr = array(
                        'user_id' => $admin_user->user_id,
                        'user_name' => $admin_user->user_name,
                        'name' => $admin_user->name,
                        'amount' => 0,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',

                        'parent_comission' => 0,
                    );


                    $hyper_super_master_users =  $this->User_model->getInnerUserById($admin_user->user_id);

                    if (!empty($hyper_super_master_users)) {
                        foreach ($hyper_super_master_users as $hyper_super_master_user) {
                            $hmaster_partnership_pr =  $hyper_super_master_user->partnership;



                            $super_masters =  $this->User_model->getInnerUserById($hyper_super_master_user->user_id);

                            if (!empty($super_masters)) {
                                foreach ($super_masters as $super_master) {

                                    $smaster_partnership_pr =  $super_master->partnership;



                                    $masters =  $this->User_model->getInnerUserById($super_master->user_id);

                                    if (!empty($masters)) {
                                        foreach ($masters as $master) {
                                            $master_commission_pr = $master->master_commision;
                                            $master_partnership_pr =  $master->partnership;
                                            $users =  $this->User_model->getInnerUserById($master->user_id);
                                            if (!empty($users)) {
                                                foreach ($users as $user) {

                                                    $bettings = (array) $this->Report_model->get_settled_accont_by_users($user->user_id);

                                                    if (!empty($bettings)) {

                                                        foreach ($bettings as $betting) {
                                                            if ($betting['bet_result'] == 'Minus') {
                                                                $master_loss = ($betting['loss']) * ($master_partnership_pr / 100);




                                                                $profit_amt = $betting['loss'] - $master_loss;
                                                                $smaster_loss = ($profit_amt) * ($smaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $smaster_loss;


                                                                $hmaster_loss = ($profit_amt) * ($hmaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $hmaster_loss;


                                                                $admin_loss = ($betting['loss']) * ($admin_partnership_pr / 100);
                                                                $profit_amt = $betting['loss'] - $admin_loss;



                                                                $bettingArr['amount'] -= $profit_amt;
                                                            } else if ($betting['bet_result'] == 'Plus') {

                                                                $master_profit = ($betting['profit']) * ($master_partnership_pr / 100);

                                                                $profit_amt = $betting['profit'] - $master_profit;

                                                                $smaster_profit = ($profit_amt) * ($smaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $smaster_profit;
                                                                //  p($profit_amt);

                                                                $hmaster_profit = ($profit_amt) * ($hmaster_partnership_pr / 100);
                                                                $profit_amt = $profit_amt - $hmaster_profit;

                                                                $admin_profit = ($betting['profit']) * ($admin_partnership_pr / 100);
                                                                $profit_amt = $betting['profit'] - $admin_profit;



                                                                $bettingArr['amount'] += $profit_amt;
                                                                $bettingArr['master_comission'] += 0;
                                                                $bettingArr['parent_comission'] += 0;
                                                            }
                                                            $bettingArr['partnership']  =  $hyper_super_master_partnership;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if ($bettingArr['amount'] < 0) {
                        $bettingArr['amount'] =  number_format($bettingArr['amount'], 2) + number_format($total_settle_amount, 2);
                    } else {
                        $bettingArr['amount'] =  number_format($bettingArr['amount'], 2) - number_format($total_settle_amount, 2);
                    }


                    $bettingArr['amount'] = round($bettingArr['amount']);
                    if ($bettingArr['amount'] < 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }
            }
        }


        $dataArray['minus_acc'] = $minusArr;
        $dataArray['plus_acc'] = $plusArr;
        $dataArray['parent_name'] = $parent_name;
        $dataArray['user_type'] = $user_type;
        $dataArray['user_id'] = $user_id;
        $dataArray['user_name'] = $user_name;

        $chip_smmary_html = $this->load->viewPartial('chip-summary-html', $dataArray);
        echo json_encode($chip_smmary_html);
    }



    public function profitLossDetail($event_id = null, $user_id = null)
    {
        $this->load->library('Datatable');
        $message = $this->session->flashdata('message');

        $table_config = array(
            'source' => site_url('admin/User/listUserdata'),
            'datatable_class' => $this->config->config["datatable_class"],
        );

        $dataArray = array(
            'table' => $this->datatable->make_table($this->_user_listing_headers, $table_config),
            'message' => $message
        );



        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );


        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }
        $dataArray['user_id']  = $user_id;
        // $dataArray['sportid']  = isset($sportid;
        // if ($sportid != 0) {
        //     $dataArray['sportid']  = 5;
        // }
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $search = '';
        $dataArray = array(
            'search_p_l' => $search,

            // 'sportid' => $sportid,

            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }


        $user_detail = $this->User_model->getUserById($user_id);



        $user_type = $user_detail->user_type;



        if ($user_type == 'Master') {

            $dataArray['pstatus'] = 'Settled';

            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            // $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
            //     'user_id' => $user_id,
            //     'match_id' => $report['match_id']
            // ));

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {

                    if ($report['match_id'] != $event_id) {
                        continue;
                    }



                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);
                    $market_id = str_replace('.', '_', $marketId);

                    if (isset($reports[$betting_type])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {

                            $p_l =  $reports[$betting_type]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {

                            // p($reports[$betting_type]['p_l'] +  $report['loss'] * -1);
                            $p_l = $reports[$betting_type]['p_l'] +  $report['loss'] * -1;
                        }



                        $reports[$betting_type]["match_id"] = $report['match_id'];
                        $reports[$betting_type]["event_name"] = $report['event_name'];
                        $reports[$betting_type]["market_name"] = $report['market_name'];
                        $reports[$betting_type]["market_id"] = $report['marketId'];
                        $reports[$betting_type]["match_id"] = $report['match_id'];
                        $reports[$betting_type]["p_l"] = $p_l;



                        // = array(
                        //     'match_id' => $report['match_id'],
                        //     'event_name' => $report['event_name'],
                        //     'market_name' => $market_name,
                        //     'market_id' => $marketId,

                        //     'p_l' => $p_l,
                        //     'commission' => 0,
                        //     'created_at' => $report['created_at']
                        // );

                        // if ($betting_type == 'fancy') {
                        //     $session_comm_amt = $this->Betting_model->count_total_master_session_comm($user_id,$report['match_id']);

                        //     $tmp_comm_value =  $session_comm_amt;


                        //     // p($tmp_comm_value);
                        //  }
                        // $comm_pl =  $reports[$betting_type]['comm_pl'] + $tmp_comm_value;
                        // if ($betting_type == 'fancy') {
                        //  }
                        // $reports[$betting_type]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss']  * -1;
                        } else if ($report['bet_result'] == 'Minus') {


                            $p_l = $report['profit'];
                        }


                        $grand_total_mo_comm = 0;
                        $grand_total_bm_comm = 0;

                        $grand_total_fancy_comm = 0;


                        $getCommissionUsers = $this->Betting_model->get_betting_events_user(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));




                        if (!empty($getCommissionUsers)) {
                            foreach ($getCommissionUsers as $CommissionUser) {
                                $dataArray2 = array(
                                    'user_id' => $CommissionUser->client_user_id,
                                    'match_id' => $report['match_id']
                                );

                                //***************MATCH ODDS COMM */
                                $matchOddsbettings = $this->Betting_model->get_match_odds_bettings_by_event_id($dataArray2);

                                $total_mo_profit = 0;
                                $total_mo_loss = 0;
                                $total_mo_amt = 0;
                                $user_mo_comm = 0;
                                $master_mo_comm = 0;
                                if (!empty($matchOddsbettings)) {
                                    foreach ($matchOddsbettings as $matchOddsbetting) {
                                        $user_mo_comm = $matchOddsbetting['master_commission'];
                                        if ($matchOddsbetting['bet_result'] == 'Plus') {
                                            $total_mo_profit += $matchOddsbetting['profit'];
                                        } else if ($matchOddsbetting['bet_result'] == 'Minus') {
                                            $total_mo_loss += $matchOddsbetting['loss'];
                                        }
                                    }
                                }

                                $master_mo_comm = $CommissionUser->master_commission -  $user_mo_comm;

                                $total_mo_amt = $total_mo_profit - $total_mo_loss;

                                if ($total_mo_amt < 0) {

                                    $commission_amt = (abs($total_mo_amt) * $CommissionUser->master_commission) / 100;
                                }

                                $mo_commission_amt = (abs($total_mo_amt) * $master_mo_comm) / 100;

                                $grand_total_mo_comm += $mo_commission_amt;

                                //***************MATCH ODDS COMM */


                                //***************BOOKMAKER COMM */
                                $bookMakerbettings = $this->Betting_model->get_bookmaker_bettings_by_event_id($dataArray2);


                                $total_bm_profit = 0;
                                $total_bm_loss = 0;
                                $total_bm_amt = 0;
                                $user_bm_comm = 0;
                                $master_bm_comm = 0;
                                if (!empty($bookMakerbettings)) {
                                    foreach ($bookMakerbettings as $bookMakerbetting) {
                                        $user_bm_comm = $bookMakerbetting['master_commission'];
                                        if ($bookMakerbetting['bet_result'] == 'Plus') {
                                            $total_bm_profit += $bookMakerbetting['profit'];
                                        } else if ($bookMakerbetting['bet_result'] == 'Minus') {
                                            $total_bm_loss += $bookMakerbetting['loss'];
                                        }
                                    }
                                }

                                $master_bm_comm = $CommissionUser->master_commission -  $user_bm_comm;

                                $total_bm_amt = $total_bm_profit - $total_bm_loss;

                                if ($total_bm_amt < 0) {



                                    $bm_commission_amt = (abs($total_bm_amt) * $master_bm_comm) / 100;
                                }

                                $grand_total_bm_comm += $bm_commission_amt;
                                //***************BOOKMAKER COMM */

                                // p($bm_commission_amt);
                                //***************FANCY COMM */
                                $fancybettings = $this->Betting_model->get_fancy_bettings_by_event_id($dataArray2);

                                $total_fancy_profit = 0;
                                $total_fancy_loss = 0;
                                $total_fancy_amt = 0;
                                $user_fancy_comm = 0;
                                $master_fancy_comm = 0;
                                if (!empty($fancybettings)) {
                                    foreach ($fancybettings as $fancybetting) {

                                        $user_fancy_comm = $fancybetting['sessional_commission'];
                                        if ($fancybetting['bet_result'] == 'Plus') {
                                            $total_fancy_profit += $fancybetting['profit'];
                                        } else if ($fancybetting['bet_result'] == 'Minus') {
                                            $total_fancy_loss += $fancybetting['loss'];
                                        }
                                    }
                                }

                                $master_fancy_comm = $CommissionUser->sessional_commission -  $user_fancy_comm;

                                $total_fancy_amt = $total_fancy_profit - $total_fancy_loss;

                                if ($total_fancy_amt < 0) {



                                    $fancy_commission_amt = (abs($total_fancy_amt) * $master_fancy_comm) / 100;
                                }

                                $grand_total_fancy_comm += $fancy_commission_amt;
                                //***************FANCY COMM */


                            }
                        }

                        $commission = $grand_total_mo_comm + $grand_total_bm_comm + $grand_total_fancy_comm;


                        // p($commission);
                        $p_l -= $grand_total_mo_comm;
                        $p_l -= $grand_total_bm_comm;
                        $p_l -= $grand_total_fancy_comm;


                        $reports[$betting_type] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'p_l' => $p_l,
                            'comm_pl' => $commission,
                            'created_at' => $report['created_at']
                        );
                        // $comm_pl = 0;
                        // $sessional_commission = 2;

                        // $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
                        //     'user_id' => $user_id,
                        //     'match_id' => $report['match_id']
                        // ));


                        ///COMMENT ON 23 AUG
                        // if ($betting_type == 'fancy') {
                        //     $session_comm_amt = $this->Betting_model->count_total_master_session_comm($user_id, $report['match_id']);

                        //     $tmp_comm_value =  $session_comm_amt;


                        //     // p($tmp_comm_value);
                        // } else {

                        //     $match_comm_amt = $this->Betting_model->count_total_master_match_comm($user_id, $report['match_id']);
                        //     $tmp_comm_value =  $match_comm_amt;
                        // }


                        // // p($tmp_comm_value);
                        // $comm_pl =  $reports[$betting_type]['comm_pl'] + $tmp_comm_value;
                        // if ($betting_type == 'fancy') {
                        // }
                        // $reports[$betting_type]['comm_pl'] =  $comm_pl;
                        //COMMENT ON 23 UAG
                    }
                }
            }
        } else if ($user_type == 'Super Master' || $user_type == 'Hyper Super Master' || $user_type == 'Admin' || $user_type == 'Super Admin') {

            $dataArray['pstatus'] = 'Settled';

            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            // $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
            //     'user_id' => $user_id,
            //     'match_id' => $report['match_id']
            // ));

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {

                    if ($report['match_id'] != $event_id) {
                        continue;
                    }



                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);
                    $market_id = str_replace('.', '_', $marketId);

                    if (isset($reports[$betting_type])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {

                            $p_l =  $reports[$betting_type]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {

                            // p($reports[$betting_type]['p_l'] +  $report['loss'] * -1);
                            $p_l = $reports[$betting_type]['p_l'] +  $report['loss'] * -1;
                        }



                        $reports[$betting_type]["match_id"] = $report['match_id'];
                        $reports[$betting_type]["event_name"] = $report['event_name'];
                        $reports[$betting_type]["market_name"] = $report['market_name'];
                        $reports[$betting_type]["market_id"] = $report['marketId'];
                        $reports[$betting_type]["match_id"] = $report['match_id'];
                        $reports[$betting_type]["p_l"] = $p_l;



                        // = array(
                        //     'match_id' => $report['match_id'],
                        //     'event_name' => $report['event_name'],
                        //     'market_name' => $market_name,
                        //     'market_id' => $marketId,

                        //     'p_l' => $p_l,
                        //     'commission' => 0,
                        //     'created_at' => $report['created_at']
                        // );

                        // if ($betting_type == 'fancy') {
                        //     $session_comm_amt = $this->Betting_model->count_total_master_session_comm($user_id,$report['match_id']);

                        //     $tmp_comm_value =  $session_comm_amt;


                        //     // p($tmp_comm_value);
                        //  }
                        // $comm_pl =  $reports[$betting_type]['comm_pl'] + $tmp_comm_value;
                        // if ($betting_type == 'fancy') {
                        //  }
                        // $reports[$betting_type]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss']  * -1;
                        } else if ($report['bet_result'] == 'Minus') {


                            $p_l = $report['profit'];
                        }



                        $grand_total_mo_comm = 0;
                        $grand_total_bm_comm = 0;

                        $grand_total_fancy_comm = 0;


                        $getCommissionUsers = $this->Betting_model->get_betting_events_user(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommissionUsers)) {
                            foreach ($getCommissionUsers as $CommissionUser) {

                                $bet_user_type = '';

                                if ($user_type == 'Super Master') {
                                    $bet_user_type = 'Master';
                                } else if ($user_type == 'Hyper Super Master') {
                                    $bet_user_type = 'Super Master';
                                } else if ($user_type == 'Admin') {
                                    $bet_user_type = 'Hyper Super Master';
                                } else if ($user_type == 'Super Admin') {
                                    $bet_user_type = 'Admin';
                                }

                                $dataArray2 = array(
                                    'user_id' => $CommissionUser->client_user_id,
                                    'match_id' => $report['match_id'],
                                    'user_type' => $bet_user_type
                                );

                                //***************MATCH ODDS COMM */
                                $matchOddsbettings = $this->Betting_model->get_masters_wise_match_odds_bettings_by_event_id($dataArray2);


                                $total_mo_profit = 0;
                                $total_mo_loss = 0;
                                $total_mo_amt = 0;
                                $user_mo_comm = 0;
                                $master_mo_comm = 0;
                                if (!empty($matchOddsbettings)) {
                                    foreach ($matchOddsbettings as $matchOddsbetting) {
                                        $user_mo_comm = $matchOddsbetting['master_commission'];
                                        if ($matchOddsbetting['bet_result'] == 'Plus') {
                                            $total_mo_profit += $matchOddsbetting['profit'];
                                        } else if ($matchOddsbetting['bet_result'] == 'Minus') {
                                            $total_mo_loss += $matchOddsbetting['loss'];
                                        }
                                    }
                                }

                                $master_mo_comm = $CommissionUser->master_commission -  $user_mo_comm;

                                $total_mo_amt = $total_mo_profit - $total_mo_loss;

                                if ($total_mo_amt < 0) {

                                    $commission_amt = (abs($total_mo_amt) * $CommissionUser->master_commission) / 100;
                                }

                                $mo_commission_amt = (abs($total_mo_amt) * $master_mo_comm) / 100;

                                $grand_total_mo_comm += $mo_commission_amt;
                                //***************MATCH ODDS COMM */


                                //***************BOOKMAKER COMM */
                                $bookMakerbettings = $this->Betting_model->get_masters_wise_bookmaker_bettings_by_event_id($dataArray2);




                                $total_bm_profit = 0;
                                $total_bm_loss = 0;
                                $total_bm_amt = 0;
                                $user_bm_comm = 0;
                                $master_bm_comm = 0;
                                if (!empty($bookMakerbettings)) {
                                    foreach ($bookMakerbettings as $bookMakerbetting) {
                                        $user_bm_comm = $bookMakerbetting['master_commission'];
                                        if ($bookMakerbetting['bet_result'] == 'Plus') {
                                            $total_bm_profit += $bookMakerbetting['profit'];
                                        } else if ($bookMakerbetting['bet_result'] == 'Minus') {
                                            $total_bm_loss += $bookMakerbetting['loss'];
                                        }
                                    }
                                }

                                $master_bm_comm = $CommissionUser->master_commission -  $user_bm_comm;

                                $total_bm_amt = $total_bm_profit - $total_bm_loss;

                                if ($total_bm_amt < 0) {



                                    $bm_commission_amt = (abs($total_bm_amt) * $master_bm_comm) / 100;
                                }

                                $grand_total_bm_comm += $bm_commission_amt;
                                //***************BOOKMAKER COMM */

                                // p($bm_commission_amt);
                                //***************FANCY COMM */
                                $fancybettings = $this->Betting_model->get_fancy_bettings_by_event_id($dataArray2);

                                $total_fancy_profit = 0;
                                $total_fancy_loss = 0;
                                $total_fancy_amt = 0;
                                $user_fancy_comm = 0;
                                $master_fancy_comm = 0;
                                if (!empty($fancybettings)) {
                                    foreach ($fancybettings as $fancybetting) {

                                        $user_fancy_comm = $fancybetting['sessional_commission'];
                                        if ($fancybetting['bet_result'] == 'Plus') {
                                            $total_fancy_profit += $fancybetting['profit'];
                                        } else if ($fancybetting['bet_result'] == 'Minus') {
                                            $total_fancy_loss += $fancybetting['loss'];
                                        }
                                    }
                                }

                                $master_fancy_comm = $CommissionUser->sessional_commission -  $user_fancy_comm;

                                $total_fancy_amt = $total_fancy_profit - $total_fancy_loss;

                                if ($total_fancy_amt < 0) {



                                    $fancy_commission_amt = (abs($total_fancy_amt) * $master_fancy_comm) / 100;
                                }

                                $grand_total_fancy_comm += $fancy_commission_amt;
                                //***************FANCY COMM */


                            }
                        }


                        if ($market_name == 'Bookmaker') {
                            $commission =   $grand_total_bm_comm;
                        } else if ($market_name == 'Fancy') {
                            $commission =   $grand_total_fancy_comm;
                        } else {
                            $commission = $grand_total_mo_comm;
                        }


                        $p_l -= $grand_total_mo_comm;
                        $p_l -= $grand_total_bm_comm;
                        $p_l -= $grand_total_fancy_comm;



                        $reports[$betting_type] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'p_l' => $p_l,
                            'comm_pl' => $commission,
                            'created_at' => $report['created_at']
                        );
                        // $comm_pl = 0;
                        // $sessional_commission = 2;

                        // $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
                        //     'user_id' => $user_id,
                        //     'match_id' => $report['match_id']
                        // ));


                        ///COMMENT ON 23 AUG
                        // if ($betting_type == 'fancy') {
                        //     $session_comm_amt = $this->Betting_model->count_total_master_session_comm($user_id, $report['match_id']);

                        //     $tmp_comm_value =  $session_comm_amt;


                        //     // p($tmp_comm_value);
                        // } else {

                        //     $match_comm_amt = $this->Betting_model->count_total_master_match_comm($user_id, $report['match_id']);
                        //     $tmp_comm_value =  $match_comm_amt;
                        // }


                        // // p($tmp_comm_value);
                        // $comm_pl =  $reports[$betting_type]['comm_pl'] + $tmp_comm_value;
                        // if ($betting_type == 'fancy') {
                        // }
                        // $reports[$betting_type]['comm_pl'] =  $comm_pl;
                        //COMMENT ON 23 UAG
                    }
                }
            }
        } else {

            $dataArray['pstatus'] = 'Settled';

            $reports = array();
            $reportsData = $this->Betting_model->get_bettings($dataArray);

            // p($reportsData);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {

                    if ($report['match_id'] != $event_id) {
                        continue;
                    }



                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);
                    $market_id = str_replace('.', '_', $marketId);

                    if (isset($reports[$betting_type])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        // if ($report['market_name'] == 'Bookmaker') {
                        //     $betting_type = 'Bookmaker';
                        //                             }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {

                            $p_l =  $reports[$betting_type]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Minus') {

                            // p($reports[$betting_type]['p_l'] +  $report['loss'] * -1);
                            $p_l = $reports[$betting_type]['p_l'] +  $report['loss'] * -1;
                        }



                        $reports[$betting_type]['match_id'] = $report['match_id'];
                        $reports[$betting_type]['event_name'] = $report['event_name'];
                        $reports[$betting_type]['market_name'] = $market_name;
                        $reports[$betting_type]['market_id'] = $marketId;

                        $reports[$betting_type]['p_l'] = $p_l;

                        $reports[$betting_type]['created_at'] = $report['created_at'];
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        // if ($report['market_name'] == 'Bookmaker') {
                        //     $betting_type = 'Bookmaker';
                        //                             }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Minus') {


                            $p_l = $report['loss'] * -1;
                        }


                        if ($market_name == 'Bookmaker') {
                            $getCommssion = $this->Ledger_model->get_user_bookmaker_commission_amt_by_event_id(array(
                                'user_id' => $user_id,
                                'match_id' => $report['match_id']
                            ));
                        } else if ($market_name == 'Fancy') {
                            $getCommssion = $this->Ledger_model->get_user_fancy_commission_amt_by_event_id(array(
                                'user_id' => $user_id,
                                'match_id' => $report['match_id']
                            ));
                        } else {
                            $getCommssion = $this->Ledger_model->get_user_match_odds_commission_amt_by_event_id(array(
                                'user_id' => $user_id,
                                'match_id' => $report['match_id']
                            ));
                        }






                        if (!empty($getCommssion)) {
                            $p_l += $getCommssion->total_commission;
                        }


                        // p($getCommssion);

                        $reports[$betting_type] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'p_l' => $p_l,
                            'comm_pl' => $getCommssion->total_commission,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        }

        // p($reports);


        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;
        $dataArray['event_id'] = $event_id;
        $dataArray['reports'] = $reports;

        $dataArray['profit_loss']  = $this->load->viewPartial('/profit-loss-detail-list-html', $dataArray);
        $this->load->view('/profit-loss-detail', $dataArray);
    }


    public function profitLossbethistory($event_id = null, $market_id = null, $user_id = null, $is_fancy = null)
    {


        $master_id = $_SESSION['my_userdata']['user_id'];
        if (empty($user_id)) {

            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['pstatus'] = 'Settled';

        if ($is_fancy == 'Yes') {
            $dataArray['betting_type'] = 'Fancy';
        } else {
            $dataArray['betting_type'] = 'Match';
        }

        $dataArray['match_id'] = $event_id;


        $user =  $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;
        $reportsData = array();


        $dataArray['user_id']  = $user_id;




        if ($user_type == 'User') {

            $reports = $this->Betting_model->get_bettings($dataArray);

            foreach ($reports as $reportKey => $report) {


                if ($report['betting_type'] == 'Fancy') {
                    $selection_id = $report['selection_id'];
                    $fancy_info = $this->Betting_model->get_fancy_by_selectionid($selection_id);

                    $settled_result = empty($fancy_info->result) ? null : $fancy_info->result;
                    // $settled_result = $fancy_info->result;
                    $reports[$reportKey]['settled_result'] = $settled_result;
                } else if ($report['betting_type'] == 'Match') {
                    $winner_selection_id = $report['winner_selection_id'];
                    $market_id = $report['market_id'];

                    $market_info =  $this->Betting_model->get_market_type_by_marketid($market_id);
                    $result = '';

                    $runner =  $this->Event_model->get_market_book_odds_runner_by_id(array('market_id' => $market_id, 'selection_id' => $winner_selection_id));
                    $result = $runner->runner_name;
                    // if (!empty($market_info)) {
                    //     if ($winner_selection_id == $market_info->runner_1_selection_id) {
                    //         $result = $market_info->runner_1_runner_name;
                    //     } else if ($winner_selection_id == $market_info->runner_2_selection_id) {
                    //         $result = $market_info->runner_2_runner_name;
                    //     }
                    // }

                    $reports[$reportKey]['settled_result'] = $result;
                }
            }
            $reportsData = array_merge($reportsData, $reports);
        } else if ($user_type == 'Master') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Master') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Hyper Super Master') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Admin') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Admin') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        }
        array_multisort(array_map('strtotime', array_column($reportsData, 'created_at')), SORT_DESC, $reportsData);
        $dataArray['bettings'] = $reportsData;
        $dataArray['user_type'] = $user_type;

        $dataArray['betting'] = $this->load->viewPartial('/profit-loss-betting-list-html', $dataArray);

        $dataArray['match_id'] = $event_id;
        $dataArray['market_id'] = $market_id;
        $dataArray['is_fancy'] = $is_fancy;

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4',
            'blockUI'
        );
        //         p($reports);
        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;
        $this->load->view('/profit-loss-bet-history', $dataArray);
    }
    public function profitLossfilterbethistory($event_id = null, $market_id = null, $user_id = null, $is_fancy = null)
    {

        if (isset($_POST['user_id'])) {
            $user_id = $this->input->post('user_id');
        } else {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }

        $dataArray['user_id']  = $user_id;


        $search = $this->input->post('searchterm');
        $fdate = $this->input->post('fdate');
        $tdate = $this->input->post('tdate');
        $sportid = $this->input->post('sportstype') == 5 ? 5 : $this->input->post('sportstype');
        $bstatus = $this->input->post('bstatus');
        $pstatus = $this->input->post('pstatus');
        $market_id = $this->input->post('market_id');
        $match_id = $this->input->post('match_id');
        $is_fancy = $this->input->post('is_fancy');


        //p($sportid);
        $dataArray = array(
            'search' => $search,
            'sportid' => $sportid,
            'bstatus' => $bstatus,
            'pstatus' => $pstatus,
        );


        if ($is_fancy == 'Yes') {
            $dataArray['betting_type'] = 'Fancy';
        } else {
            $dataArray['betting_type'] = 'Match';
        }

        $dataArray['match_id'] = $match_id;


        if (!empty($tdate) && !empty($fdate)) {
            $dataArray['fromDate'] = date("Y-m-d H:i:s", strtotime($fdate));

            $tdate   =  date('Y-m-d H:i:s', (strtotime("tomorrow", strtotime($tdate)) - 1));
            $dataArray['toDate'] = $tdate;
        }


        $user =  $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;

        $dataArray['user_id']  = $user_id;


        $reportsData = array();

        if ($user_type == 'User') {
            $reports = $this->Betting_model->get_bettings($dataArray);


            foreach ($reports as $reportKey => $report) {


                if ($report['betting_type'] == 'Fancy') {
                    $selection_id = $report['selection_id'];
                    $fancy_info = $this->Betting_model->get_fancy_by_selectionid($selection_id);

                    $settled_result = $fancy_info->result;

                    $reports[$reportKey]['settled_result'] = $settled_result;
                } else if ($report['betting_type'] == 'Match') {
                    $winner_selection_id = $report['winner_selection_id'];
                    $market_id = $report['market_id'];

                    $market_info =  $this->Betting_model->get_market_type_by_marketid($market_id);
                    $result = '';
                    $runner =  $this->Event_model->get_market_book_odds_runner_by_id(array('market_id' => $market_id, 'selection_id' => $winner_selection_id));
                    $result = $runner->runner_name;


                    $reports[$reportKey]['settled_result'] = $result;
                }
            }
            $reportsData = array_merge($reportsData, $reports);
        } else if ($user_type == 'Master') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Master') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Hyper Super Master') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Admin') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        } else if ($user_type == 'Super Admin') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
        }


        // usort($reportsData, 'date_compare');
        array_multisort(array_map('strtotime', array_column($reportsData, 'created_at')), SORT_DESC, $reportsData);
        $dataArray['bettings'] = $reportsData;
        $dataArray['user_type'] = $user_type;
        $bethistory = $this->load->viewPartial('/profit-loss-betting-list-html', $dataArray);
        echo json_encode($bethistory);
    }

    // public function chip_summarynew($list_user_type = null)
    // {
    //     log_message("MY_INFO", 'Chip Summary Load Start');
    //     $minusArr = array();
    //     $plusArr = array();
    //          $user_id = get_user_id();
    //      $user = $this->User_model->getUserById($user_id);
    //     $user_type = $user->user_type;
    //     $user_name = $user->name;
    //     $partnership = $user->partnership;

    //     p($user_type);
    //     if ($user->master_id == 0) {
    //         $parent_name = '';
    //         $parent_user_name = '';
    //     } else {
    //         $master_id = $user->master_id;
    //         $master_user = $this->User_model->getUserById($master_id);
    //         $parent_name = $master_user->name;
    //         $parent_user_name = $master_user->user_name;
    //         $master_partnership = $master_user->partnership;
    //     }
    //     $users = $this->User_model->getInnerUserById($user_id);
    //     $parent_total_settle_amount = $this->Ledger_model->get_total_settlement($user->user_id,'Y');
    //     $parentBettingArr = array(
    //         'user_id' => $user->user_id,
    //         'user_name' => $parent_user_name,
    //         'name' => $parent_name,
    //         'amount' => 0,
    //         'master_comission' => 0,
    //         'partnership' => 0,
    //         'type' => 'Parent',
    //         'parent_comission' => 0,
    //     );

    //     if (!empty($users)) {
    //         foreach ($users as $user) {
    //             $total_settle_amount = $this->Ledger_model->get_total_settlement($user->user_id,'N');
    //                 $bettingArr = array(
    //                     'user_id' => $user->user_id,
    //                     'user_name' => $user->user_name,
    //                     'name' => $user->name,
    //                     'amount' => $total_settle_amount,
    //                     'master_comission' => 0,
    //                     'partnership' => 0,
    //                     'type' => 'User',
    //                     'parent_comission' => 0,
    //                 );
    //                 if ($total_settle_amount < 0) {
    //                     array_push($minusArr, $bettingArr);
    //                 } else {
    //                     array_push($plusArr, $bettingArr);
    //                 }
    //         }
    //     }
    //     if ($parentBettingArr['amount'] < 0) {
    //         $parentBettingArr['amount'] -= ($parent_total_settle_amount);
    //     } else {
    //         $parentBettingArr['amount'] += ($parent_total_settle_amount);
    //     }
    //     $parentBettingArr['amount'] = round($parentBettingArr['amount']);
    //     if ($parentBettingArr['amount'] > 0) {
    //         array_push($minusArr, $parentBettingArr);
    //     } else if ($parentBettingArr['amount'] < 0) {
    //         array_push($plusArr, $parentBettingArr);
    //     }

    //     $dataArray['minus_acc'] = $minusArr;
    //     $dataArray['plus_acc'] = $plusArr;
    //     $dataArray['parent_name'] = $parent_name;
    //     $dataArray['user_type'] = $user_type;
    //     $dataArray['user_id'] = $user_id;
    //     $dataArray['user_name'] = $user_name;
    //     log_message("MY_INFO", 'Chip Summary Load End');
    //     $this->load->view('chip-summary', $dataArray);
    // }

    public function chip_summarynew($list_user_type = null)
    {
        log_message("MY_INFO", 'Chip Summary Load Start');
        $minusArr = array();
        $plusArr = array();
        $user_id = get_user_id();
        $user = $this->User_model->getUserById($user_id);
        $user_type = $user->user_type;
        $user_name = $user->name;
        $partnership = $user->partnership;

        if ($user->master_id == 0) {
            $parent_name = '';
            $parent_user_name = '';
        } else {
            $master_id = $user->master_id;
            $master_user = $this->User_model->getUserById($master_id);
            $parent_name = $master_user->name;
            $parent_user_name = $master_user->user_name;
            $master_partnership = $master_user->partnership;
        }

        $users = array();


        //MASTERS
        if ($user_type == 'Master') {
            if ($list_user_type == 'client') {

                $users = $this->User_model->getInnerUserById($user_id);
            }
        }
        //MASTERS



        //SUPER MASTERS
        if ($user_type == 'Super Master') {
            if ($list_user_type === 'client') {
                $masters = $this->User_model->getInnerUserById($user_id);

                if (!empty($masters)) {
                    foreach ($masters as $master) {
                        $usersData = $this->User_model->getInnerUserById($master->user_id);
                        $users = array_merge($users, $usersData);
                    }
                }
            } else if ($list_user_type === 'agent') {
                $masters = $this->User_model->getInnerUserById($user_id);
                $users = array_merge($users, $masters);
            }
        }
        //SUPER MASTERS


        //HYPER SUPER MASTERS
        if ($user_type == 'Hyper Super Master') {
            if ($list_user_type === 'super') {
                $masters = $this->User_model->getInnerUserById($user_id);
                $users = array_merge($users, $masters);
            } else if ($list_user_type === 'agent') {
                $masters = $this->User_model->getInnerUserById($user_id);

                if (!empty($masters)) {
                    foreach ($masters as $master) {
                        $usersData = $this->User_model->getInnerUserById($master->user_id);
                        $users = array_merge($users, $usersData);
                    }
                }
            } else if ($list_user_type === 'client') {
                $supers = $this->User_model->getInnerUserById($user_id);
                if (!empty($supers)) {
                    foreach ($supers as $super) {
                        $masters = $this->User_model->getInnerUserById($super->user_id);

                        if (!empty($masters)) {
                            foreach ($masters as $master) {
                                $usersData = $this->User_model->getInnerUserById($master->user_id);
                                $users = array_merge($users, $usersData);
                            }
                        }
                    }
                }
            }
        }
        //HYPER SUPER MASTERS

        //ADMIN MASTERS
        if ($user_type == 'Admin') {
            if ($list_user_type === 'master') {
                $masters = $this->User_model->getInnerUserById($user_id);
                $users = array_merge($users, $masters);
            } else if ($list_user_type === 'super') {

                $supers = $this->User_model->getInnerUserById($user_id);



                if (!empty($supers)) {
                    foreach ($supers as $super) {
                        $masters = $this->User_model->getInnerUserById($super->user_id);


                        $usersData = $this->User_model->getInnerUserById($master->user_id);
                        $users = array_merge($users, $masters);
                    }
                }
            } else if ($list_user_type === 'agent') {
                $hypers = $this->User_model->getInnerUserById($user_id);

                if (!empty($hypers)) {
                    foreach ($hypers as $hyper) {
                        $supers = $this->User_model->getInnerUserById($hyper->user_id);

                        if (!empty($supers)) {
                            foreach ($supers as $super) {
                                $masters = $this->User_model->getInnerUserById($super->user_id);


                                $usersData = $this->User_model->getInnerUserById($master->user_id);
                                $users = array_merge($users, $masters);
                            }
                        }
                    }
                }
            } else if ($list_user_type === 'client') {

                $hypers = $this->User_model->getInnerUserById($user_id);
                if (!empty($hypers)) {
                    foreach ($hypers as $hyper) {
                        $supers = $this->User_model->getInnerUserById($hyper->user_id);

                        if (!empty($supers)) {
                            foreach ($supers as $super) {
                                $masters = $this->User_model->getInnerUserById($super->user_id);

                                if (!empty($masters)) {
                                    foreach ($masters as $master) {
                                        $usersData = $this->User_model->getInnerUserById($master->user_id);
                                        $users = array_merge($users, $usersData);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        //HYPER SUPER MASTERS




        //SUPER ADMIN MASTERS
        if ($user_type == 'Super Admin') {
            if ($list_user_type === 'sba') {
                $masters = $this->User_model->getInnerUserById($user_id);
                $users = array_merge($users, $masters);
            } else if ($list_user_type === 'master') {

                $supers = $this->User_model->getInnerUserById($user_id);



                if (!empty($supers)) {
                    foreach ($supers as $super) {
                        $masters = $this->User_model->getInnerUserById($super->user_id);


                        $usersData = $this->User_model->getInnerUserById($master->user_id);
                        $users = array_merge($users, $masters);
                    }
                }
            } else if ($list_user_type === 'super') {
                $hypers = $this->User_model->getInnerUserById($user_id);

                if (!empty($hypers)) {
                    foreach ($hypers as $hyper) {
                        $supers = $this->User_model->getInnerUserById($hyper->user_id);

                        if (!empty($supers)) {
                            foreach ($supers as $super) {
                                $masters = $this->User_model->getInnerUserById($super->user_id);


                                $usersData = $this->User_model->getInnerUserById($master->user_id);
                                $users = array_merge($users, $masters);
                            }
                        }
                    }
                }
            } else if ($list_user_type === 'agent') {

                $hypers = $this->User_model->getInnerUserById($user_id);
                if (!empty($hypers)) {
                    foreach ($hypers as $hyper) {
                        $supers = $this->User_model->getInnerUserById($hyper->user_id);

                        if (!empty($supers)) {
                            foreach ($supers as $super) {
                                $masters = $this->User_model->getInnerUserById($super->user_id);

                                if (!empty($masters)) {
                                    foreach ($masters as $master) {
                                        $usersData = $this->User_model->getInnerUserById($master->user_id);
                                        $users = array_merge($users, $usersData);
                                    }
                                }
                            }
                        }
                    }
                }
            } else if ($list_user_type === 'client') {

                $admins = $this->User_model->getInnerUserById($user_id);

                if (!empty($admins)) {
                    foreach ($admins as $admin) {
                        $hypers = $this->User_model->getInnerUserById($admin->user_id);
                        if (!empty($hypers)) {
                            foreach ($hypers as $hyper) {
                                $supers = $this->User_model->getInnerUserById($hyper->user_id);

                                if (!empty($supers)) {
                                    foreach ($supers as $super) {
                                        $masters = $this->User_model->getInnerUserById($super->user_id);

                                        if (!empty($masters)) {
                                            foreach ($masters as $master) {
                                                $usersData = $this->User_model->getInnerUserById($master->user_id);
                                                $users = array_merge($users, $usersData);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        //HYPER SUPER MASTERS




        if (!empty($users)) {
            foreach ($users as $user) {


                if ($user->user_type == 'User') {




                    if ($user->user_id != '7478') {
                        // continue;
                    }
                    $total_settle_amount = $this->Ledger_model->get_total_settlement_new($user->user_id, 'N', $user->user_type);

                    $bettingArr = array(
                        'user_id' => $user->user_id,
                        'user_name' => $user->user_name,
                        'name' => $user->name,
                        'amount' => $total_settle_amount,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => 'User',
                        'parent_comission' => 0,
                    );


                    if ($user->user_type == 'User') {
                        if ($total_settle_amount < 0) {
                            array_push($minusArr, $bettingArr);
                        } else {
                            array_push($plusArr, $bettingArr);
                        }
                    } else {
                        if ($total_settle_amount < 0) {
                            array_push($minusArr, $bettingArr);
                        } else {
                            array_push($plusArr, $bettingArr);
                        }
                    }
                } else {
                    $user_type = $user->user_type;
                    $user_id = $user->user_id;
                    $resultData = array();

                    $dataArray = array(
                        'user_id' => $user_id,
                        'pstatus' => 'Settled'
                    );

                    $reports = array();


                    $ledgerData = $this->Ledger_model->get_ledger(array(
                        'fltrselct' => 2,
                        'user_id' => $user_id
                    ));



                    $reportsData = $this->Report_model->get_my_ledger_events_list($dataArray);


                    if ($user_type == 'Master') {


                        if (!empty($reportsData)) {
                            foreach ($reportsData as $report) {
                                $event_id  = $report['match_id'];
                                $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $user_id,
                                    'match_id' => $report['match_id']
                                ));


                                $resultData[$event_id] = array(
                                    'match_id' => $report['match_id'],
                                    'event_name' => $report['event_name'],
                                    'created_at' => $report['created_at'],
                                    'p_l' => 0,
                                );


                                if (!empty($usersDatas)) {
                                    foreach ($usersDatas as $key => $usersData) {



                                        $usersDatas[$key]->master = array();
                                        $usersDatas[$key]->super_master = array();
                                        $usersDatas[$key]->hyper_super_master = array();
                                        $usersDatas[$key]->admin = array();
                                        $usersDatas[$key]->super_admin = array();

                                        $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                        $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                        $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                        $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                        $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                        $user_match_comm = 0;
                                        $user_session_comm = 0;


                                        if ($user_match_pl < 0) {
                                            $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                        }

                                        $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                        if ($total_session_stake > 0) {
                                            $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                        }

                                        $total_pl = $user_match_pl + $user_session_pl;

                                        $total_comm = $user_match_comm + $user_session_comm;

                                        if ($total_pl < 0) {
                                            $net_amt = ($total_pl + $total_comm);
                                        } else {
                                            $net_amt = ($total_pl + $total_comm);
                                        }
                                        $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                        $final_amt = $net_amt - $share_amt;


                                        if ($final_amt < 0) {
                                            $final_amt = $final_amt * -1;
                                            $resultData[$event_id]['p_l'] += $final_amt;
                                        } else {
                                            $final_amt = $final_amt * -1;

                                            $resultData[$event_id]['p_l'] += $final_amt;
                                        }
                                    }
                                }
                            }
                        }
                    } else if ($user_type == 'Super Master') {

                        if (!empty($reportsData)) {
                            foreach ($reportsData as $report) {
                                $event_id  = $report['match_id'];
                                $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $user_id,
                                    'match_id' => $report['match_id']
                                ));


                                if (!empty($mastersDatas)) {
                                    foreach ($mastersDatas as $masterData) {
                                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $masterData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        $resultData[$event_id] = array(
                                            'match_id' => $report['match_id'],
                                            'event_name' => $report['event_name'],
                                            'created_at' => $report['created_at'],
                                            'p_l' => 0,
                                        );


                                        if (!empty($usersDatas)) {
                                            foreach ($usersDatas as $key => $usersData) {



                                                $usersDatas[$key]->master = array();
                                                $usersDatas[$key]->super_master = array();
                                                $usersDatas[$key]->hyper_super_master = array();
                                                $usersDatas[$key]->admin = array();
                                                $usersDatas[$key]->super_admin = array();

                                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                $user_match_comm = 0;
                                                $user_session_comm = 0;


                                                if ($user_match_pl < 0) {
                                                    $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                }

                                                $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                if ($total_session_stake > 0) {
                                                    $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                }

                                                $total_pl = $user_match_pl + $user_session_pl;

                                                $total_comm = $user_match_comm + $user_session_comm;

                                                if ($total_pl < 0) {
                                                    $net_amt = ($total_pl + $total_comm);
                                                } else {
                                                    $net_amt = ($total_pl + $total_comm);
                                                }
                                                $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                $final_amt = $net_amt - $share_amt;


                                                if ($final_amt < 0) {
                                                    $final_amt = $final_amt * -1;
                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                } else {
                                                    $final_amt = $final_amt * -1;

                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else if ($user_type == 'Hyper Super Master') {

                        if (!empty($reportsData)) {
                            foreach ($reportsData as $report) {
                                $event_id  = $report['match_id'];

                                $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $user_id,
                                    'match_id' => $report['match_id']
                                ));


                                if (!empty($supersDatas)) {
                                    foreach ($supersDatas as $superData) {

                                        $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $superData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        if (!empty($mastersDatas)) {
                                            foreach ($mastersDatas as $masterData) {
                                                $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                    'user_id' => $masterData->user_id,
                                                    'match_id' => $report['match_id']
                                                ));


                                                $resultData[$event_id] = array(
                                                    'match_id' => $report['match_id'],
                                                    'event_name' => $report['event_name'],
                                                    'created_at' => $report['created_at'],
                                                    'p_l' => 0,
                                                );


                                                if (!empty($usersDatas)) {
                                                    foreach ($usersDatas as $key => $usersData) {



                                                        $usersDatas[$key]->master = array();
                                                        $usersDatas[$key]->super_master = array();
                                                        $usersDatas[$key]->hyper_super_master = array();
                                                        $usersDatas[$key]->admin = array();
                                                        $usersDatas[$key]->super_admin = array();

                                                        $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                        $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                        $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                        $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                        $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                        $user_match_comm = 0;
                                                        $user_session_comm = 0;


                                                        if ($user_match_pl < 0) {
                                                            $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                        }

                                                        $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                        if ($total_session_stake > 0) {
                                                            $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                        }

                                                        $total_pl = $user_match_pl + $user_session_pl;

                                                        $total_comm = $user_match_comm + $user_session_comm;

                                                        if ($total_pl < 0) {
                                                            $net_amt = ($total_pl + $total_comm);
                                                        } else {
                                                            $net_amt = ($total_pl + $total_comm);
                                                        }
                                                        $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                        $final_amt = $net_amt - $share_amt;


                                                        if ($final_amt < 0) {
                                                            $final_amt = $final_amt * -1;
                                                            $resultData[$event_id]['p_l'] += $final_amt;
                                                        } else {
                                                            $final_amt = $final_amt * -1;

                                                            $resultData[$event_id]['p_l'] += $final_amt;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else if ($user_type == 'Admin') {

                        if (!empty($reportsData)) {
                            foreach ($reportsData as $report) {
                                $event_id  = $report['match_id'];


                                $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $user_id,
                                    'match_id' => $report['match_id']
                                ));


                                if (!empty($adminsDatas)) {
                                    foreach ($adminsDatas as $adminData) {


                                        $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $adminData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        if (!empty($supersDatas)) {
                                            foreach ($supersDatas as $superData) {

                                                $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                    'user_id' => $superData->user_id,
                                                    'match_id' => $report['match_id']
                                                ));


                                                if (!empty($mastersDatas)) {
                                                    foreach ($mastersDatas as $masterData) {
                                                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                            'user_id' => $masterData->user_id,
                                                            'match_id' => $report['match_id']
                                                        ));


                                                        $resultData[$event_id] = array(
                                                            'match_id' => $report['match_id'],
                                                            'event_name' => $report['event_name'],
                                                            'created_at' => $report['created_at'],
                                                            'p_l' => 0,
                                                        );


                                                        if (!empty($usersDatas)) {
                                                            foreach ($usersDatas as $key => $usersData) {



                                                                $usersDatas[$key]->master = array();
                                                                $usersDatas[$key]->super_master = array();
                                                                $usersDatas[$key]->hyper_super_master = array();
                                                                $usersDatas[$key]->admin = array();
                                                                $usersDatas[$key]->super_admin = array();

                                                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                                $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                                $user_match_comm = 0;
                                                                $user_session_comm = 0;


                                                                if ($user_match_pl < 0) {
                                                                    $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                                }

                                                                $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                                if ($total_session_stake > 0) {
                                                                    $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                                }

                                                                $total_pl = $user_match_pl + $user_session_pl;

                                                                $total_comm = $user_match_comm + $user_session_comm;

                                                                if ($total_pl < 0) {
                                                                    $net_amt = ($total_pl + $total_comm);
                                                                } else {
                                                                    $net_amt = ($total_pl + $total_comm);
                                                                }
                                                                $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                                $final_amt = $net_amt - $share_amt;


                                                                if ($final_amt < 0) {
                                                                    $final_amt = $final_amt * -1;
                                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                                } else {
                                                                    $final_amt = $final_amt * -1;

                                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else if ($user_type == 'Super Admin') {

                        if (!empty($reportsData)) {
                            foreach ($reportsData as $report) {
                                $event_id  = $report['match_id'];
                                $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $user_id,
                                    'match_id' => $report['match_id']
                                ));




                                if (!empty($adminsDatas)) {
                                    foreach ($adminsDatas as $adminData) {

                                        $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $adminData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        if (!empty($hypersDatas)) {
                                            foreach ($hypersDatas as $hyperData) {


                                                $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                    'user_id' => $hyperData->user_id,
                                                    'match_id' => $report['match_id']
                                                ));


                                                if (!empty($supersDatas)) {
                                                    foreach ($supersDatas as $superData) {

                                                        $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                            'user_id' => $superData->user_id,
                                                            'match_id' => $report['match_id']
                                                        ));


                                                        if (!empty($mastersDatas)) {
                                                            foreach ($mastersDatas as $masterData) {
                                                                $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                                    'user_id' => $masterData->user_id,
                                                                    'match_id' => $report['match_id']
                                                                ));


                                                                $resultData[$event_id] = array(
                                                                    'match_id' => $report['match_id'],
                                                                    'event_name' => $report['event_name'],
                                                                    'created_at' => $report['created_at'],
                                                                    'p_l' => 0,
                                                                );


                                                                if (!empty($usersDatas)) {
                                                                    foreach ($usersDatas as $key => $usersData) {



                                                                        $usersDatas[$key]->master = array();
                                                                        $usersDatas[$key]->super_master = array();
                                                                        $usersDatas[$key]->hyper_super_master = array();
                                                                        $usersDatas[$key]->admin = array();
                                                                        $usersDatas[$key]->super_admin = array();

                                                                        $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                                        $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                                        $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                                        $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                                        $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                                        $user_match_comm = 0;
                                                                        $user_session_comm = 0;


                                                                        if ($user_match_pl < 0) {
                                                                            $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                                        }

                                                                        $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                                        if ($total_session_stake > 0) {
                                                                            $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                                        }

                                                                        $total_pl = $user_match_pl + $user_session_pl;

                                                                        $total_comm = $user_match_comm + $user_session_comm;

                                                                        if ($total_pl < 0) {
                                                                            $net_amt = ($total_pl + $total_comm);
                                                                        } else {
                                                                            $net_amt = ($total_pl + $total_comm);
                                                                        }
                                                                        $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                                        $final_amt = $net_amt - $share_amt;


                                                                        if ($final_amt < 0) {
                                                                            $final_amt = $final_amt * -1;
                                                                            $resultData[$event_id]['p_l'] += $final_amt;
                                                                        } else {
                                                                            $final_amt = $final_amt * -1;

                                                                            $resultData[$event_id]['p_l'] += $final_amt;
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }



                    $total_settle_amount = 0;

                    if (!empty($resultData)) {
                        foreach ($resultData as $data) {
                            if ($data['p_l'] > 0) {
                                $total_settle_amount += abs($data['p_l']);
                            } else {
                                $total_settle_amount -= abs($data['p_l']);
                            }
                        }
                    }



                    if (!empty($ledgerData)) {
                        foreach ($ledgerData as $data) {
                            if ($data['role'] == 'Parent') {
                                if ($data['transaction_type'] == 'Debit') {
                                    $total_settle_amount -= $data['amount'];
                                } else if ($data['transaction_type'] == 'Credit') {
                                    $total_settle_amount += $data['amount'];
                                }
                            }
                        }
                    }


                    $bettingArr = array(
                        'user_id' => $user->user_id,
                        'user_name' => $user->user_name,
                        'name' => $user->name,
                        'amount' => $total_settle_amount,
                        'master_comission' => 0,
                        'partnership' => 0,
                        'type' => $user_type,
                        'parent_comission' => 0,
                    );




                    // $total_settle_amount = $total_settle_amount * -1;

                    if ($total_settle_amount > 0) {
                        array_push($minusArr, $bettingArr);
                    } else {
                        array_push($plusArr, $bettingArr);
                    }
                }
            }
        }




        $dataArray['minus_acc'] = $minusArr;
        $dataArray['plus_acc'] = $plusArr;
        $dataArray['parent_name'] = $parent_name;
        $dataArray['user_type'] = $user_type;
        $dataArray['user_id'] = $user_id;
        $dataArray['user_name'] = $user_name;
        log_message("MY_INFO", 'Chip Summary Load End');



        $this->load->view('chip-summary', $dataArray);
    }

    public function myledgerold($sportid = null, $user_id = null)
    {

        // $user_id = get_user_id();
        // $user =  $this->User_model->getUserById($user_id);


        // if (!empty($user)) {
        //     if ($user->user_type == 'Master') {
        //         $usersDatas =  $this->User_model->getInnerUserByEventId(array(
        //             'user_id' => $user_id,
        //             'match_id' => $event_id
        //         ));


        //         if (!empty($usersDatas)) {
        //             foreach ($usersDatas as $key => $usersData) {



        //                 $usersDatas[$key]->master = array();
        //                 $usersDatas[$key]->super_master = array();
        //                 $usersDatas[$key]->hyper_super_master = array();
        //                 $usersDatas[$key]->admin = array();
        //                 $usersDatas[$key]->super_admin = array();

        //                 $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
        //                 $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

        //                 $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
        //                 $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


        //                 $get_user_partnership = $this->Betting_model->get_betting_info($usersData->user_id, $event_id);

        //                 $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



        //                 $user_match_comm = 0;

        //                 if ($user_match_pl < 0) {
        //                     $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
        //                 }

        //                 $usersDatas[$key]->user = array(
        //                     'match_pl' => $user_match_pl * -1,
        //                     'session_pl' => $user_session_pl * -1,
        //                     'match_comm' => $get_user_partnership->master_commission,
        //                     'sessional_commission' =>  $get_user_partnership->sessional_commission,
        //                 );

        //                 $usersDatas[$key]->master = array(
        //                     'partnership' => $get_master_partnership->partnership,
        //                     'match_comm' =>  $get_master_partnership->master_commission,
        //                     'sessional_commission' =>  $get_master_partnership->sessional_commission,
        //                 );
        //             }

        //             $user->users = $usersDatas;
        //         }
        //     }
        // }

        // $dataArray['reports'] = $user;



        // p($user);
        //////////exit
        $this->load->library('Datatable');
        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['user_id']  = $user_id;
        $dataArray['sportid']  = $sportid;
        if ($sportid != 0) {
            $dataArray['sportid']  = 5;
        }
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $search = '';
        $dataArray = array(
            'search_p_l' => $search,
            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }

        $dataArray['pstatus'] = 'Settled';


        $user_detail = $this->User_model->getUserById($user_id);
        $user_type = $user_detail->user_type;


        $dataArray['pstatus'] = 'Settled';
        $reports = array();



        $reportsData = $this->Report_model->get_my_ledger_events_list($dataArray);

        p($reportsData);


        if (!empty($reportsData)) {
            foreach ($reportsData as $report) {
                // $report['partnership'] = 0;
                $marketId = $report['market_id'];
                $betting_type = strtolower($report['betting_type']);


                if (isset($reports[$report['match_id']])) {
                    if ($betting_type == 'fancy') {
                        $market_name = 'Fancy';
                    } else {
                        $market_name = $report['market_name'];
                    }

                    $p_l = 0;

                    if ($report['bet_result'] == 'Minus') {


                        $amt = $report['client_profit'] - (($report['client_profit']) * ($report['partnership'] / 100));

                        $p_l =  $reports[$report['match_id']]['p_l'] + $amt;
                    } else if ($report['bet_result'] == 'Plus') {

                        $amt = $report['client_loss'] - (($report['client_loss']) * ($report['partnership'] / 100));
                        $p_l = $reports[$report['match_id']]['p_l'] +  $amt * -1;
                    }


                    $reports[$report['match_id']] = array(
                        'match_id' => $report['match_id'],
                        'event_name' => $report['event_name'],
                        'market_name' => $market_name,
                        'market_id' => $marketId,

                        'p_l' => $p_l,
                        'commission' => 0,
                        'created_at' => $report['created_at']
                    );
                } else {
                    if ($betting_type == 'fancy') {
                        $market_name = 'Fancy';
                    } else {
                        $market_name = $report['market_name'];
                    }


                    $p_l = 0;

                    if ($report['bet_result'] == 'Minus') {


                        $amt = $report['client_profit'] - (($report['client_profit']) * ($report['partnership'] / 100));

                        $p_l = $amt;
                    } else if ($report['bet_result'] == 'Plus') {
                        $amt = $report['client_loss'] - (($report['client_loss']) * ($report['partnership'] / 100));
                        $p_l = $amt * -1;
                    }


                    $reports[$report['match_id']] = array(
                        'match_id' => $report['match_id'],
                        'event_name' => $report['event_name'],
                        'market_name' => $market_name,
                        'market_id' => $marketId,

                        'p_l' => $p_l,
                        'commission' => 0,
                        'created_at' => $report['created_at']
                    );
                }
            }
        }


        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;
        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_DESC, $reports);
        $dataArray['reports'] = $reports;

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );


        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $dataArray['profit_loss']  = $this->load->viewPartial('/my-ledger-list-html', $dataArray);
        $this->load->view('/my-ledger', $dataArray);
    }

    public function myledger($sportid = null, $user_id = null)
    {


        $this->load->library('Datatable');
        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['user_id']  = $user_id;
        $dataArray['sportid']  = $sportid;
        if ($sportid != 0) {
            $dataArray['sportid']  = 5;
        }
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $search = '';
        $dataArray = array(
            'search_p_l' => $search,
            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }

        $dataArray['pstatus'] = 'Settled';


        $user_detail = $this->User_model->getUserById($user_id);
        $user_type = $user_detail->user_type;


        $dataArray['pstatus'] = 'Settled';
        $reports = array();



        $reportsData = $this->Report_model->get_my_ledger_events_list($dataArray);
        $resultData = array();

        $ledgerData = $this->Ledger_model->get_ledger(array(
            'fltrselct' => 2,
            'user_id' => $user_id
        ));



        if ($user_type == 'Master') {


            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];
                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    $resultData[$event_id] = array(
                        'match_id' => $report['match_id'],
                        'event_name' => $report['event_name'],
                        'created_at' => $report['created_at'],
                        'p_l' => 0,
                    );


                    if (!empty($usersDatas)) {
                        foreach ($usersDatas as $key => $usersData) {



                            $usersDatas[$key]->master = array();
                            $usersDatas[$key]->super_master = array();
                            $usersDatas[$key]->hyper_super_master = array();
                            $usersDatas[$key]->admin = array();
                            $usersDatas[$key]->super_admin = array();

                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);



                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                            $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                            $user_match_comm = 0;
                            // $user_session_comm = 0;


                            if ($user_match_pl < 0) {
                                $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                            }


                            $total_pl = $user_match_pl + $user_session_pl;

                            $total_comm = $user_match_comm + $user_session_comm;

                            if ($total_pl < 0) {
                                $net_amt = ($total_pl + $total_comm);
                            } else {
                                $net_amt = ($total_pl - $total_comm);
                            }
                            $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                            $final_amt = $net_amt - $share_amt;


                            if ($final_amt < 0) {
                                $final_amt = $final_amt * -1;
                                $resultData[$event_id]['p_l'] += $final_amt;
                            } else {
                                $final_amt = $final_amt * -1;

                                $resultData[$event_id]['p_l'] += $final_amt;
                            }
                        }
                    }
                }
            }


            // p($resultData);
        } else if ($user_type == 'Super Master') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];
                    $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    if (!empty($mastersDatas)) {
                        foreach ($mastersDatas as $masterData) {
                            $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $masterData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            $resultData[$event_id] = array(
                                'match_id' => $report['match_id'],
                                'event_name' => $report['event_name'],
                                'created_at' => $report['created_at'],
                                'p_l' => 0,
                            );


                            if (!empty($usersDatas)) {
                                foreach ($usersDatas as $key => $usersData) {



                                    $usersDatas[$key]->master = array();
                                    $usersDatas[$key]->super_master = array();
                                    $usersDatas[$key]->hyper_super_master = array();
                                    $usersDatas[$key]->admin = array();
                                    $usersDatas[$key]->super_admin = array();

                                    $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                    $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                    $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                    $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                    $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                    $user_match_comm = 0;
                                    // $user_session_comm = 0;


                                    if ($user_match_pl < 0) {
                                        $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                    }


                                    $total_pl = $user_match_pl + $user_session_pl;

                                    $total_comm = $user_match_comm + $user_session_comm;

                                    if ($total_pl < 0) {
                                        $net_amt = ($total_pl + $total_comm);
                                    } else {
                                        $net_amt = ($total_pl - $total_comm);
                                    }
                                    $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                    $final_amt = $net_amt - $share_amt;


                                    if ($final_amt < 0) {
                                        $final_amt = $final_amt * -1;
                                        $resultData[$event_id]['p_l'] += $final_amt;
                                    } else {
                                        $final_amt = $final_amt * -1;

                                        $resultData[$event_id]['p_l'] += $final_amt;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } else if ($user_type == 'Hyper Super Master') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];

                    $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    if (!empty($supersDatas)) {
                        foreach ($supersDatas as $superData) {

                            $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $superData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            if (!empty($mastersDatas)) {
                                foreach ($mastersDatas as $masterData) {
                                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $masterData->user_id,
                                        'match_id' => $report['match_id']
                                    ));


                                    $resultData[$event_id] = array(
                                        'match_id' => $report['match_id'],
                                        'event_name' => $report['event_name'],
                                        'created_at' => $report['created_at'],
                                        'p_l' => 0,
                                    );


                                    if (!empty($usersDatas)) {
                                        foreach ($usersDatas as $key => $usersData) {



                                            $usersDatas[$key]->master = array();
                                            $usersDatas[$key]->super_master = array();
                                            $usersDatas[$key]->hyper_super_master = array();
                                            $usersDatas[$key]->admin = array();
                                            $usersDatas[$key]->super_admin = array();

                                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                            $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                            $user_match_comm = 0;
                                            // $user_session_comm = 0;


                                            if ($user_match_pl < 0) {
                                                $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                            }


                                            $total_pl = $user_match_pl + $user_session_pl;

                                            $total_comm = $user_match_comm + $user_session_comm;

                                            if ($total_pl < 0) {
                                                $net_amt = ($total_pl + $total_comm);
                                            } else {
                                                $net_amt = ($total_pl - $total_comm);
                                            }
                                            $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                            $final_amt = $net_amt - $share_amt;


                                            if ($final_amt < 0) {
                                                $final_amt = $final_amt * -1;
                                                $resultData[$event_id]['p_l'] += $final_amt;
                                            } else {
                                                $final_amt = $final_amt * -1;

                                                $resultData[$event_id]['p_l'] += $final_amt;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } else if ($user_type == 'Admin') {

            // if (!empty($reportsData)) {
            //     foreach ($reportsData as $report) {
            //         $event_id  = $report['match_id'];


            //         $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
            //             'user_id' => $user_id,
            //             'match_id' => $report['match_id']
            //         ));


 
            //         if (!empty($adminsDatas)) {
            //             foreach ($adminsDatas as $adminData) {


            //                 $supersDatas =  $this->User_model->getInnerUserByEventId(array(
            //                     'user_id' => $adminData->user_id,
            //                     'match_id' => $report['match_id']
            //                 ));


            //                 if (!empty($supersDatas)) {
            //                     foreach ($supersDatas as $superData) {

            //                         $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
            //                             'user_id' => $superData->user_id,
            //                             'match_id' => $report['match_id']
            //                         ));


            //                         if (!empty($mastersDatas)) {
            //                             foreach ($mastersDatas as $masterData) {
            //                                 $usersDatas =  $this->User_model->getInnerUserByEventId(array(
            //                                     'user_id' => $masterData->user_id,
            //                                     'match_id' => $report['match_id']
            //                                 ));


            //                                 $resultData[$event_id] = array(
            //                                     'match_id' => $report['match_id'],
            //                                     'event_name' => $report['event_name'],
            //                                     'created_at' => $report['created_at'],
            //                                     'p_l' => 0,
            //                                 );


            //                                 if (!empty($usersDatas)) {
            //                                     foreach ($usersDatas as $key => $usersData) {



            //                                         $usersDatas[$key]->master = array();
            //                                         $usersDatas[$key]->super_master = array();
            //                                         $usersDatas[$key]->hyper_super_master = array();
            //                                         $usersDatas[$key]->admin = array();
            //                                         $usersDatas[$key]->super_admin = array();

            //                                         $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
            //                                         $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


            //                                         $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
            //                                         $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


 


            //                                         $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



            //                                         $user_match_comm = 0;
            //                                         // $user_session_comm = 0;
 
                                                   
            //                                          if ($user_match_pl < 0) {

                                                         
            //                                             $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
            //                                         }


 
            //                                         $total_pl = $user_match_pl + $user_session_pl;

            //                                         $total_comm = $user_match_comm + $user_session_comm;


            //                                          if ($total_pl < 0) {
            //                                             $net_amt = ($total_pl + $total_comm);
            //                                         } else {
            //                                             $net_amt = ($total_pl - $total_comm);
            //                                         }
            //                                         $share_amt = $net_amt *  $get_master_partnership->partnership / 100;


            //                                         // p($net_amt);


            //                                         $final_amt = $net_amt - $share_amt;


            //                                         if ($final_amt < 0) {
            //                                             $final_amt = $final_amt * -1;
            //                                             $resultData[$event_id]['p_l'] += $final_amt;
            //                                         } else {
            //                                             $final_amt = $final_amt * -1;

            //                                             $resultData[$event_id]['p_l'] += $final_amt;
            //                                         }
            //                                     }
            //                                 }
            //                             }
            //                         }
            //                     }
            //                 }
            //             }
            //         }
            //     }
            // }

            $dataArray['user_id']  = $user_id;
            $dataArray['pstatus'] = 'Settled';

            
            $reportsData = $this->Report_model->get_my_ledger_events_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];


                    $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    if (!empty($adminsDatas)) {
                        foreach ($adminsDatas as $adminData) {


                            $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $adminData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            if (!empty($supersDatas)) {
                                foreach ($supersDatas as $superData) {

                                    $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $superData->user_id,
                                        'match_id' => $report['match_id']
                                    ));


                                    if (!empty($mastersDatas)) {
                                        foreach ($mastersDatas as $masterData) {
                                            $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                'user_id' => $masterData->user_id,
                                                'match_id' => $report['match_id']
                                            ));


                                            $resultData[$event_id] = array(
                                                'match_id' => $report['match_id'],
                                                'event_name' => $report['event_name'],
                                                'created_at' => $report['created_at'],
                                                'p_l' => 0,
                                            );


                                            if (!empty($usersDatas)) {
                                                foreach ($usersDatas as $key => $usersData) {



                                                    $usersDatas[$key]->master = array();
                                                    $usersDatas[$key]->super_master = array();
                                                    $usersDatas[$key]->hyper_super_master = array();
                                                    $usersDatas[$key]->admin = array();
                                                    $usersDatas[$key]->super_admin = array();

                                                    $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                    $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                    $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                    $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                    $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                    $user_match_comm = 0;
                                                    $user_session_comm = 0;


                                                    if ($user_match_pl < 0) {
                                                        $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                    }

                                                    $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                    if ($total_session_stake > 0) {
                                                        $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                    }


                                                    $total_pl = $user_match_pl + $user_session_pl;

                                                    $total_comm = $user_match_comm + $user_session_comm;

                                                    if ($total_pl < 0) {
                                                        $net_amt = ($total_pl + $total_comm);
                                                    } else {
                                                        $net_amt = ($total_pl + $total_comm);
                                                    }
                                                    $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                    $final_amt = $net_amt - $share_amt;


                                                    if ($final_amt < 0) {
                                                        $final_amt = $final_amt * -1;
                                                        $resultData[$event_id]['p_l'] += $final_amt;
                                                    } else {
                                                        $final_amt = $final_amt * -1;

                                                        $resultData[$event_id]['p_l'] += $final_amt;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

         } else if ($user_type == 'Super Admin') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];
                    $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));




                    if (!empty($adminsDatas)) {
                        foreach ($adminsDatas as $adminData) {

                            $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $adminData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            if (!empty($hypersDatas)) {
                                foreach ($hypersDatas as $hyperData) {


                                    $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $hyperData->user_id,
                                        'match_id' => $report['match_id']
                                    ));


                                    if (!empty($supersDatas)) {
                                        foreach ($supersDatas as $superData) {

                                            $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                'user_id' => $superData->user_id,
                                                'match_id' => $report['match_id']
                                            ));


                                            if (!empty($mastersDatas)) {
                                                foreach ($mastersDatas as $masterData) {
                                                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                        'user_id' => $masterData->user_id,
                                                        'match_id' => $report['match_id']
                                                    ));


                                                    $resultData[$event_id] = array(
                                                        'match_id' => $report['match_id'],
                                                        'event_name' => $report['event_name'],
                                                        'created_at' => $report['created_at'],
                                                        'p_l' => 0,
                                                    );


                                                    if (!empty($usersDatas)) {
                                                        foreach ($usersDatas as $key => $usersData) {



                                                            $usersDatas[$key]->master = array();
                                                            $usersDatas[$key]->super_master = array();
                                                            $usersDatas[$key]->hyper_super_master = array();
                                                            $usersDatas[$key]->admin = array();
                                                            $usersDatas[$key]->super_admin = array();

                                                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                            $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                            $user_match_comm = 0;
                                                            // $user_session_comm = 0;


                                                            if ($user_match_pl < 0) {
                                                                $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                            }


                                                            $total_pl = $user_match_pl + $user_session_pl;

                                                            $total_comm = $user_match_comm + $user_session_comm;

                                                            if ($total_pl < 0) {
                                                                $net_amt = ($total_pl + $total_comm);
                                                            } else {
                                                                $net_amt = ($total_pl - $total_comm);
                                                            }
                                                            $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                            $final_amt = $net_amt - $share_amt;


                                                            if ($final_amt < 0) {
                                                                $final_amt = $final_amt * -1;
                                                                $resultData[$event_id]['p_l'] += $final_amt;
                                                            } else {
                                                                $final_amt = $final_amt * -1;

                                                                $resultData[$event_id]['p_l'] += $final_amt;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        $reports = array_merge($reports, $ledgerData);
        $reports = array_merge($reports, $resultData);


        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_DESC, $reports);
        $dataArray['reports'] = $reports;


        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );


        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $dataArray['profit_loss']  = $this->load->viewPartial('/my-ledger-list-html', $dataArray);
        $this->load->view('/my-ledger', $dataArray);
    }

    public function myledgerx($sportid = null, $user_id = null)
    {


        $this->load->library('Datatable');
        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['user_id']  = $user_id;
        $dataArray['sportid']  = $sportid;
        if ($sportid != 0) {
            $dataArray['sportid']  = 5;
        }
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $search = '';
        $dataArray = array(
            'search_p_l' => $search,
            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }

        $dataArray['pstatus'] = 'Settled';


        $user_detail = $this->User_model->getUserById($user_id);
        $user_type = $user_detail->user_type;


        $dataArray['pstatus'] = 'Settled';
        $reports = array();



        $reportsData = $this->Report_model->get_my_ledger_events_list($dataArray);
        $resultData = array();




        if ($user_type == 'Master') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {

                    // i


                    $event_id  = $report['match_id'];


                    // if($event_id != '30849966')
                    // {
                    //     continue;
                    // }

                    if (!$resultData[$event_id]) {
                        $resultData[$event_id] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'created_at' => $report['created_at'],
                            'p_l' => 0,
                        );
                    }


                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));




                    if (!empty($usersDatas)) {
                        foreach ($usersDatas as $key => $usersData) {



                            $usersDatas[$key]->master = array();
                            $usersDatas[$key]->super_master = array();
                            $usersDatas[$key]->hyper_super_master = array();
                            $usersDatas[$key]->admin = array();
                            $usersDatas[$key]->super_admin = array();

                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                            // if($event_id == '30857685')
                            // {
                            //     p($user_match_pl,0);
                            // }

                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                            $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);






                            $user_match_comm = 0;
                            $user_session_comm = 0;


                            if ($user_match_pl < 0) {
                                $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                            }


                            // p()
                            $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                            if ($total_session_stake > 0) {
                                $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                            }

                            $total_pl = $user_match_pl + $user_session_pl;

                            $total_comm = $user_match_comm + $user_session_comm;

                            if ($total_pl < 0) {
                                $net_amt = ($total_pl + $total_comm);
                            } else {
                                $net_amt = ($total_pl + $total_comm);
                            }
                            $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                            $final_amt = $net_amt - $share_amt;


                            if ($final_amt < 0) {
                                $final_amt = $final_amt * -1;
                                $resultData[$event_id]['p_l'] += $final_amt;
                            } else {
                                $final_amt = $final_amt * -1;

                                $resultData[$event_id]['p_l'] += $final_amt;
                            }
                        }
                    }
                }
            }


            // p($resultData);
        } else if ($user_type == 'Super Master') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];


                    $resultData[$event_id] = array(
                        'match_id' => $report['match_id'],
                        'event_name' => $report['event_name'],
                        'created_at' => $report['created_at'],
                        'p_l' => 0,
                    );


                    $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    if (!empty($mastersDatas)) {
                        foreach ($mastersDatas as $masterData) {
                            $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $masterData->user_id,
                                'match_id' => $report['match_id']
                            ));



                            if (!empty($usersDatas)) {
                                foreach ($usersDatas as $key => $usersData) {



                                    $usersDatas[$key]->master = array();
                                    $usersDatas[$key]->super_master = array();
                                    $usersDatas[$key]->hyper_super_master = array();
                                    $usersDatas[$key]->admin = array();
                                    $usersDatas[$key]->super_admin = array();

                                    $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                    $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                    $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                    $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                    $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                    $user_match_comm = 0;
                                    $user_session_comm = 0;


                                    if ($user_match_pl < 0) {
                                        $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                    }


                                    $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                    if ($total_session_stake > 0) {
                                        $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                    }


                                    $total_pl = $user_match_pl + $user_session_pl;

                                    $total_comm = $user_match_comm + $user_session_comm;

                                    if ($total_pl < 0) {
                                        $net_amt = ($total_pl + $total_comm);
                                    } else {
                                        $net_amt = ($total_pl + $total_comm);
                                    }
                                    $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                    $final_amt = $net_amt - $share_amt;


                                    if ($final_amt < 0) {
                                        $final_amt = $final_amt * -1;
                                        $resultData[$event_id]['p_l'] += $final_amt;
                                    } else {
                                        $final_amt = $final_amt * -1;

                                        $resultData[$event_id]['p_l'] += $final_amt;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } else if ($user_type == 'Hyper Super Master') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];

                    $resultData[$event_id] = array(
                        'match_id' => $report['match_id'],
                        'event_name' => $report['event_name'],
                        'created_at' => $report['created_at'],
                        'p_l' => 0,
                    );

                    $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    if (!empty($supersDatas)) {
                        foreach ($supersDatas as $superData) {

                            $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $superData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            if (!empty($mastersDatas)) {
                                foreach ($mastersDatas as $masterData) {
                                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $masterData->user_id,
                                        'match_id' => $report['match_id']
                                    ));





                                    if (!empty($usersDatas)) {
                                        foreach ($usersDatas as $key => $usersData) {



                                            $usersDatas[$key]->master = array();
                                            $usersDatas[$key]->super_master = array();
                                            $usersDatas[$key]->hyper_super_master = array();
                                            $usersDatas[$key]->admin = array();
                                            $usersDatas[$key]->super_admin = array();

                                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                            $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                            $user_match_comm = 0;
                                            $user_session_comm = 0;


                                            if ($user_match_pl < 0) {
                                                $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                            }

                                            $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                            if ($total_session_stake > 0) {
                                                $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                            }

                                            $total_pl = $user_match_pl + $user_session_pl;

                                            $total_comm = $user_match_comm + $user_session_comm;

                                            if ($total_pl < 0) {
                                                $net_amt = ($total_pl + $total_comm);
                                            } else {
                                                $net_amt = ($total_pl + $total_comm);
                                            }
                                            $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                            $final_amt = $net_amt - $share_amt;


                                            if ($final_amt < 0) {
                                                $final_amt = $final_amt * -1;
                                                $resultData[$event_id]['p_l'] += $final_amt;
                                            } else {
                                                $final_amt = $final_amt * -1;

                                                $resultData[$event_id]['p_l'] += $final_amt;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } else if ($user_type == 'Admin') {


            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {

                    $event_id  = $report['match_id'];

                    $resultData[$event_id] = array(
                        'match_id' => $report['match_id'],
                        'event_name' => $report['event_name'],
                        'created_at' => $report['created_at'],
                        'p_l' => 0,
                    );
                    $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));


                    if (!empty($adminsDatas)) {
                        foreach ($adminsDatas as $adminData) {


                            $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $adminData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            if (!empty($supersDatas)) {
                                foreach ($supersDatas as $superData) {

                                    $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $superData->user_id,
                                        'match_id' => $report['match_id']
                                    ));


                                    if (!empty($mastersDatas)) {
                                        foreach ($mastersDatas as $masterData) {
                                            $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                'user_id' => $masterData->user_id,
                                                'match_id' => $report['match_id']
                                            ));




                                            if (!empty($usersDatas)) {
                                                foreach ($usersDatas as $key => $usersData) {


                                                    $usersDatas[$key]->master = array();
                                                    $usersDatas[$key]->super_master = array();
                                                    $usersDatas[$key]->hyper_super_master = array();
                                                    $usersDatas[$key]->admin = array();
                                                    $usersDatas[$key]->super_admin = array();

                                                    $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                    $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                    $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                    $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                    $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                    $user_match_comm = 0;
                                                    $user_session_comm = 0;


                                                    if ($user_match_pl < 0) {
                                                        $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                    }

                                                    $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                    if ($total_session_stake > 0) {
                                                        $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                    }


                                                    //  


                                                    $total_pl = $user_match_pl + $user_session_pl;

                                                    $total_comm = $user_match_comm + $user_session_comm;

                                                    if ($total_pl < 0) {
                                                        $net_amt = ($total_pl + $total_comm);
                                                    } else {
                                                        $net_amt = ($total_pl + $total_comm);
                                                    }





                                                    // p($net_amt);
                                                    $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                    $final_amt = $net_amt - $share_amt;


                                                    if ($final_amt < 0) {
                                                        $final_amt = $final_amt * -1;
                                                        $resultData[$event_id]['p_l'] = $resultData[$event_id]['p_l'] + $final_amt;
                                                    } else {
                                                        $final_amt = $final_amt * -1;

                                                        $resultData[$event_id]['p_l'] += $final_amt;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } else if ($user_type == 'Super Admin') {

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $event_id  = $report['match_id'];
                    $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                        'user_id' => $user_id,
                        'match_id' => $report['match_id']
                    ));




                    if (!empty($adminsDatas)) {
                        foreach ($adminsDatas as $adminData) {

                            $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $adminData->user_id,
                                'match_id' => $report['match_id']
                            ));


                            if (!empty($hypersDatas)) {
                                foreach ($hypersDatas as $hyperData) {


                                    $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $hyperData->user_id,
                                        'match_id' => $report['match_id']
                                    ));


                                    if (!empty($supersDatas)) {
                                        foreach ($supersDatas as $superData) {

                                            $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                'user_id' => $superData->user_id,
                                                'match_id' => $report['match_id']
                                            ));


                                            if (!empty($mastersDatas)) {
                                                foreach ($mastersDatas as $masterData) {
                                                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                        'user_id' => $masterData->user_id,
                                                        'match_id' => $report['match_id']
                                                    ));


                                                    $resultData[$event_id] = array(
                                                        'match_id' => $report['match_id'],
                                                        'event_name' => $report['event_name'],
                                                        'created_at' => $report['created_at'],
                                                        'p_l' => 0,
                                                    );


                                                    if (!empty($usersDatas)) {
                                                        foreach ($usersDatas as $key => $usersData) {



                                                            $usersDatas[$key]->master = array();
                                                            $usersDatas[$key]->super_master = array();
                                                            $usersDatas[$key]->hyper_super_master = array();
                                                            $usersDatas[$key]->admin = array();
                                                            $usersDatas[$key]->super_admin = array();

                                                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                            $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                            $user_match_comm = 0;
                                                            $user_session_comm = 0;


                                                            if ($user_match_pl < 0) {
                                                                $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                            }

                                                            $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                            if ($total_session_stake > 0) {
                                                                $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                            }

                                                            $total_pl = $user_match_pl + $user_session_pl;

                                                            $total_comm = $user_match_comm + $user_session_comm;

                                                            if ($total_pl < 0) {
                                                                $net_amt = ($total_pl + $total_comm);
                                                            } else {
                                                                $net_amt = ($total_pl + $total_comm);
                                                            }
                                                            $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                            $final_amt = $net_amt - $share_amt;


                                                            if ($final_amt < 0) {
                                                                $final_amt = $final_amt * -1;
                                                                $resultData[$event_id]['p_l'] += $final_amt;
                                                            } else {
                                                                $final_amt = $final_amt * -1;

                                                                $resultData[$event_id]['p_l'] += $final_amt;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        array_multisort(array_map('strtotime', array_column($resultData, 'created_at')), SORT_DESC, $resultData);
        $dataArray['reports'] = $resultData;

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );


        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $dataArray['profit_loss']  = $this->load->viewPartial('/my-ledger-list-html', $dataArray);
        $this->load->view('/my-ledger', $dataArray);
    }



    public function getClientTransaction()
    {


        $this->load->library('Datatable');

        $user_id = $this->input->post('user_id');

        $dataArray['user_id']  = $user_id;
        $dataArray['pstatus'] = 'Settled';


        $user_detail = $this->User_model->getUserById($user_id);

        $dataArray['pstatus'] = 'Settled';
        $reports = array();





        $ledgerData = $this->Ledger_model->get_ledger(array(
            'fltrselct' => 2,
            'user_id' => $user_id
        ));






        if ($user_detail->user_type == 'User') {
            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $amt = $report['client_loss'] * -1;
                            $p_l =  $reports[$report['match_id']]['p_l'] + $amt;
                        } else if ($report['bet_result'] == 'Plus') {

                            $amt = $report['client_profit'];
                            $p_l = $reports[$report['match_id']]['p_l'] +  $amt;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'user_type' => $user_detail->user_type,
                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;



                        if ($report['bet_result'] == 'Minus') {


                            $amt = $report['client_loss'] * -1;

                            $p_l = $amt;
                        } else if ($report['bet_result'] == 'Plus') {
                            $amt = $report['client_profit'];
                            $p_l = $amt;
                        }


                        $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));


                        if (!empty($getCommssion)) {

                            if ($p_l < 0) {
                                $p_l =  $p_l + $getCommssion->total_commission;
                            } else {
                                $p_l =  $p_l - $getCommssion->total_commission;
                            }
                        }




                        // p($getCommssion);

                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'user_type' => $user_detail->user_type,

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }


                $reports = array_merge($reports, $ledgerData);
            }
        } else {

            // $reportsData = $this->Betting_model->get_master_transaction_details($user_id);


            // if (!empty($reportsData)) {

            //     foreach ($reportsData as $report) {


            //         $reports[$report['match_id']] = array(
            //             'match_id' => $report['match_id'],
            //             'event_name' => $report['event_name'],
            //             // 'market_name' => $market_name,
            //             // 'market_id' => $marketId,
            //             'user_type' => $user_detail->user_type,

            //             'p_l' => $report['profit'],
            //             'commission' => 0,
            //             'created_at' => ''
            //         );
            //     }
            // }    


            // p($reports);

            $user_type = $user_detail->user_type;

            $resultData = array();
            $reportsData = $this->Report_model->get_my_ledger_events_list($dataArray);


            if ($user_type == 'Master') {
                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $event_id  = $report['match_id'];
                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));


                        $resultData[$event_id] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $report['market_name'],
                            'market_id' => $report['market_id'],
                            'user_type' => $user_type,
                            'commission' => 0,
                            'created_at' => $report['created_at'],
                            'p_l' => 0,
                        );


                        if (!empty($usersDatas)) {
                            foreach ($usersDatas as $key => $usersData) {



                                $usersDatas[$key]->master = array();
                                $usersDatas[$key]->super_master = array();
                                $usersDatas[$key]->hyper_super_master = array();
                                $usersDatas[$key]->admin = array();
                                $usersDatas[$key]->super_admin = array();

                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                $user_match_comm = 0;
                                $user_session_comm = 0;


                                if ($user_match_pl < 0) {
                                    $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                }

                                $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                if ($total_session_stake > 0) {
                                    $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                }

                                $total_pl = $user_match_pl + $user_session_pl;

                                $total_comm = $user_match_comm + $user_session_comm;

                                if ($total_pl < 0) {
                                    $net_amt = ($total_pl + $total_comm);
                                } else {
                                    $net_amt = ($total_pl + $total_comm);
                                }
                                $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                $final_amt = $net_amt - $share_amt;


                                if ($final_amt < 0) {
                                    $final_amt = $final_amt * -1;
                                    $resultData[$event_id]['p_l'] += $final_amt;
                                } else {
                                    $final_amt = $final_amt * -1;

                                    $resultData[$event_id]['p_l'] += $final_amt;
                                }
                            }
                        }
                    }
                }
            } else if ($user_type == 'Super Master') {

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $event_id  = $report['match_id'];
                        $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));


                        if (!empty($mastersDatas)) {
                            foreach ($mastersDatas as $masterData) {
                                $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $masterData->user_id,
                                    'match_id' => $report['match_id']
                                ));


                                $resultData[$event_id] = array(
                                    'match_id' => $report['match_id'],
                                    'event_name' => $report['event_name'],
                                    'created_at' => $report['created_at'],
                                    'p_l' => 0,
                                );


                                if (!empty($usersDatas)) {
                                    foreach ($usersDatas as $key => $usersData) {



                                        $usersDatas[$key]->master = array();
                                        $usersDatas[$key]->super_master = array();
                                        $usersDatas[$key]->hyper_super_master = array();
                                        $usersDatas[$key]->admin = array();
                                        $usersDatas[$key]->super_admin = array();

                                        $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                        $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                        $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                        $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                        $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                        $user_match_comm = 0;
                                        $user_session_comm = 0;


                                        if ($user_match_pl < 0) {
                                            $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                        }

                                        $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                        if ($total_session_stake > 0) {
                                            $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                        }

                                        $total_pl = $user_match_pl + $user_session_pl;

                                        $total_comm = $user_match_comm + $user_session_comm;

                                        if ($total_pl < 0) {
                                            $net_amt = ($total_pl + $total_comm);
                                        } else {
                                            $net_amt = ($total_pl + $total_comm);
                                        }
                                        $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                        $final_amt = $net_amt - $share_amt;


                                        if ($final_amt < 0) {
                                            $final_amt = $final_amt * -1;
                                            $resultData[$event_id]['p_l'] += $final_amt;
                                        } else {
                                            $final_amt = $final_amt * -1;

                                            $resultData[$event_id]['p_l'] += $final_amt;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } else if ($user_type == 'Hyper Super Master') {

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $event_id  = $report['match_id'];

                        $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));


                        if (!empty($supersDatas)) {
                            foreach ($supersDatas as $superData) {

                                $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $superData->user_id,
                                    'match_id' => $report['match_id']
                                ));


                                if (!empty($mastersDatas)) {
                                    foreach ($mastersDatas as $masterData) {
                                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $masterData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        $resultData[$event_id] = array(
                                            'match_id' => $report['match_id'],
                                            'event_name' => $report['event_name'],
                                            'created_at' => $report['created_at'],
                                            'p_l' => 0,
                                        );


                                        if (!empty($usersDatas)) {
                                            foreach ($usersDatas as $key => $usersData) {



                                                $usersDatas[$key]->master = array();
                                                $usersDatas[$key]->super_master = array();
                                                $usersDatas[$key]->hyper_super_master = array();
                                                $usersDatas[$key]->admin = array();
                                                $usersDatas[$key]->super_admin = array();

                                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                $user_match_comm = 0;
                                                $user_session_comm = 0;


                                                if ($user_match_pl < 0) {
                                                    $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                }


                                                $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                if ($total_session_stake > 0) {
                                                    $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                }


                                                // if($event_id == '30837295')
                                                // {
                                                //     p($total_session_stake);

                                                // }

                                                $total_pl = $user_match_pl + $user_session_pl;

                                                $total_comm = $user_match_comm + $user_session_comm;

                                                if ($total_pl < 0) {
                                                    $net_amt = ($total_pl + $total_comm);
                                                } else {
                                                    $net_amt = ($total_pl + $total_comm);
                                                }
                                                $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                $final_amt = $net_amt - $share_amt;


                                                if ($final_amt < 0) {
                                                    $final_amt = $final_amt * -1;
                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                } else {
                                                    $final_amt = $final_amt * -1;

                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } else if ($user_type == 'Admin') {

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $event_id  = $report['match_id'];


                        $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));


                        if (!empty($adminsDatas)) {
                            foreach ($adminsDatas as $adminData) {


                                $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $adminData->user_id,
                                    'match_id' => $report['match_id']
                                ));


                                if (!empty($supersDatas)) {
                                    foreach ($supersDatas as $superData) {

                                        $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $superData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        if (!empty($mastersDatas)) {
                                            foreach ($mastersDatas as $masterData) {
                                                $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                    'user_id' => $masterData->user_id,
                                                    'match_id' => $report['match_id']
                                                ));


                                                $resultData[$event_id] = array(
                                                    'match_id' => $report['match_id'],
                                                    'event_name' => $report['event_name'],
                                                    'created_at' => $report['created_at'],
                                                    'p_l' => 0,
                                                );


                                                if (!empty($usersDatas)) {
                                                    foreach ($usersDatas as $key => $usersData) {



                                                        $usersDatas[$key]->master = array();
                                                        $usersDatas[$key]->super_master = array();
                                                        $usersDatas[$key]->hyper_super_master = array();
                                                        $usersDatas[$key]->admin = array();
                                                        $usersDatas[$key]->super_admin = array();

                                                        $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                        $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                        $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                        $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                        $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                        $user_match_comm = 0;
                                                        $user_session_comm = 0;


                                                        if ($user_match_pl < 0) {
                                                            $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                        }

                                                        $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                        if ($total_session_stake > 0) {
                                                            $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                        }


                                                        $total_pl = $user_match_pl + $user_session_pl;

                                                        $total_comm = $user_match_comm + $user_session_comm;

                                                        if ($total_pl < 0) {
                                                            $net_amt = ($total_pl + $total_comm);
                                                        } else {
                                                            $net_amt = ($total_pl + $total_comm);
                                                        }
                                                        $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                        $final_amt = $net_amt - $share_amt;


                                                        if ($final_amt < 0) {
                                                            $final_amt = $final_amt * -1;
                                                            $resultData[$event_id]['p_l'] += $final_amt;
                                                        } else {
                                                            $final_amt = $final_amt * -1;

                                                            $resultData[$event_id]['p_l'] += $final_amt;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } else if ($user_type == 'Super Admin') {

                if (!empty($reportsData)) {
                    foreach ($reportsData as $report) {
                        $event_id  = $report['match_id'];
                        $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));




                        if (!empty($adminsDatas)) {
                            foreach ($adminsDatas as $adminData) {

                                $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $adminData->user_id,
                                    'match_id' => $report['match_id']
                                ));


                                if (!empty($hypersDatas)) {
                                    foreach ($hypersDatas as $hyperData) {


                                        $supersDatas =  $this->User_model->getInnerUserByEventId(array(
                                            'user_id' => $hyperData->user_id,
                                            'match_id' => $report['match_id']
                                        ));


                                        if (!empty($supersDatas)) {
                                            foreach ($supersDatas as $superData) {

                                                $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                    'user_id' => $superData->user_id,
                                                    'match_id' => $report['match_id']
                                                ));


                                                if (!empty($mastersDatas)) {
                                                    foreach ($mastersDatas as $masterData) {
                                                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                            'user_id' => $masterData->user_id,
                                                            'match_id' => $report['match_id']
                                                        ));


                                                        $resultData[$event_id] = array(
                                                            'match_id' => $report['match_id'],
                                                            'event_name' => $report['event_name'],
                                                            'created_at' => $report['created_at'],
                                                            'p_l' => 0,
                                                        );


                                                        if (!empty($usersDatas)) {
                                                            foreach ($usersDatas as $key => $usersData) {



                                                                $usersDatas[$key]->master = array();
                                                                $usersDatas[$key]->super_master = array();
                                                                $usersDatas[$key]->hyper_super_master = array();
                                                                $usersDatas[$key]->admin = array();
                                                                $usersDatas[$key]->super_admin = array();

                                                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);


                                                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);




                                                                $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



                                                                $user_match_comm = 0;
                                                                $user_session_comm = 0;


                                                                if ($user_match_pl < 0) {
                                                                    $user_match_comm = abs($user_match_pl) * $get_master_partnership->master_commission / 100;
                                                                }

                                                                $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);
                                                                if ($total_session_stake > 0) {
                                                                    $user_session_comm = abs($total_session_stake) * $get_master_partnership->sessional_commission / 100;
                                                                }

                                                                $total_pl = $user_match_pl + $user_session_pl;

                                                                $total_comm = $user_match_comm + $user_session_comm;

                                                                if ($total_pl < 0) {
                                                                    $net_amt = ($total_pl + $total_comm);
                                                                } else {
                                                                    $net_amt = ($total_pl + $total_comm);
                                                                }
                                                                $share_amt = $net_amt *  $get_master_partnership->partnership / 100;



                                                                $final_amt = $net_amt - $share_amt;


                                                                if ($final_amt < 0) {
                                                                    $final_amt = $final_amt * -1;
                                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                                } else {
                                                                    $final_amt = $final_amt * -1;

                                                                    $resultData[$event_id]['p_l'] += $final_amt;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }



            $reports = array_merge($reports, $ledgerData);

            $reports = array_merge($reports, $resultData);

            // p($reports);
        }


        // p($reports);

        // p($reports);
        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_DESC, $reports);
        $dataArray['reports'] = $reports;

        $total_dena = 0;
        $total_lena = 0;

        $html = $this->load->viewPartial('/client-account-txn-html', $dataArray);

        echo json_encode($html);
    }


    public function addsettlementNew()
    {

        $chips = $this->input->post('chips');
        $narration = $this->input->post('narration');
        $userId = $this->input->post('userId');
        $CrDr = $this->input->post('CrDr');
        $user_detail = $this->User_model->getUserById($userId);


        $masterId =  $user_detail->master_id;

        $master_detail = $this->User_model->getUserById($masterId);


        $user_chip = count_total_balance($userId);
        $master_chip = count_total_balance($masterId);

        $user_naration = '';
        $master_naration = '';
        if ($CrDr == 'DIYA') {
            $user_new_chip = $user_chip - $chips;
            $master_new_chip = $master_chip + $chips;
            $user_naration = 'Cash Received By Parent';
            $master_naration = 'Cash Paid to ' . $user_detail->user_name;

            if ($user_chip < $chips) {
                echo json_encode(array('success' => false, 'message' => 'Insufficient balance!!'));
                exit;
            }
        } else {

            if ($master_chip < $chips) {
                echo json_encode(array('success' => false, 'message' => 'Insufficient balance!!'));
                exit;
            }
            $user_new_chip = $user_chip + $chips;
            $master_new_chip = $master_chip - $chips;
            $master_naration = 'Cash Received By ' . $user_detail->user_name;
            $user_naration = 'Cash Paid to Parent';
        }


        $settlement_ref_id = rand(10, 100) . date('dmyhis');


        $dataArray = array(

            'settlemment_ref_id' => $settlement_ref_id,
            'user_id' => $userId,
            'remarks' => $user_naration,
            'transaction_type' => $CrDr == 'LIYA' ? 'debit' : 'credit',
            'amount' => $chips,
            'user_remarks' => $narration,

            'balance' =>  $user_new_chip,
            'type' =>  'Settlement',
            'role' => 'Parent',
            'user_name' => $user_detail->user_name,
            'done_by' => get_user_name()


        );

        $ledger_id  = $this->Ledger_model->addLedger($dataArray);


        $dataArray = array(
            'settlemment_ref_id' => $settlement_ref_id,

            'user_id' => $masterId,
            'remarks' => $master_naration,
            'user_remarks' => $narration,
            'transaction_type' => $CrDr == 'LIYA' ? 'credit' : 'debit',
            'amount' => $chips,
            'balance' =>  $master_new_chip,
            'type' =>  'Settlement',
            'user_name' => $user_detail->user_name,
            'done_by' => get_user_name()
        );

        $ledger_id  = $this->Ledger_model->addLedger($dataArray);


        $data = array(
            'user_id' => $userId,
            'is_balance_update' =>  'Yes',
            'is_exposure_update' =>  'Yes',
            'is_winnings_update' =>  'Yes',
        );
        $user_id = $this->User_model->addUser($data);



        $data = array(
            'user_id' => $masterId,
            'is_balance_update' =>  'Yes',
            'is_exposure_update' =>  'Yes',
            'is_winnings_update' =>  'Yes',
        );
        $user_id = $this->User_model->addUser($data);

        if ($CrDr == 'LIYA') {
            $user_details = $this->User_model->getUserById($userId);
            if (!empty($user_details)) {
                $balance = $user_details->balance  - $chips;
                $data = array(
                    'user_id' => $userId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }



            $master_details = $this->User_model->getUserById($masterId);
            if (!empty($master_details)) {
                $balance = $master_details->balance  + $chips;
                $data = array(
                    'user_id' => $masterId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }
        } else {

            $user_details = $this->User_model->getUserById($userId);
            if (!empty($user_details)) {
                $balance = $user_details->balance  + $chips;
                $data = array(
                    'user_id' => $userId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }



            $master_details = $this->User_model->getUserById($masterId);
            if (!empty($master_details)) {
                $balance = $master_details->balance  - $chips;
                $data = array(
                    'user_id' => $masterId,
                    'is_balance_update' =>  'Yes',
                    'is_exposure_update' =>  'Yes',
                    'is_winnings_update' =>  'Yes',
                );
                $user_id = $this->User_model->addUser($data);
            }
        }


        if ($ledger_id) {
            echo json_encode(array('success' => true));
        } else {
            echo json_encode(array('success' => false));
        }
    }

    public function txnclient()
    {
        $this->load->library('Datatable');

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $users = array();
        $user_type = get_user_type();
        $user_id  = get_user_id();
        //SUPER MASTERS

        if ($user_type == 'Master') {
            $usersData = $this->User_model->getInnerUserById($user_id);
            $users = array_merge($users, $usersData);
        } else if ($user_type == 'Super Master') {
            $masters = $this->User_model->getInnerUserById($user_id);

            if (!empty($masters)) {
                foreach ($masters as $master) {
                    $usersData = $this->User_model->getInnerUserById($master->user_id);

                    $users = array_merge($users, $usersData);
                }
            }
        } else if ($user_type == 'Hyper Super Master') {

            $supers = $this->User_model->getInnerUserById($user_id);

            if (!empty($supers)) {
                foreach ($supers as $super) {
                    $masters = $this->User_model->getInnerUserById($super->user_id);

                    if (!empty($masters)) {
                        foreach ($masters as $master) {
                            $usersData = $this->User_model->getInnerUserById($master->user_id);

                            $users = array_merge($users, $usersData);
                        }
                    }
                }
            }

            $dataArray['users'] = $users;
        } else if ($user_type == 'Admin') {
            $hypers = $this->User_model->getInnerUserById($user_id);

            if (!empty($hypers)) {
                foreach ($hypers as $hyper) {
                    $supers = $this->User_model->getInnerUserById($hyper->user_id);

                    if (!empty($supers)) {
                        foreach ($supers as $super) {
                            $masters = $this->User_model->getInnerUserById($super->user_id);

                            if (!empty($masters)) {
                                foreach ($masters as $master) {
                                    $usersData = $this->User_model->getInnerUserById($master->user_id);

                                    $users = array_merge($users, $usersData);
                                }
                            }
                        }
                    }
                }
            }
            $dataArray['users'] = $users;
        } else if ($user_type == 'Super Admin') {
            $admins = $this->User_model->getInnerUserById($user_id);

            if (!empty($admins)) {
                foreach ($admins as $admin) {
                    $hypers = $this->User_model->getInnerUserById($admin->user_id);

                    if (!empty($hypers)) {
                        foreach ($hypers as $hyper) {
                            $supers = $this->User_model->getInnerUserById($hyper->user_id);

                            if (!empty($supers)) {
                                foreach ($supers as $super) {
                                    $masters = $this->User_model->getInnerUserById($super->user_id);

                                    if (!empty($masters)) {
                                        foreach ($masters as $master) {
                                            $usersData = $this->User_model->getInnerUserById($master->user_id);

                                            $users = array_merge($users, $usersData);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            $dataArray['users'] = $users;
        }



        $dataArray['users'] = $users;



        // p($dataArray);
        $this->load->view('/txn-client', $dataArray);
    }

    public function txnagent()
    {
        $this->load->library('Datatable');

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $users = array();
        $user_type = get_user_type();
        $user_id  = get_user_id();
        //SUPER MASTERS

        if ($user_type == 'Super Master') {
            $users = $this->User_model->getInnerUserById($user_id);
            $dataArray['users'] = $users;
        } else if ($user_type == 'Hyper Super Master') {
            $supers = $this->User_model->getInnerUserById($user_id);

            if (!empty($supers)) {
                foreach ($supers as $super) {
                    $masters = $this->User_model->getInnerUserById($super->user_id);

                    $users = array_merge($users, $masters);
                }
            }
            $dataArray['users'] = $users;
        } else if ($user_type == 'Admin') {
            $hypers = $this->User_model->getInnerUserById($user_id);

            if (!empty($hypers)) {
                foreach ($hypers as $hyper) {
                    $supers = $this->User_model->getInnerUserById($hyper->user_id);

                    if (!empty($supers)) {
                        foreach ($supers as $super) {
                            $masters = $this->User_model->getInnerUserById($super->user_id);

                            $users = array_merge($users, $masters);
                        }
                    }
                }
            }
            $dataArray['users'] = $users;
        } else if ($user_type == 'Super Admin') {
            $admins = $this->User_model->getInnerUserById($user_id);

            if (!empty($admins)) {
                foreach ($admins as $admin) {
                    $hypers = $this->User_model->getInnerUserById($admin->user_id);

                    if (!empty($hypers)) {
                        foreach ($hypers as $hyper) {
                            $supers = $this->User_model->getInnerUserById($hyper->user_id);

                            if (!empty($supers)) {
                                foreach ($supers as $super) {
                                    $masters = $this->User_model->getInnerUserById($super->user_id);

                                    $users = array_merge($users, $masters);
                                }
                            }
                        }
                    }
                }
            }
            $dataArray['users'] = $users;
        }


        // p($dataArray);
        $this->load->view('/txn-client', $dataArray);
    }

    public function txnsuper()
    {
        $this->load->library('Datatable');

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $users = array();
        $user_type = get_user_type();
        $user_id  = get_user_id();
        if ($user_type == 'Hyper Super Master') {
            $users = $this->User_model->getInnerUserById($user_id);
            $dataArray['users'] = $users;
        } else if ($user_type == 'Admin') {
            $supers = $this->User_model->getInnerUserById($user_id);

            if (!empty($supers)) {
                foreach ($supers as $super) {
                    $masters = $this->User_model->getInnerUserById($super->user_id);

                    $users = array_merge($users, $masters);
                }
            }
            $dataArray['users'] = $users;
        } else if ($user_type == 'Super Admin') {
            $admins = $this->User_model->getInnerUserById($user_id);

            if (!empty($admins)) {
                foreach ($admins as $admin) {
                    $hypers = $this->User_model->getInnerUserById($admin->user_id);

                    if (!empty($hypers)) {
                        foreach ($hypers as $hyper) {
                            $supers = $this->User_model->getInnerUserById($hyper->user_id);

                            if (!empty($supers)) {
                                foreach ($supers as $super) {
                                    $supers = $this->User_model->getInnerUserById($hyper->user_id);
                                }
                            }
                            $users = array_merge($users, $supers);
                        }
                    }
                }
            }
            $dataArray['users'] = $users;
        }
        $this->load->view('/txn-client', $dataArray);
    }

    public function txnmaster()
    {
        $this->load->library('Datatable');

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $users = array();
        $user_type = get_user_type();
        $user_id  = get_user_id();
        //SUPER MASTERS

        if ($user_type == 'Admin') {
            $users = $this->User_model->getInnerUserById($user_id);
            $dataArray['users'] = $users;
        } else if ($user_type == 'Super Admin') {
            $admins = $this->User_model->getInnerUserById($user_id);

            if (!empty($admins)) {
                foreach ($admins as $admin) {
                    $hypers = $this->User_model->getInnerUserById($admin->user_id);

                    // if (!empty($hypers)) {
                    //     foreach ($hypers as $hyper) {
                    //         $supers = $this->User_model->getInnerUserById($hyper->user_id);

                    $users = array_merge($users, $hypers);
                    //     }
                    // }
                }
            }
            $dataArray['users'] = $users;
        }


        // p($dataArray);
        $this->load->view('/txn-client', $dataArray);
    }

    public function txnsba()
    {
        $this->load->library('Datatable');

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );

        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $users = array();
        $user_type = get_user_type();
        $user_id  = get_user_id();
        //SUPER MASTERS

        if ($user_type == 'Super Admin') {
            $users = $this->User_model->getInnerUserById($user_id);
            $dataArray['users'] = $users;
        }


        // p($dataArray);
        $this->load->view('/txn-client', $dataArray);
    }


    public function sportsdetails($sportid = null, $user_id = null)
    {


        $this->load->library('Datatable');
        if (!$user_id) {
            $user_id =  $_SESSION['my_userdata']['user_id'];
        }


        $dataArray['user_id']  = $user_id;
        $dataArray['sportid']  = $sportid;
        if ($sportid != 0) {
            $dataArray['sportid']  = 5;
        }
        $dataArray['toDate'] = date('Y-m-d');
        $dataArray['fromDate'] = date('Y-m-d');

        $search = '';
        $dataArray = array(
            'search_p_l' => $search,
            'user_id' => $user_id
        );

        if (!empty($fdate) && !empty($tdate)) {
            $dataArray['toDate'] = date('Y-m-d', strtotime($tdate));
            $dataArray['fromDate'] = date('Y-m-d', strtotime($fdate));
        }

        $dataArray['pstatus'] = 'Settled';


        $user_detail = $this->User_model->getUserById($user_id);
        $user_type = $user_detail->user_type;


        if ($user_type == 'Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );

                        $comm_pl = 0;
                        $sessional_commission = 2;

                        if ($betting_type == 'fancy') {
                            $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        }
                        $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );

                        $comm_pl = 0;
                        $sessional_commission = 2;

                        if ($betting_type == 'fancy') {
                            $tmp_comm_value =  abs($p_l) *  $sessional_commission / 100;
                        }
                        $comm_pl =  $reports[$report['match_id']]['comm_pl'] + $tmp_comm_value;
                        $reports[$report['match_id']]['comm_pl'] =  $comm_pl;
                    }
                }
            }
        } else if ($user_type == 'Super Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else if ($user_type == 'Hyper Super Master') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else if ($user_type == 'Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);

            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],
                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $result_name = '';


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],
                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }


            // p($reportsData);
        } else if ($user_type == 'Super Admin') {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);
            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        } else {
            $dataArray['pstatus'] = 'Settled';
            $reports = array();

            $reportsData = $this->Report_model->get_bet_history_bettings_list($dataArray);



            if (!empty($reportsData)) {
                foreach ($reportsData as $report) {
                    $marketId = $report['market_id'];
                    $betting_type = strtolower($report['betting_type']);


                    if (isset($reports[$report['match_id']])) {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }

                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l =  $reports[$report['match_id']]['p_l'] + $report['profit'];
                        } else if ($report['bet_result'] == 'Minus') {
                            $p_l = $reports[$report['match_id']]['p_l'] +  $report['loss'] * -1;
                        }


                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    } else {
                        if ($betting_type == 'fancy') {
                            $market_name = 'Fancy';
                        } else {
                            $market_name = $report['market_name'];
                        }


                        $p_l = 0;

                        if ($report['bet_result'] == 'Plus') {
                            $p_l = $report['profit'];
                        } else if ($report['bet_result'] == 'Minus') {
                            $p_l = $report['loss'] * -1;
                        }

                        $getCommssion = $this->Ledger_model->get_commission_amt_by_event_id(array(
                            'user_id' => $user_id,
                            'match_id' => $report['match_id']
                        ));



                        if (!empty($getCommssion)) {
                            $p_l += $getCommssion->total_commission;
                        }
                        // p($report);
                        $reports[$report['match_id']] = array(
                            'match_id' => $report['match_id'],
                            'event_name' => $report['event_name'],
                            'market_name' => $market_name,
                            'market_id' => $marketId,
                            'result_name' => $report['result_name'],

                            'p_l' => $p_l,
                            'commission' => 0,
                            'created_at' => $report['created_at']
                        );
                    }
                }
            }
        }


        $dataArray['user_id'] = $user_id;
        $dataArray['user_type'] = $user_type;
        array_multisort(array_map('strtotime', array_column($reports, 'created_at')), SORT_DESC, $reports);
        $dataArray['reports'] = $reports;

        $dataArray['local_css'] = array(
            'dataTables.bootstrap4',
            'responsive.bootstrap4'
        );


        $dataArray['local_js'] = array(
            'dataTables.min',
            'jquery.dataTables.bootstrap',
            'dataTables.fnFilterOnReturn',
            'dataTables.bootstrap4',
            'dataTables.responsive',
            'responsive.bootstrap4'
        );

        $dataArray['profit_loss']  = $this->load->viewPartial('/sports-details-list-html', $dataArray);
        $this->load->view('/sports-details', $dataArray);
    }


    public function agentMatchSessionPL($event_id)
    {
        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);
        $event =  $this->Event_model->get_event_by_event_id($event_id);



        if (!empty($user)) {
            if ($user->user_type == 'Master') {







                $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                    'user_id' => $user_id,
                    'match_id' => $event_id
                ));



                if (!empty($usersDatas)) {
                    foreach ($usersDatas as $key => $usersData) {



                        $usersDatas[$key]->master = array();
                        $usersDatas[$key]->super_master = array();
                        $usersDatas[$key]->hyper_super_master = array();
                        $usersDatas[$key]->admin = array();
                        $usersDatas[$key]->super_admin = array();

                        $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                        $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

                        $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                        $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);



                        $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);


                        $get_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);
                        $user_match_comm = 0;

                        if ($user_match_pl < 0) {
                            $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
                        }

                        $usersDatas[$key]->user = array(
                            'match_pl' => $user_match_pl * -1,
                            'session_pl' => $user_session_pl * -1,
                            'user_match_comm' => $event->event_type == 4 ?  $user_match_comm : 0,
                            'user_session_comm' => $event->event_type == 4 ?  $user_session_comm : 0,
                            'total_session_stake' => $total_session_stake
                        );

                        $usersDatas[$key]->master = array(
                            'partnership' => $get_master_partnership->partnership,
                            'match_comm' =>  $event->event_type == 4 ? $get_master_partnership->master_commission : 0,
                            'sessional_commission' =>  $event->event_type == 4 ?  $get_master_partnership->sessional_commission : 0,

                        );






                        $user->users =  $usersDatas;
                    }
                }
            }
        }

        $dataArray['reports'] = $user;
        $dataArray['event'] = $event;


        $this->load->view('/agent-match-session-pl', $dataArray);
    }

    public function masterMatchSessionPL($event_id)
    {
        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);
        $event =  $this->Event_model->get_event_by_event_id($event_id);


        if (!empty($user)) {
            if ($user->user_type == 'Super Master') {
                $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                    'user_id' => $user_id,
                    'match_id' => $event_id
                ));

                $user->masters = $mastersDatas;

                if (!empty($user->masters)) {
                    foreach ($user->masters as $masterKey => $master) {
                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $master->user_id,
                            'match_id' => $event_id
                        ));


                        if (!empty($usersDatas)) {
                            foreach ($usersDatas as $key => $usersData) {



                                $usersDatas[$key]->master = array();
                                $usersDatas[$key]->super_master = array();
                                $usersDatas[$key]->hyper_super_master = array();
                                $usersDatas[$key]->admin = array();
                                $usersDatas[$key]->super_admin = array();

                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


                                $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);
                                $get_super_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);




                                $user_match_comm = 0;

                                if ($user_match_pl < 0) {
                                    $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
                                }

                                $usersDatas[$key]->user = array(
                                    'match_pl' => $user_match_pl * -1,
                                    'session_pl' => $user_session_pl * -1,
                                    'user_match_comm' => $event->event_type == 4 ?  $user_match_comm : 0,
                                    'user_session_comm' => $event->event_type == 4 ?  $user_session_comm : 0,
                                );

                                $usersDatas[$key]->master = array(
                                    'partnership' => $get_master_partnership->partnership,
                                    'match_comm' =>  $event->event_type == 4 ?  $get_master_partnership->master_commission : 0,
                                    'sessional_commission' =>  $event->event_type == 4 ?  $get_master_partnership->sessional_commission: 0,
                                );


                                $usersDatas[$key]->super_master = array(
                                    'partnership' => $get_super_master_partnership->partnership,

                                );
                            }

                            $user->masters[$masterKey]->users = $usersDatas;
                        }
                    }
                }
            }
        }


        $dataArray['reports'] = $user;

        // p($usersDatas);
        $this->load->view('/master-match-session-pl', $dataArray);
    }

    public function superMatchSessionPL($event_id)
    {


        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);
        $event =  $this->Event_model->get_event_by_event_id($event_id);



        if (!empty($user)) {
            if ($user->user_type == 'Super Master') {



                $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                    'user_id' => $user_id,
                    'match_id' => $event_id
                ));

                $user->masters = $mastersDatas;

                if (!empty($user->masters)) {
                    $masters =  $user->masters;
                    foreach ($masters as $masterKey => $master) {




                        $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $master->user_id,
                            'match_id' => $event_id
                        ));



                        if (!empty($usersDatas)) {
                            foreach ($usersDatas as $key => $usersData) {



                                $usersDatas[$key]->master = array();
                                $usersDatas[$key]->super_master = array();
                                $usersDatas[$key]->hyper_super_master = array();
                                $usersDatas[$key]->admin = array();
                                $usersDatas[$key]->super_admin = array();

                                $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

                                $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);



                                $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);


                                $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);


                                $get_super_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);










                                $user_match_comm = 0;

                                if ($user_match_pl < 0) {
                                    $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
                                }

                                $usersDatas[$key]->user = array(
                                    'match_pl' => $user_match_pl * -1,
                                    'session_pl' => $user_session_pl * -1,
                                    'user_match_comm' => $event->event_type == 4 ?  $user_match_comm : 0,
                                    'user_session_comm' => $event->event_type == 4 ?  $user_session_comm : 0,
                                    'total_session_stake' => $total_session_stake
                                );

                                $usersDatas[$key]->master = array(
                                    'partnership' => $get_master_partnership->partnership,
                                    'match_comm' =>  $event->event_type == 4 ?  $get_master_partnership->master_commission : 0,
                                    'sessional_commission' =>  $event->event_type == 4 ?  $get_master_partnership->sessional_commission : 0,

                                );

                                $usersDatas[$key]->super_master = array(
                                    'partnership' => $get_super_master_partnership->partnership,
                                    'match_comm' =>  $event->event_type == 4 ?  $get_super_master_partnership->master_commission : 0,
                                    'sessional_commission' =>  $event->event_type == 4 ?  $get_super_master_partnership->sessional_commission : 0,

                                );





                                $user->masters[$masterKey]->users =  $usersDatas;
                            }
                        }
                    }
                }
            }
        }

        $dataArray['reports'] = $user;
        $dataArray['event'] = $event;

        // P($user);
        // P($user);
        // p($usersDatas);
        $this->load->view('/super-agent-match-session', $dataArray);
    }

    // public function superMatchSessionPL($event_id)
    // {
    //     $user_id = get_user_id();
    //     $user =  $this->User_model->getUserById($user_id);


    //     if (!empty($user)) {
    //         if ($user->user_type == 'Super Master') {
    //             $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                 'user_id' => $user_id,
    //                 'match_id' => $event_id
    //             ));

    //             $user->masters = $mastersDatas;

    //             if (!empty($user->masters)) {
    //                 foreach ($user->masters as $masterKey => $master) {
    //                     $usersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                         'user_id' => $master->user_id,
    //                         'match_id' => $event_id
    //                     ));


    //                     if (!empty($usersDatas)) {
    //                         foreach ($usersDatas as $key => $usersData) {



    //                             $usersDatas[$key]->master = array();
    //                             $usersDatas[$key]->super_master = array();
    //                             $usersDatas[$key]->hyper_super_master = array();
    //                             $usersDatas[$key]->admin = array();
    //                             $usersDatas[$key]->super_admin = array();

    //                             $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
    //                             $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

    //                             $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
    //                             $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


    //                             $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);
    //                             $get_super_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);



    //                             $user_match_comm = 0;

    //                             if ($user_match_pl < 0) {
    //                                 $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
    //                             }

    //                             $usersDatas[$key]->user = array(
    //                                 'match_pl' => $user_match_pl * -1,
    //                                 'session_pl' => $user_session_pl * -1,
    //                                 'user_match_comm' => $user_match_comm,
    //                                 'user_session_comm' => $user_session_comm,
    //                             );

    //                             $usersDatas[$key]->master = array(
    //                                 'partnership' => $get_master_partnership->partnership,
    //                                 'match_comm' =>  $get_master_partnership->master_commission,
    //                                 'sessional_commission' =>  $get_master_partnership->sessional_commission,

    //                             );

    //                             $usersDatas[$key]->super_master = array(
    //                                 'partnership' => $get_super_master_partnership->partnership,
    //                                 'match_comm' =>  $get_super_master_partnership->master_commission,
    //                                 'sessional_commission' =>  $get_super_master_partnership->sessional_commission,
    //                             );
    //                         }

    //                         $user->masters[$masterKey]->users = $usersDatas;
    //                     }
    //                 }
    //             }
    //         }
    //     }


    //     $dataArray['reports'] = $user;

    //     // p($usersDatas);
    //     $this->load->view('/master-match-session-pl', $dataArray);
    // }


    // public function masterMatchSessionPL($event_id)
    // {
    //     $user_id = get_user_id();
    //     $user =  $this->User_model->getUserById($user_id);


    //     if (!empty($user)) {
    //         if ($user->user_type == 'Super Master') {

    //             $mastersDatas =  $this->User_model->getInnerUserById(
    //                 $user_id
    //                 // 'match_id' => $event_id
    //             );

    //              $user->masters = $mastersDatas;


    //             if (!empty($user->masters)) {
    //                 foreach ($user->masters as $masterKey => $master) {

    //                     $checkBetExists = $this->Betting_model->check_user_bet_exists(array(
    //                         'user_id' => $master->user_id,
    //                         'match_id' => $event_id,
    //                     ));


    //                     if(isset($checkBetExists->total_bets))
    //                     {




    //                     // $usersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                     //     'user_id' => $master->user_id,
    //                     //     'match_id' => $event_id
    //                     // ));

    //                     $usersDatas =  $this->User_model->getInnerUserById(
    //                         $master->user_id
    //                         // 'match_id' => $event_id
    //                     );



    //                     if (!empty($usersDatas)) {
    //                         foreach ($usersDatas as $key => $usersData) {


    //                             $checkBetExists = $this->Betting_model->check_user_bet_exists(array(
    //                                 'user_id' => $master->user_id,
    //                                 'match_id' => $event_id,
    //                             ));


    //                             if(isset($checkBetExists->total_bets))
    //                             {
    //                             $usersDatas[$key]->master = array();
    //                             $usersDatas[$key]->super_master = array();
    //                             $usersDatas[$key]->hyper_super_master = array();
    //                             $usersDatas[$key]->admin = array();
    //                             $usersDatas[$key]->super_admin = array();

    //                             $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
    //                             $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

    //                             $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
    //                             $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


    //                             $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);
    //                             $get_super_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);

    //                             $user_match_comm = 0;

    //                             if ($user_match_pl < 0) {
    //                                 $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
    //                             }

    //                             $usersDatas[$key]->user = array(
    //                                 'match_pl' => $user_match_pl * -1,
    //                                 'session_pl' => $user_session_pl * -1,
    //                                 'user_match_comm' => $user_match_comm,
    //                                 'user_session_comm' => $user_session_comm,
    //                             );

    //                             $usersDatas[$key]->master = array(
    //                                 'partnership' => $get_master_partnership->partnership,

    //                             );
    //                         }
    //                         }

    //                         $user->masters[$masterKey]->users = $usersDatas;
    //                     }
    //                 }
    //                 }
    //             }
    //         }
    //     }


    //     $dataArray['reports'] = $user;

    //     // p($usersDatas);
    //     $this->load->view('/master-match-session-pl', $dataArray);
    // }


    public function deleteSettlementEntry()
    {

        $ref_id = $this->input->post('ref_id');



        if (!empty($ref_id)) {

            $settlementData = $this->Ledger_model->getSettlementEntry($ref_id);

            $this->Ledger_model->deleteSettlementEntry($ref_id);


            if (!empty($settlementData)) {

                foreach ($settlementData as $data) {
                    $data = array(
                        'user_id' => $data['user_id'],
                        'is_balance_update' =>  'Yes',
                        'is_exposure_update' =>  'Yes',
                        'is_winnings_update' =>  'Yes',
                    );
                    $user_id = $this->User_model->addUser($data);
                }
            }



            echo json_encode(array('success' => true, 'message' => 'Success'));
            exit;
        } else {
            echo json_encode(array('success' => false, 'message' => 'Something went wrong'));
            exit;
        }
    }

    public function subAdminMatchSessionPL($event_id)
    {


        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);
        $event =  $this->Event_model->get_event_by_event_id($event_id);



        if (!empty($user)) {
            if ($user->user_type == 'Admin') {

                $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
                    'user_id' => $user_id,
                    'match_id' => $event_id
                ));

                $user->hypers = $hypersDatas;




                if (!empty($user->hypers)) {
                    foreach ($user->hypers as $hyperKey => $hyper) {

                        $superDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $hyper->user_id,
                            'match_id' => $event_id
                        ));


                        if (!empty($superDatas)) {
                            $user->hypers[$hyperKey]->supers = $superDatas;


                            if (!empty($user->hypers[$hyperKey]->supers)) {
                                $supers  = $user->hypers[$hyperKey]->supers;

                                foreach ($supers as $superKey => $super) {


                                    $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $super->user_id,
                                        'match_id' => $event_id
                                    ));

                                    $user->hypers[$hyperKey]->supers[$superKey]->masters = $mastersDatas;

                                    if (!empty($user->hypers[$hyperKey]->supers[$superKey]->masters)) {
                                        $masters =  $user->hypers[$hyperKey]->supers[$superKey]->masters;
                                        foreach ($masters as $masterKey => $master) {




                                            $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                'user_id' => $master->user_id,
                                                'match_id' => $event_id
                                            ));



                                            if (!empty($usersDatas)) {
                                                foreach ($usersDatas as $key => $usersData) {



                                                    $usersDatas[$key]->master = array();
                                                    $usersDatas[$key]->super_master = array();
                                                    $usersDatas[$key]->hyper_super_master = array();
                                                    $usersDatas[$key]->admin = array();
                                                    $usersDatas[$key]->super_admin = array();

                                                    $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                    $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

                                                    $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                    $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);



                                                    $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);

                                                    $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);


                                                    $get_super_master_partnership = $this->Betting_model->get_betting_info($super->user_id, $event_id);


                                                    $get_hyper_super_master_partnership = $this->Betting_model->get_betting_info($hyper->user_id, $event_id);


                                                    $get_admin_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);





                                                    $user_match_comm = 0;

                                                    if ($user_match_pl < 0) {
                                                        $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
                                                    }

                                                    $usersDatas[$key]->user = array(
                                                        'match_pl' => $user_match_pl * -1,
                                                        'session_pl' => $user_session_pl * -1,
                                                        'user_match_comm' => $event->event_type == 4 ?  $user_match_comm : 0,
                                                        'user_session_comm' => $event->event_type == 4 ?  $user_session_comm : 0,
                                                        'total_session_stake' => $total_session_stake
                                                    );

                                                    $usersDatas[$key]->master = array(
                                                        'partnership' => $get_master_partnership->partnership,
                                                        'match_comm' =>  $event->event_type == 4 ?  $get_master_partnership->master_commission : 0,
                                                        'sessional_commission' =>  $event->event_type == 4 ?  $get_master_partnership->sessional_commission : 0,

                                                    );

                                                    $usersDatas[$key]->super_master = array(
                                                        'partnership' => $get_super_master_partnership->partnership,
                                                        'match_comm' =>  $event->event_type == 4 ?  $get_super_master_partnership->master_commission : 0,
                                                        'sessional_commission' =>  $event->event_type == 4 ?  $get_super_master_partnership->sessional_commission : 0,

                                                    );



                                                    $usersDatas[$key]->hyper_super_master = array(
                                                        'partnership' => $get_hyper_super_master_partnership->partnership,
                                                        'match_comm' =>  $event->event_type == 4 ?  $get_hyper_super_master_partnership->master_commission : 0,
                                                        'sessional_commission' =>  $event->event_type == 4 ?  $get_hyper_super_master_partnership->sessional_commission : 0,


                                                    );

                                                    $usersDatas[$key]->admin = array(
                                                        'partnership' => $get_admin_partnership->partnership,
                                                        'match_comm' =>  $event->event_type == 4 ? $get_admin_partnership->master_commission : 0,
                                                        'sessional_commission' =>  $event->event_type == 4 ?  $get_admin_partnership->sessional_commission : 0,

                                                    );
                                                }
                                                $user->hypers[$hyperKey]->supers[$superKey]->masters[$masterKey]->users =  $usersDatas;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }



        $dataArray['reports'] = $user;
        $dataArray['event'] = $event;

        // P($user);
        // P($user);
        // p($usersDatas);
        $this->load->view('/sub-admin-match-session-pl', $dataArray);
    }

    // public function subAdminMatchSessionPL($event_id)
    // {


    //     $user_id = get_user_id();
    //     $user =  $this->User_model->getUserById($user_id);
    //     $event =  $this->Event_model->get_event_by_event_id($event_id);



    //     if (!empty($user)) {
    //         if ($user->user_type == 'Admin') {

    //             $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                 'user_id' => $user_id,
    //                 'match_id' => $event_id
    //             ));

    //             $user->hypers = $hypersDatas;




    //             if (!empty($user->hypers)) {
    //                 foreach ($user->hypers as $hyperKey => $hyper) {

    //                     $superDatas =  $this->User_model->getInnerUserByEventId(array(
    //                         'user_id' => $hyper->user_id,
    //                         'match_id' => $event_id
    //                     ));


    //                     if (!empty($superDatas)) {
    //                         $user->hypers[$hyperKey]->supers = $superDatas;


    //                         if (!empty($user->hypers[$hyperKey]->supers)) {
    //                             $supers  = $user->hypers[$hyperKey]->supers;

    //                             foreach ($supers as $superKey => $super) {


    //                                 $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                                     'user_id' => $super->user_id,
    //                                     'match_id' => $event_id
    //                                 ));

    //                                 $user->hypers[$hyperKey]->supers[$superKey]->masters = $mastersDatas;

    //                                 if (!empty($user->hypers[$hyperKey]->supers[$superKey]->masters)) {
    //                                     $masters =  $user->hypers[$hyperKey]->supers[$superKey]->masters;
    //                                     foreach ($masters as $masterKey => $master) {




    //                                         $usersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                                             'user_id' => $master->user_id,
    //                                             'match_id' => $event_id
    //                                         ));



    //                                         if (!empty($usersDatas)) {
    //                                             foreach ($usersDatas as $key => $usersData) {



    //                                                 $usersDatas[$key]->master = array();
    //                                                 $usersDatas[$key]->super_master = array();
    //                                                 $usersDatas[$key]->hyper_super_master = array();
    //                                                 $usersDatas[$key]->admin = array();
    //                                                 $usersDatas[$key]->super_admin = array();

    //                                                 $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
    //                                                 $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);
    //                                                  $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
    //                                                 $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


    //                                                 $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);

    //                                                 $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);


    //                                                 $get_super_master_partnership = $this->Betting_model->get_betting_info($super->user_id, $event_id);


    //                                                 $get_hyper_super_master_partnership = $this->Betting_model->get_betting_info($hyper->user_id, $event_id);


    //                                                 $get_admin_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);





    //                                                 $user_match_comm = 0;

    //                                                 if ($user_match_pl < 0) {
    //                                                     $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
    //                                                 }

    //                                                 $usersDatas[$key]->user = array(
    //                                                     'match_pl' => $user_match_pl * -1,
    //                                                     'session_pl' => $user_session_pl * -1,
    //                                                     'user_match_comm' => $user_match_comm,
    //                                                     'user_session_comm' => $user_session_comm,
    //                                                     'total_session_stake' => $total_session_stake,
    //                                                 );

    //                                                 $usersDatas[$key]->master = array(
    //                                                     'partnership' => $get_master_partnership->partnership,

    //                                                 );

    //                                                 $usersDatas[$key]->super_master = array(
    //                                                     'partnership' => $get_super_master_partnership->partnership,

    //                                                 );

    //                                                 $usersDatas[$key]->hyper_super_master = array(
    //                                                     'partnership' => $get_hyper_super_master_partnership->partnership,

    //                                                 );


    //                                                 $usersDatas[$key]->admin = array(
    //                                                     'partnership' => $get_admin_partnership->partnership,

    //                                                 );
    //                                             }

    //                                             $user->hypers[$hyperKey]->supers[$superKey]->masters[$masterKey]->users =  $usersDatas;
    //                                         }
    //                                     }
    //                                 }
    //                             }
    //                         }
    //                     }
    //                 }
    //             }
    //         }
    //     }



    //     $dataArray['reports'] = $user;
    //     $dataArray['event'] = $event;

    //     // P($user);
    //     // P($user);
    //     // p($usersDatas);
    //     $this->load->view('/sub-admin-match-session-pl', $dataArray);
    // }

    public function masterAgentMatchSessionPL($event_id)
    {


        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);
        $event =  $this->Event_model->get_event_by_event_id($event_id);



        if (!empty($user)) {
            if ($user->user_type == 'Hyper Super Master') {



                $superDatas =  $this->User_model->getInnerUserByEventId(array(
                    'user_id' => $user_id,
                    'match_id' => $event_id
                ));


                if (!empty($superDatas)) {
                    $user->supers = $superDatas;


                    if (!empty($user->supers)) {
                        $supers  = $user->supers;

                        foreach ($supers as $superKey => $super) {


                            $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                'user_id' => $super->user_id,
                                'match_id' => $event_id
                            ));

                            $user->supers[$superKey]->masters = $mastersDatas;

                            if (!empty($user->supers[$superKey]->masters)) {
                                $masters =  $user->supers[$superKey]->masters;
                                foreach ($masters as $masterKey => $master) {




                                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                        'user_id' => $master->user_id,
                                        'match_id' => $event_id
                                    ));



                                    if (!empty($usersDatas)) {
                                        foreach ($usersDatas as $key => $usersData) {



                                            $usersDatas[$key]->master = array();
                                            $usersDatas[$key]->super_master = array();
                                            $usersDatas[$key]->hyper_super_master = array();
                                            $usersDatas[$key]->admin = array();
                                            $usersDatas[$key]->super_admin = array();

                                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

                                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);



                                            $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);


                                            $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);


                                            $get_super_master_partnership = $this->Betting_model->get_betting_info($super->user_id, $event_id);


                                            $get_hyper_super_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);








                                            $user_match_comm = 0;

                                            if ($user_match_pl < 0) {
                                                $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
                                            }

                                            $usersDatas[$key]->user = array(
                                                'match_pl' => $user_match_pl * -1,
                                                'session_pl' => $user_session_pl * -1,
                                                'user_match_comm' => $event->event_type == 4 ? $user_match_comm : 0,
                                                'user_session_comm' => $event->event_type == 4 ?  $user_session_comm : 0,
                                                'total_session_stake' => $total_session_stake
                                            );

                                            $usersDatas[$key]->master = array(
                                                'partnership' => $get_master_partnership->partnership,
                                                'match_comm' =>  $event->event_type == 4 ?  $get_master_partnership->master_commission : 0,
                                                'sessional_commission' =>  $event->event_type == 4 ?  $get_master_partnership->sessional_commission : 0,

                                            );

                                            $usersDatas[$key]->super_master = array(
                                                'partnership' => $get_super_master_partnership->partnership,
                                                'match_comm' =>  $event->event_type == 4 ?  $get_super_master_partnership->master_commission : 0,
                                                'sessional_commission' =>  $event->event_type == 4 ?  $get_super_master_partnership->sessional_commission : 0,

                                            );



                                            $usersDatas[$key]->hyper_super_master = array(
                                                'partnership' => $get_hyper_super_master_partnership->partnership,
                                                'match_comm' =>  $event->event_type == 4 ?  $get_hyper_super_master_partnership->master_commission : 0,
                                                'sessional_commission' =>  $event->event_type == 4 ?  $get_hyper_super_master_partnership->sessional_commission : 0,


                                            );


                                            $user->supers[$superKey]->masters[$masterKey]->users =  $usersDatas;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        $dataArray['reports'] = $user;
        $dataArray['event'] = $event;

        // P($user);
        // P($user);
        // p($usersDatas);
        $this->load->view('/master-agent-match-session-pl', $dataArray);
    }
    // public function masterAgentMatchSessionPL($event_id)
    // {


    //     $user_id = get_user_id();
    //     $user =  $this->User_model->getUserById($user_id);
    //     $event =  $this->Event_model->get_event_by_event_id($event_id);



    //     if (!empty($user)) {
    //         if ($user->user_type == 'Hyper Super Master') {



    //             $superDatas =  $this->User_model->getInnerUserByEventId(array(
    //                 'user_id' => $user_id,
    //                 'match_id' => $event_id
    //             ));



    //             if (!empty($superDatas)) {
    //                 $user->supers = $superDatas;


    //                 if (!empty($user->supers)) {
    //                     $supers  = $user->supers;

    //                     foreach ($supers as $superKey => $super) {


    //                         $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                             'user_id' => $super->user_id,
    //                             'match_id' => $event_id
    //                         ));

    //                         $user->supers[$superKey]->masters = $mastersDatas;

    //                         if (!empty($user->supers[$superKey]->masters)) {
    //                             $masters =  $user->supers[$superKey]->masters;
    //                             foreach ($masters as $masterKey => $master) {




    //                                 $usersDatas =  $this->User_model->getInnerUserByEventId(array(
    //                                     'user_id' => $master->user_id,
    //                                     'match_id' => $event_id
    //                                 ));



    //                                 if (!empty($usersDatas)) {
    //                                     foreach ($usersDatas as $key => $usersData) {



    //                                         $usersDatas[$key]->master = array();
    //                                         $usersDatas[$key]->super_master = array();
    //                                         $usersDatas[$key]->hyper_super_master = array();
    //                                         $usersDatas[$key]->admin = array();
    //                                         $usersDatas[$key]->super_admin = array();

    //                                         $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
    //                                         $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

    //                                         $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
    //                                         $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


    //                                         $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);


    //                                         $get_super_master_partnership = $this->Betting_model->get_betting_info($super->user_id, $event_id);


    //                                         $get_hyper_super_master_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);


    //                                         $get_admin_partnership = $this->Betting_model->get_betting_info($user_id, $event_id);




    //                                         $user_match_comm = 0;

    //                                         if ($user_match_pl < 0) {
    //                                             $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
    //                                         }

    //                                         $usersDatas[$key]->user = array(
    //                                             'match_pl' => $user_match_pl * -1,
    //                                             'session_pl' => $user_session_pl * -1,
    //                                             'user_match_comm' => $user_match_comm,
    //                                             'user_session_comm' => $user_session_comm,
    //                                         );

    //                                         $usersDatas[$key]->master = array(
    //                                             'partnership' => $get_master_partnership->partnership,

    //                                         );

    //                                         $usersDatas[$key]->super_master = array(
    //                                             'partnership' => $get_super_master_partnership->partnership,

    //                                         );

    //                                         $usersDatas[$key]->hyper_super_master = array(
    //                                             'partnership' => $get_hyper_super_master_partnership->partnership,

    //                                         );
    //                                     }
    //                                     $user->supers[$superKey]->masters[$masterKey]->users =  $usersDatas;
    //                                 }
    //                             }
    //                         }
    //                     }
    //                 }
    //             }
    //         }
    //     }


    //     $dataArray['reports'] = $user;
    //     $dataArray['event'] = $event;

    //     // P($user);
    //     // P($user);
    //     // p($usersDatas);
    //     $this->load->view('/master-agent-match-session-pl', $dataArray);
    // }


    public function adminMatchSessionPL($event_id)
    {


        $user_id = get_user_id();
        $user =  $this->User_model->getUserById($user_id);
        $event =  $this->Event_model->get_event_by_event_id($event_id);



        // p($event);

        

        if (!empty($user)) {
            if ($user->user_type == 'Super Admin') {

                $adminsDatas =  $this->User_model->getInnerUserByEventId(array(
                    'user_id' => $user_id,
                    'match_id' => $event_id
                ));


                if (!empty($adminsDatas)) {

                    $user->admins = $adminsDatas;
                    foreach ($user->admins as $adminKey => $admin) {
                        $hypersDatas =  $this->User_model->getInnerUserByEventId(array(
                            'user_id' => $admin->user_id,
                            'match_id' => $event_id
                        ));

                        $user->admins[$adminKey]->hypers = $hypersDatas;




                        if (!empty($user->admins[$adminKey]->hypers)) {
                            foreach ($user->admins[$adminKey]->hypers as $hyperKey => $hyper) {

                                $superDatas =  $this->User_model->getInnerUserByEventId(array(
                                    'user_id' => $hyper->user_id,
                                    'match_id' => $event_id
                                ));


                                if (!empty($superDatas)) {
                                    $user->admins[$adminKey]->hypers[$hyperKey]->supers = $superDatas;


                                    if (!empty($user->admins[$adminKey]->hypers[$hyperKey]->supers)) {
                                        $supers  = $user->admins[$adminKey]->hypers[$hyperKey]->supers;

                                        foreach ($supers as $superKey => $super) {


                                            $mastersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                'user_id' => $super->user_id,
                                                'match_id' => $event_id
                                            ));

                                            $user->admins[$adminKey]->hypers[$hyperKey]->supers[$superKey]->masters = $mastersDatas;

                                            if (!empty($user->admins[$adminKey]->hypers[$hyperKey]->supers[$superKey]->masters)) {
                                                $masters =  $user->admins[$adminKey]->hypers[$hyperKey]->supers[$superKey]->masters;
                                                foreach ($masters as $masterKey => $master) {




                                                    $usersDatas =  $this->User_model->getInnerUserByEventId(array(
                                                        'user_id' => $master->user_id,
                                                        'match_id' => $event_id
                                                    ));



                                                    if (!empty($usersDatas)) {
                                                        foreach ($usersDatas as $key => $usersData) {



                                                            $usersDatas[$key]->master = array();
                                                            $usersDatas[$key]->super_master = array();
                                                            $usersDatas[$key]->hyper_super_master = array();
                                                            $usersDatas[$key]->admin = array();
                                                            $usersDatas[$key]->super_admin = array();

                                                            $user_match_pl = $this->Betting_model->count_total_match_profit_loss($usersData->user_id, $event_id);
                                                            $user_session_pl = $this->Betting_model->count_total_session_profit_loss($usersData->user_id, $event_id);

                                                            $user_session_comm = $this->Betting_model->count_total_session_comm($usersData->user_id, $event_id);
                                                            $get_match_comm = $this->Betting_model->count_total_match_comm($usersData->user_id, $event_id);


                                                            $total_session_stake = $this->Betting_model->count_total_session_stake($usersData->user_id, $event_id);


                                                            $get_master_partnership = $this->Betting_model->get_betting_info($master->user_id, $event_id);


                                                            $get_super_master_partnership = $this->Betting_model->get_betting_info($super->user_id, $event_id);


                                                            $get_hyper_super_master_partnership = $this->Betting_model->get_betting_info($hyper->user_id, $event_id);


                                                            $get_admin_partnership = $this->Betting_model->get_betting_info($admin->user_id, $event_id);




                                                            $user_match_comm = 0;

                                                            if ($user_match_pl < 0) {
                                                                $user_match_comm = abs($user_match_pl) * $get_match_comm->master_commission / 100;
                                                            }

                                                            $usersDatas[$key]->user = array(
                                                                'match_pl' => $user_match_pl * -1,
                                                                'session_pl' => $user_session_pl * -1,
                                                                'user_match_comm' => $event->event_type == 4 ?  $user_match_comm : 0,
                                                                'user_session_comm' => $event->event_type == 4 ? $user_session_comm : 0,
                                                                'total_session_stake' => $total_session_stake
                                                            );

                                                            $usersDatas[$key]->master = array(
                                                                'partnership' => $get_master_partnership->partnership,
                                                                'match_comm' =>  $event->event_type == 4 ? $get_master_partnership->master_commission : 0,
                                                                'sessional_commission' =>  $event->event_type == 4 ?  $get_master_partnership->sessional_commission : 0,

                                                            );

                                                            $usersDatas[$key]->super_master = array(
                                                                'partnership' => $get_super_master_partnership->partnership,
                                                                'match_comm' =>  $event->event_type == 4 ? $get_super_master_partnership->master_commission : 0,
                                                                'sessional_commission' =>  $event->event_type == 4 ? $get_super_master_partnership->sessional_commission : 0,

                                                            );



                                                            $usersDatas[$key]->hyper_super_master = array(
                                                                'partnership' => $get_hyper_super_master_partnership->partnership,
                                                                'match_comm' =>  $event->event_type == 4 ?  $get_hyper_super_master_partnership->master_commission : 0,
                                                                'sessional_commission' =>  $event->event_type == 4 ?  $get_hyper_super_master_partnership->sessional_commission : 0,


                                                            );

                                                            $usersDatas[$key]->admin = array(
                                                                'partnership' => $get_admin_partnership->partnership,
                                                                'match_comm' =>  $event->event_type == 4 ?  $get_admin_partnership->master_commission : 0,
                                                                'sessional_commission' =>  $event->event_type == 4 ?  $get_admin_partnership->sessional_commission : 0,

                                                            );
                                                        }
                                                        $user->admins[$adminKey]->hypers[$hyperKey]->supers[$superKey]->masters[$masterKey]->users =  $usersDatas;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }



 
        $dataArray['reports'] = $user;
        $dataArray['event'] = $event;

        // P($user);
        // P($user);
        // p($usersDatas);
        $this->load->view('/admin-match-session-pl', $dataArray);
    }
}
